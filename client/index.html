
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFGlory Panel</title>
    <script src="https://cdn.tailwindcss.com/3.4.17">




/* ===== CLEAN AUTH HANDLER ===== */
const loginForm = document.getElementById("login-form");
const signupForm = document.getElementById("signup-form");

async function loginHandler(e){
  e.preventDefault();

  const username = document.getElementById("login-username").value.trim();
  const password = document.getElementById("login-password").value.trim();

  if(!username || !password){
    alert("Username / password missing");
    return;
  }

  const res = await fetch(API.login, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, password })
  });

  const data = await res.json();
  if(!res.ok){ alert(data.message || "Invalid password"); return; }

  localStorage.setItem("token", data.token);

  const meRes = await fetch(API.me, {
    headers: { Authorization: "Bearer " + data.token }
  });

  const meData = await meRes.json();
  currentUser = meData.user;

  showDashboard();
}

async function signupHandler(e){
  e.preventDefault();
  alert("Signup disabled on backend (demo mode)");
}

loginForm.addEventListener("submit", loginHandler);
document.getElementById("login-btn").addEventListener("click", loginHandler);
signupForm.addEventListener("submit", signupHandler);
/* ===== CLEAN AUTH HANDLER END ===== */

</script>
    <!-- Only load Turnstile on production (non-localhost) -->
    <script>
        if (!window.location.hostname.includes('localhost') && !window.location.hostname.includes('127.0.0.1')) {
            var script = document.createElement('script');
            script.src = 'https://challenges.cloudflare.com/turnstile/v0/api.js';
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }
    </script>
    <!-- Angular.dev Typography: Inter for body, Outfit for headings -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700;800&family=Roboto+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        /* === GAMING "CYBER DARK" THEME === */
        :root {
            /* Ultra Dark Gaming Colors */
            --ng-bg-deep: #000000;
            --ng-bg-surface: #050508;
            --ng-bg-elevated: #0a0a0f;
            --ng-bg-card: rgba(8, 8, 15, 0.85);

            /* Gaming Neon - Red/Orange Fire */
            --ng-red: #ff2d55;
            --ng-pink: #ff0844;
            --ng-pink-light: #ff6b9d;
            --ng-orange: #ff6a00;
            --ng-gradient-brand: linear-gradient(135deg, #ff0844 0%, #ff2d55 50%, #ff6a00 100%);

            /* Accent colors - Neon Gaming */
            --ng-purple: #bf00ff;
            --ng-blue: #00d4ff;
            --ng-cyan: #00ffff;
            --ng-green: #00ff88;

            /* Borders - neon glow hints */
            --ng-border: rgba(255, 45, 85, 0.15);
            --ng-border-hover: rgba(255, 45, 85, 0.35);

            /* Text */
            --ng-text: #ffffff;
            --ng-text-muted: #8a8a9a;
            --ng-text-subtle: #5a5a6a;

            /* Gaming Gradients */
            --ng-gradient-pink: linear-gradient(135deg, #ff0844 0%, #ff2d55 100%);
            --ng-gradient-purple: linear-gradient(135deg, #bf00ff 0%, #7928ca 100%);
            --ng-gradient-fire: linear-gradient(135deg, #ff0844 0%, #ff6a00 100%);

            /* Intense Glow effects */
            --ng-glow-pink: 0 0 100px rgba(255, 8, 68, 0.5);
            --ng-glow-purple: 0 0 100px rgba(191, 0, 255, 0.4);
            --ng-glow-cyan: 0 0 80px rgba(0, 255, 255, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #000000;
            color: var(--ng-text);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 400;
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Outfit for headings with tight letter-spacing */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        .heading {
            font-family: 'Outfit', sans-serif;
            letter-spacing: -0.02em;
            font-weight: 600;
        }

        /* === GAMING BACKGROUND SYSTEM === */

        /* Noise texture for gritty gaming feel */
        .ng-noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            pointer-events: none;
            opacity: 0.06;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        }

        /* Pure black base with neon mesh */
        .ng-bg-gradient {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000000;
            z-index: -4;
            overflow: hidden;
        }

        /* Gaming neon gradient layer */
        .ng-bg-gradient::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background:
                /* Primary red/orange fire glow - top */
                radial-gradient(ellipse 90% 60% at 50% 10%, rgba(255, 8, 68, 0.25) 0%, transparent 50%),
                /* Intense purple orb - bottom right */
                radial-gradient(ellipse 70% 70% at 90% 80%, rgba(191, 0, 255, 0.2) 0%, transparent 45%),
                /* Cyan accent - left side */
                radial-gradient(ellipse 60% 50% at 10% 60%, rgba(0, 212, 255, 0.15) 0%, transparent 40%),
                /* Electric green highlight - top right corner */
                radial-gradient(ellipse 50% 40% at 85% 5%, rgba(0, 255, 136, 0.1) 0%, transparent 35%),
                /* Deep magenta - center bottom */
                radial-gradient(ellipse 80% 50% at 50% 95%, rgba(255, 8, 68, 0.18) 0%, transparent 45%);
            animation: gamingGradientMove 20s ease-in-out infinite;
            mix-blend-mode: screen;
        }

        /* Intense center glow with pulsing effect */
        .ng-bg-gradient::after {
            content: '';
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            width: 1000px;
            height: 1000px;
            background:
                radial-gradient(circle at 50% 50%, rgba(255, 8, 68, 0.2) 0%, transparent 35%),
                radial-gradient(circle at 40% 60%, rgba(191, 0, 255, 0.1) 0%, transparent 45%),
                radial-gradient(circle at 60% 40%, rgba(0, 212, 255, 0.08) 0%, transparent 50%);
            filter: blur(100px);
            pointer-events: none;
            animation: gamingGlowPulse 6s ease-in-out infinite;
        }

        @keyframes gamingGradientMove {

            0%,
            100% {
                transform: translate(0, 0) scale(1) rotate(0deg);
            }

            25% {
                transform: translate(2%, 1%) scale(1.02) rotate(0.5deg);
            }

            50% {
                transform: translate(-1%, 2%) scale(1.03) rotate(-0.3deg);
            }

            75% {
                transform: translate(-2%, -1%) scale(1.01) rotate(0.2deg);
            }
        }

        @keyframes gamingGlowPulse {

            0%,
            100% {
                opacity: 1;
                transform: translateX(-50%) scale(1);
            }

            50% {
                opacity: 0.6;
                transform: translateX(-50%) scale(1.15);
            }
        }

        /* Energy waves - gaming aurora */
        .ng-aurora-waves {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -3;
            pointer-events: none;
            overflow: hidden;
        }

        /* First wave - fire energy */
        .ng-aurora-waves::before {
            content: '';
            position: absolute;
            top: -100%;
            left: -50%;
            width: 200%;
            height: 200%;
            background:
                conic-gradient(from 180deg at 50% 50%,
                    transparent 0deg,
                    rgba(255, 8, 68, 0.06) 45deg,
                    transparent 90deg,
                    rgba(191, 0, 255, 0.05) 150deg,
                    transparent 200deg,
                    rgba(0, 212, 255, 0.04) 280deg,
                    transparent 360deg);
            animation: gamingWaveRotate 45s linear infinite;
            filter: blur(50px);
        }

        /* Second wave - electric */
        .ng-aurora-waves::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -100%;
            width: 300%;
            height: 200%;
            background:
                conic-gradient(from 270deg at 40% 60%,
                    transparent 0deg,
                    rgba(0, 255, 136, 0.03) 60deg,
                    transparent 120deg,
                    rgba(255, 106, 0, 0.04) 200deg,
                    transparent 280deg,
                    rgba(191, 0, 255, 0.03) 340deg,
                    transparent 360deg);
            animation: gamingWaveRotate 70s linear infinite reverse;
            filter: blur(70px);
        }

        @keyframes gamingWaveRotate {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Gaming orbs - particle effects */
        .ng-floating-orbs {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -2;
            pointer-events: none;
            overflow: hidden;
        }

        .ng-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.7;
            animation: gamingOrbFloat 15s ease-in-out infinite;
        }

        .ng-orb-1 {
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(255, 8, 68, 0.25) 0%, transparent 60%);
            top: 5%;
            left: 15%;
            animation-delay: 0s;
        }

        .ng-orb-2 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(191, 0, 255, 0.2) 0%, transparent 60%);
            top: 55%;
            right: 10%;
            animation-delay: -5s;
        }

        .ng-orb-3 {
            width: 350px;
            height: 350px;
            background: radial-gradient(circle, rgba(0, 212, 255, 0.18) 0%, transparent 60%);
            bottom: 15%;
            left: 5%;
            animation-delay: -10s;
        }

        @keyframes gamingOrbFloat {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
            }

            20% {
                transform: translate(40px, -30px) scale(1.1);
            }

            40% {
                transform: translate(-30px, 40px) scale(0.9);
            }

            60% {
                transform: translate(-50px, -20px) scale(1.05);
            }

            80% {
                transform: translate(30px, 30px) scale(0.95);
            }
        }

        /* Dark vignette for immersive gaming feel */
        .ng-vignette {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            pointer-events: none;
            background: radial-gradient(ellipse 70% 70% at 50% 50%, transparent 0%, rgba(0, 0, 0, 0.6) 100%);
        }

        /* Animated neon gradient accent at top of page */
        .ng-top-accent {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            z-index: 100;
            background: linear-gradient(90deg,
                    transparent 0%,
                    rgba(255, 8, 68, 0.9) 15%,
                    rgba(191, 0, 255, 0.8) 40%,
                    rgba(0, 212, 255, 0.7) 65%,
                    rgba(0, 255, 136, 0.6) 85%,
                    transparent 100%);
            background-size: 200% 100%;
            animation: neonAccentShimmer 5s ease-in-out infinite;
        }

        @keyframes neonAccentShimmer {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        /* Gaming Glassmorphism Card - Dark glass with neon hints */
        .ng-card {
            background: rgba(5, 5, 12, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--ng-border);
            border-radius: 1.5rem;
            /* rounded-2xl */
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Neon top gradient line */
        .ng-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255, 8, 68, 0.8), rgba(191, 0, 255, 0.6), rgba(0, 212, 255, 0.5), transparent);
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        /* Gaming hover effect with neon glow */
        .ng-card:hover {
            border-color: rgba(255, 8, 68, 0.3);
            box-shadow: 0 0 30px -10px rgba(255, 8, 68, 0.3), 0 8px 32px -8px rgba(0, 0, 0, 0.5);
        }

        .ng-card:hover::before {
            opacity: 1;
        }

        /* Angular.dev Button Style - High contrast with gradients */
        .ng-btn {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 28px;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            font-size: 14px;
            letter-spacing: 0.01em;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            text-decoration: none;
        }

        /* Primary button - Angular red/pink gradient with high contrast */
        .ng-btn-primary {
            background: linear-gradient(135deg, #dd0031 0%, #c3002f 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(221, 0, 49, 0.35),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .ng-btn-primary:hover {
            box-shadow: 0 6px 20px rgba(221, 0, 49, 0.4);
            filter: brightness(1.08);
        }

        .ng-btn-primary:active {
            transform: translateY(0);
        }

        /* Ghost/Secondary button */
        .ng-btn-secondary,
        .ng-btn-ghost {
            background: transparent;
            color: var(--ng-text-muted);
            border: 1px solid var(--ng-border);
        }

        .ng-btn-secondary:hover,
        .ng-btn-ghost:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--ng-text);
            border-color: var(--ng-border-hover);
        }

        /* Admin Tab Navigation */
        .admin-tab {
            background: transparent;
            color: var(--ng-text-muted);
            border: 1px solid var(--ng-border);
        }

        .admin-tab:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--ng-text);
            border-color: var(--ng-border-hover);
        }

        .admin-tab-active {
            background: var(--ng-gradient-purple) !important;
            color: white !important;
            border-color: transparent !important;
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        .admin-section {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ng-btn-purple {
            background: var(--ng-gradient-purple);
            color: white;
            box-shadow: 0 4px 20px rgba(124, 58, 237, 0.3);
        }

        .ng-btn-purple:hover {
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.35);
            filter: brightness(1.08);
        }

        .ng-btn-outline {
            background: transparent;
            color: var(--ng-text-muted);
            border: 1px solid var(--ng-border);
            border-radius: 100px;
            padding: 8px 16px;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .ng-btn-outline:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--ng-text);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .ng-btn-danger {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.9));
            color: white;
            border: none;
            border-radius: 100px;
            padding: 8px 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ng-btn-danger:hover {
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.25);
            filter: brightness(1.08);
        }

        .ng-btn-warning {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.9), rgba(245, 158, 11, 0.9));
            color: #1a1a1a;
            border: none;
            border-radius: 100px;
            padding: 8px 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ng-btn-warning:hover {
            box-shadow: 0 4px 16px rgba(251, 191, 36, 0.25);
            filter: brightness(1.05);
        }

        .ng-btn-success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.9), rgba(5, 150, 105, 0.9));
            color: white;
            border: none;
            border-radius: 100px;
            padding: 8px 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ng-btn-success:hover {
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.25);
            filter: brightness(1.08);
        }

        /* Angular Input Style - Deep Sea */
        .ng-input {
            width: 100%;
            background: rgba(21, 26, 33, 0.8);
            border: 1px solid var(--ng-border);
            border-radius: 12px;
            padding: 14px 16px;
            color: var(--ng-text);
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: all 0.2s ease;
            outline: none;
        }

        .ng-input:focus {
            border-color: rgba(221, 0, 49, 0.5);
            background: rgba(21, 26, 33, 0.95);
            box-shadow: 0 0 0 3px rgba(221, 0, 49, 0.1),
                0 0 20px rgba(221, 0, 49, 0.1);
        }

        .ng-input::placeholder {
            color: var(--ng-text-subtle);
        }

        /* Modern Select Styling */
        .modern-select {
            appearance: none !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            background-color: rgba(21, 26, 33, 0.8) !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e") !important;
            background-position: right 1rem center !important;
            background-repeat: no-repeat !important;
            background-size: 1.5em 1.5em !important;
            padding: 14px 16px !important;
            padding-right: 2.5rem !important;
            border: 1px solid var(--ng-border) !important;
            border-radius: 12px !important;
            color: var(--ng-text) !important;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            width: 100%;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modern-select:focus {
            border-color: var(--ng-red) !important;
            outline: none !important;
            box-shadow: 0 0 0 3px rgba(221, 0, 49, 0.1) !important;
        }

        .modern-select option {
            background-color: #151a21;
            color: #f1f5f9;
            padding: 12px;
        }

        /* Angular Badge Style */
        .ng-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            border-radius: 100px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--ng-border);
            color: var(--ng-text-muted);
        }

        .ng-badge-pink {
            background: rgba(245, 0, 87, 0.15);
            border-color: rgba(245, 0, 87, 0.3);
            color: var(--ng-pink-light);
        }

        .ng-badge-purple {
            background: rgba(124, 58, 237, 0.15);
            border-color: rgba(124, 58, 237, 0.3);
            color: var(--ng-purple-light);
        }

        .ng-badge-teal {
            background: rgba(20, 184, 166, 0.15);
            border: 1px solid rgba(20, 184, 166, 0.3);
            color: #2DD4BF;
        }

        .ng-badge-green {
            background: rgba(16, 185, 129, 0.15);
            border-color: rgba(16, 185, 129, 0.3);
            color: #34D399;
        }

        .ng-badge-success {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #34D399;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            border-radius: 100px;
        }

        .ng-badge-warning {
            background: rgba(251, 191, 36, 0.15);
            border: 1px solid rgba(251, 191, 36, 0.3);
            color: #FBBF24;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            border-radius: 100px;
        }

        .ng-badge-danger {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #F87171;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            border-radius: 100px;
        }

        .ng-badge-default {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--ng-border);
            color: var(--ng-text-muted);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            border-radius: 100px;
        }

        /* Angular Navigation - Deep Sea */
        .ng-nav {
            padding: 12px 16px;
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(11, 14, 20, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--ng-border);
        }

        /* Angular Gradient Text - Deep Sea with Red accent */
        .ng-gradient-text {
            background: linear-gradient(135deg, #dd0031, #ff6b9d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .ng-gradient-text-pink {
            background: linear-gradient(135deg, #dd0031, #ff6b9d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Glowing border effect */
        .ng-glow-border {
            position: relative;
        }

        .ng-glow-border::after {
            content: '';
            position: absolute;
            inset: -1px;
            border-radius: inherit;
            background: var(--ng-gradient);
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .ng-glow-border:hover::after {
            opacity: 0.5;
            filter: blur(8px);
        }

        /* Grid pattern overlay */
        .ng-grid-pattern {
            position: fixed;
            inset: 0;
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 60px 60px;
            z-index: -1;
            pointer-events: none;
        }

        /* === UTILITY ANIMATIONS === */
        .loader {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(245, 0, 87, 0.2);
            border-top-color: var(--ng-pink);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Responsive Table */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .table-responsive::-webkit-scrollbar {
            height: 6px;
        }

        .table-responsive::-webkit-scrollbar-track {
            background: rgba(36, 36, 40, 0.5);
            border-radius: 3px;
        }

        .table-responsive::-webkit-scrollbar-thumb {
            background: rgba(245, 0, 87, 0.3);
            border-radius: 3px;
        }

        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: rgba(245, 0, 87, 0.5);
        }

        /* Custom Input Styling */
        .input-field {
            transition: all 0.3s ease;
            width: 100%;
        }

        .input-field:focus {
            border-color: var(--ng-pink);
            box-shadow: 0 0 0 3px rgba(245, 0, 87, 0.15);
        }

        /* Card hover effects - minimal */
        .user-card {
            transition: all 0.2s ease;
        }

        .user-card:hover {
            border-color: var(--ng-border-hover);
        }

        /* Mobile-friendly */
        @media (max-width: 768px) {
            .hide-mobile {
                display: none;
            }

            .mobile-stack {
                flex-direction: column;
            }

            .mobile-full {
                width: 100% !important;
            }
        }

        /* Refresh button animation */
        .refresh-btn svg {
            transition: transform 0.3s ease;
        }

        .refresh-btn.spinning svg {
            animation: spin 0.8s ease-in-out;
        }

        /* Toast notification - Angular style */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 100;
            animation: toastFadeIn 0.2s ease-out, toastFadeOut 0.3s ease 2.7s forwards;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(12px);
            max-width: 90vw;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .toast.success {
            background: rgba(16, 185, 129, 0.95);
        }

        .toast.error {
            background: rgba(221, 0, 49, 0.95);
        }

        .toast.warning {
            background: rgba(245, 158, 11, 0.95);
        }

        @keyframes toastFadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes toastFadeOut {
            to {
                opacity: 0;
            }
        }

        /* Mobile toast positioning */
        @media (max-width: 640px) {
            .toast {
                left: 16px;
                right: 16px;
                bottom: 16px;
                justify-content: center;
            }
        }

        /* Notification prompt animations */
        @keyframes slideDown {
            from {
                transform: translate(-50%, -100%);
                opacity: 0;
            }

            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        .animate-slideDown {
            animation: slideDown 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* Pulse effect for credits update */
        @keyframes creditsPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.15);
            }
        }

        .credits-pulse {
            animation: creditsPulse 0.4s ease;
        }

        /* Row highlight animation */
        @keyframes rowHighlight {
            0% {
                background-color: rgba(245, 0, 87, 0.2);
            }

            100% {
                background-color: transparent;
            }
        }

        .row-highlight {
            animation: rowHighlight 1.5s ease;
        }

        /* Shake animation */
        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        .shake {
            animation: shake 0.3s ease;
        }

        /* Input glow */
        .input-glow:focus {
            box-shadow: 0 0 0 3px rgba(245, 0, 87, 0.2), 0 0 30px rgba(245, 0, 87, 0.1);
        }

        /* Stats counter - stable */
        .stat-badge {
            transition: opacity 0.2s ease;
        }

        .stat-badge:hover {
            opacity: 0.9;
        }

        /* Card entrance - simple fade */
        .card-animate {
            opacity: 1;
        }

        /* Group card hover effect - minimal */
        .group-card {
            transition: all 0.2s ease;
        }

        .group-card:hover {
            border-color: var(--ng-border-hover);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
        }

        /* Glory value update animation */
        @keyframes gloryUpdate {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.3);
                color: var(--ng-pink);
            }

            100% {
                transform: scale(1);
            }
        }

        .glory-updated {
            animation: gloryUpdate 0.4s ease;
        }

        /* === ENHANCED ANGULAR ANIMATIONS === */

        /* Floating particles - Angular style */
        .particles-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: var(--ng-pink);
            border-radius: 50%;
            animation: floatParticle 20s infinite ease-in-out;
            opacity: 0.4;
        }

        @keyframes floatParticle {

            0%,
            100% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }

            10% {
                opacity: 0.4;
            }

            90% {
                opacity: 0.4;
            }

            100% {
                transform: translateY(-100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Shine animation for clan card */
        @keyframes shine {
            100% {
                transform: translateX(100%) skewX(12deg);
            }
        }

        .animate-shine {
            animation: shine 2.5s infinite linear;
        }

        /* Page transition - instant */
        .page-transition {
            opacity: 1;
        }

        /* Shimmer loading effect */
        .shimmer {
            background: linear-gradient(90deg, rgba(36, 36, 40, 0.5) 25%, rgba(56, 56, 62, 0.5) 50%, rgba(36, 36, 40, 0.5) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* Skeleton loading */
        .skeleton {
            background: linear-gradient(90deg, var(--ng-bg-card) 25%, var(--ng-bg-elevated) 50%, var(--ng-bg-card) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        /* Pulse glow effect - disabled for stable UI */
        .pulse-glow {
            /* no animation for stability */
        }

        /* Ripple effect on buttons */
        .btn-ripple {
            position: relative;
            overflow: hidden;
        }

        .btn-ripple::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .btn-ripple:active::after {
            width: 300px;
            height: 300px;
        }

        /* Simple icon hover - no bounce */
        .bounce-icon:hover svg {
            opacity: 0.9;
        }

        /* Slide in from bottom - minimal fade */
        @keyframes slideUp {
            0% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        .slide-up {
            animation: slideUp 0.15s ease-out forwards;
        }

        /* Modal slide up animation - minimal */
        @keyframes modalSlideUp {
            0% {
                opacity: 0;
                transform: scale(0.98);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-slide-up {
            animation: modalSlideUp 0.2s ease-out;
        }

        /* Counter animation */
        .counter-animate {
            display: inline-block;
            transition: all 0.3s ease;
        }

        .counter-animate.updating {
            transform: scale(1.2);
            color: var(--ng-pink);
        }

        @keyframes counterPop {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        .counter-animate.updated {
            animation: counterPop 0.4s ease;
        }

        /* Fade in - simple */
        .fade-in-scale {
            opacity: 1;
        }

        /* Loading overlay */
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(15, 15, 17, 0.9);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: inherit;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            pointer-events: all;
        }

        /* Large spinner */
        .spinner-lg {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(245, 0, 87, 0.2);
            border-top-color: var(--ng-pink);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Hover lift effect - minimal */
        .hover-lift {
            transition: box-shadow 0.2s ease;
        }

        .hover-lift:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }

        /* Mobile touch feedback */
        @media (hover: none) {
            .touch-feedback {
                transition: transform 0.1s ease, background 0.1s ease;
            }

            .touch-feedback:active {
                transform: scale(0.97);
                background: rgba(255, 255, 255, 0.05);
            }
        }

        /* Glass morphism enhanced - Angular style */
        .glass-enhanced {
            background: rgba(26, 26, 29, 0.7);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 0 0 1px rgba(255, 255, 255, 0.03);
        }

        /* Refresh button enhanced */
        .refresh-btn-enhanced {
            position: relative;
            overflow: hidden;
        }

        .refresh-btn-enhanced::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(245, 0, 87, 0.1), transparent);
            transform: rotate(45deg) translateX(-100%);
            transition: transform 0.6s ease;
        }

        .refresh-btn-enhanced:hover::before {
            transform: rotate(45deg) translateX(100%);
        }

        /* Live indicator */
        .live-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: livePulse 2s infinite;
        }

        @keyframes livePulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        /* Smooth scrollbar */
        .scroll-smooth {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        /* Responsive improvements */
        @media (max-width: 640px) {
            .text-responsive {
                font-size: 0.875rem;
            }

            .mobile-compact {
                padding: 0.75rem;
            }
        }

        /* Angular Table Styling */
        .ng-table-container {
            border: 1px solid var(--ng-border);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .ng-table-container::-webkit-scrollbar {
            height: 6px;
        }

        .ng-table-container::-webkit-scrollbar-track {
            background: rgba(36, 36, 40, 0.5);
            border-radius: 3px;
        }

        .ng-table-container::-webkit-scrollbar-thumb {
            background: rgba(245, 0, 87, 0.3);
            border-radius: 3px;
        }

        .ng-table-container::-webkit-scrollbar-thumb:hover {
            background: rgba(245, 0, 87, 0.5);
        }

        .ng-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .ng-table th {
            text-align: left;
            padding: 12px 16px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--ng-text-muted);
            border-bottom: 1px solid var(--ng-border);
            background: rgba(15, 15, 17, 0.8);
            position: sticky;
            top: 0;
            backdrop-filter: blur(10px);
        }

        .ng-table td {
            padding: 14px 16px;
            font-size: 14px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }

        .ng-table tr:hover td {
            background: rgba(245, 0, 87, 0.05);
        }

        /* Form Group Styling */
        .ng-form-group {
            margin-bottom: 20px;
        }

        .ng-form-label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--ng-text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        /* Status Pills */
        .ng-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 100px;
            font-size: 12px;
            font-weight: 500;
        }

        .ng-status-running {
            background: rgba(16, 185, 129, 0.15);
            color: #34D399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .ng-status-stopped {
            background: rgba(239, 68, 68, 0.15);
            color: #F87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .ng-status-pending {
            background: rgba(245, 158, 11, 0.15);
            color: #FBBF24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        /* Angular Icon Button */
        .ng-icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: 1px solid var(--ng-border);
            background: transparent;
            color: var(--ng-text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ng-icon-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--ng-text);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .ng-icon-btn-pink:hover {
            background: rgba(245, 0, 87, 0.1);
            color: var(--ng-pink);
            border-color: rgba(245, 0, 87, 0.3);
        }

        /* Section Title */
        .ng-section-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 600;
            color: var(--ng-text);
        }

        .ng-section-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ng-section-icon-pink {
            background: linear-gradient(135deg, rgba(245, 0, 87, 0.2), rgba(245, 0, 87, 0.1));
            border: 1px solid rgba(245, 0, 87, 0.3);
        }

        .ng-section-icon-purple {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.2), rgba(124, 58, 237, 0.1));
            border: 1px solid rgba(124, 58, 237, 0.3);
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">
    <!-- Angular.dev Deep Sea Background Effects - Enhanced Professional -->
    <div class="ng-bg-gradient"></div>
    <div class="ng-aurora-waves"></div>
    <div class="ng-floating-orbs">
        <div class="ng-orb ng-orb-1"></div>
        <div class="ng-orb ng-orb-2"></div>
        <div class="ng-orb ng-orb-3"></div>
    </div>
    <div class="ng-grid-pattern"></div>
    <div class="ng-noise-overlay"></div>
    <div class="ng-vignette"></div>
    <div class="ng-top-accent"></div>

    <!-- Login Screen - Angular.dev Style -->
    <div id="login-screen" class="flex-grow flex items-center justify-center p-6 md:p-8 relative z-10">
        <div class="w-full max-w-md">
            <!-- Glassmorphism Login Card with rounded-2xl -->
            <div class="ng-card p-8 md:p-10">
                <!-- Angular-style Logo with glow -->
                <div class="text-center mb-10">
                    <div class="relative inline-block">
                        <!-- Glow effect behind logo -->
                        <div
                            class="absolute inset-0 blur-2xl bg-gradient-to-br from-red-500/30 to-pink-500/20 rounded-full scale-150">
                        </div>
                        <div
                            class="relative w-20 h-20 mx-auto rounded-2xl bg-gradient-to-br from-[#dd0031] to-[#c3002f] flex items-center justify-center shadow-lg shadow-red-500/25">
                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                    </div>
                    <h2 id="auth-title"
                        class="heading text-3xl md:text-4xl font-bold mt-6 bg-gradient-to-r from-white via-gray-100 to-gray-300 bg-clip-text text-transparent">
                        Welcome Back</h2>
                    <p id="auth-subtitle" class="text-[var(--ng-text-muted)] text-sm mt-3">Sign in to <span
                            class="text-[#dd0031] font-semibold">FFGlory</span> panel</p>
                </div>

                <!-- Angular-style Auth Tabs -->
                <div class="flex mb-8 bg-white/5 rounded-xl p-1.5 border border-white/10">
                    <button onclick="switchAuthTab('login')" id="login-tab"
                        class="flex-1 py-3 px-4 rounded-lg text-sm font-medium transition-all bg-gradient-to-r from-[#dd0031] to-[#c3002f] text-white shadow-sm">
                        Sign In
                    </button>
                    <button onclick="switchAuthTab('signup')" id="signup-tab"
                        class="flex-1 py-3 px-4 rounded-lg text-sm font-medium transition-all text-[var(--ng-text-muted)] hover:text-white hover:bg-white/5">
                        Sign Up
                    </button>
                </div>

                <!-- Login Form -->
                <form id="login-form" class="space-y-5">
                    <div class="ng-form-group">
                        <label class="block text-[var(--ng-text-muted)] text-sm font-medium mb-2">Username</label>
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-[var(--ng-text-subtle)]">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </span>
                            <input type="text" name="username" class="ng-input pl-12" placeholder="Enter your username"
                                required>
                        </div>
                    </div>
                    <div class="ng-form-group">
                        <label class="block text-[var(--ng-text-muted)] text-sm font-medium mb-2">Password</label>
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-[var(--ng-text-subtle)]">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z">
                                    </path>
                                </svg>
                            </span>
                            <input type="password" name="password" class="ng-input pl-12"
                                placeholder="Enter your password" required>
                        </div>
                    </div>
                    <!-- Primary Button with high contrast gradient -->
                    <button type="button" id="login-btn"
                        class="w-full py-4 px-6 rounded-xl font-semibold text-white bg-gradient-to-r from-[#dd0031] to-[#c3002f] hover:shadow-lg hover:shadow-red-500/25 transition-shadow duration-200 flex items-center justify-center gap-2">
                        <svg id="login-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1">
                            </path>
                        </svg>
                        <span id="login-text">Sign In</span>
                    </button>
                </form>

                <!-- Signup Form -->
                <form id="signup-form" class="space-y-5 hidden">
                    <!-- Invitation Code - DISABLED for open registration -->
                    <!-- <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-300">
                        Invitation Code <span class="text-[#dd0031]">*</span>
                    </label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path></svg>
                        </span>
                        <input type="text" name="invitation_code" id="signup-invitation-code" class="ng-input pl-12 uppercase font-mono" placeholder="XXXXXXXX" maxlength="8" style="letter-spacing: 0.2em;">
                    </div>
                    <p class="text-xs text-amber-400/80 flex items-center gap-1.5">
                        <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                        Get invitation code from admin
                    </p>
                </div> -->

                    <!-- Open Registration Notice -->
                    <div class="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-4 text-center">
                        <div class="flex items-center justify-center gap-2 text-emerald-400 mb-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="font-semibold">Open Registration</span>
                        </div>
                        <p class="text-xs text-emerald-300/70">No invitation code required - create your account now!
                        </p>
                    </div>
                    <input type="hidden" id="signup-invitation-code" value="">

                    <!-- Username -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-300">Username</label>
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </span>
                            <input type="text" name="username" id="signup-username" class="ng-input pl-12 lowercase"
                                placeholder="Choose a username" required minlength="3" maxlength="20"
                                pattern="[a-z0-9_]+">
                        </div>
                        <p class="text-xs text-gray-500">Lowercase letters, numbers, and underscore only</p>
                    </div>

                    <!-- Password -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-300">Password</label>
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z">
                                    </path>
                                </svg>
                            </span>
                            <input type="password" name="password" id="signup-password" class="ng-input pl-12"
                                placeholder="Create a password" required minlength="3">
                        </div>
                        <p class="text-xs text-gray-500">Minimum 6 characters</p>
                    </div>

                    <!-- Confirm Password -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-300">Confirm Password</label>
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z">
                                    </path>
                                </svg>
                            </span>
                            <input type="password" name="confirm_password" id="signup-confirm-password"
                                class="ng-input pl-12" placeholder="Confirm your password" required>
                        </div>
                    </div>

                    <!-- Cloudflare Turnstile Widget -->
                    <div class="flex justify-center py-2">
                        <div class="cf-turnstile" data-sitekey="0x4AAAAAACJo57A0jWBDeRMS" data-theme="dark"
                            data-callback="onTurnstileSuccess" data-expired-callback="onTurnstileExpired"></div>
                    </div>

                    <!-- Submit Button -->
                    <button type="button" id="signup-btn"
                        class="w-full py-4 px-6 rounded-xl font-semibold text-white bg-gradient-to-r from-[#dd0031] to-[#c3002f] hover:shadow-lg hover:shadow-red-500/25 transition-shadow duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:shadow-none"
                        disabled>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z">
                            </path>
                        </svg>
                        <span id="signup-text">Create Account</span>
                    </button>
                </form>

                <p id="login-error"
                    class="text-red-400 text-sm mt-4 text-center hidden bg-red-500/10 py-3 rounded-xl border border-red-500/30 shake">
                </p>
                <p id="signup-success"
                    class="text-emerald-400 text-sm mt-4 text-center hidden bg-emerald-500/10 py-3 rounded-xl border border-emerald-500/30">
                </p>

                <!-- Contact Admin Section -->
                <div class="mt-8 pt-6 border-t border-white/10 text-center">
                    <p class="text-sm text-[var(--ng-text-muted)] mb-4">Need help? Contact Admin</p>
                    <div class="flex flex-col gap-3">
                        <a href="https://wa.me/6282326562316" target="_blank"
                            class="flex items-center justify-center gap-2 p-3 rounded-xl bg-[#25D366]/10 text-[#25D366] hover:bg-[#25D366]/20 transition-colors border border-[#25D366]/20 no-underline">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z" />
                            </svg>
                            <span class="font-medium">WhatsApp</span>
                        </a>
                        <a href="https://t.me/ff_level_pro" target="_blank"
                            class="flex items-center justify-center gap-2 p-3 rounded-xl bg-[#0088cc]/10 text-[#0088cc] hover:bg-[#0088cc]/20 transition-colors border border-[#0088cc]/20 no-underline">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 11.944 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z" />
                            </svg>
                            <span class="font-medium">Telegram</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard-screen" class="hidden flex-grow flex flex-col">
        <!-- Angular.dev Deep Sea Navbar -->
        <nav class="sticky top-0 z-20 px-4 py-3 bg-[#0b0e14]/90 backdrop-blur-xl border-b border-white/10">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <!-- Angular-style logo icon -->
                        <div
                            class="w-9 h-9 rounded-xl bg-gradient-to-br from-[#dd0031] to-[#c3002f] flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                        <div class="flex items-center gap-2">
                            <h1 class="text-lg md:text-xl font-semibold text-white heading">FFGlory</h1>
                            <div class="live-indicator hidden sm:flex">
                                <span class="live-dot"></span>
                                <span class="text-[10px] text-emerald-400 font-medium">LIVE</span>
                            </div>
                        </div>
                    </div>
                    <button id="logout-btn"
                        class="sm:hidden text-xs text-gray-400 hover:text-white border border-white/10 hover:border-white/20 rounded-lg px-3 py-1.5 transition-colors">Logout</button>
                </div>
                <div class="flex items-center justify-between sm:justify-end gap-3">
                    <div class="flex items-center gap-2 flex-wrap">
                        <span id="user-badge" class="ng-badge-default text-xs"></span>
                        <span id="basic-credits-badge" class="ng-badge-success text-xs hidden">
                            <span></span> Basic: <span id="basic-credits-val" class="font-bold">0</span>
                        </span>
                        <span id="premium-credits-badge" class="ng-badge-warning text-xs hidden">
                            <span></span> Premium: <span id="premium-credits-val" class="font-bold">0</span>
                        </span>
                        <!-- Inbox Bell -->
                        <button id="inbox-bell" onclick="toggleInboxSection()"
                            class="hidden relative ng-icon-btn ng-icon-btn-pink" title="Inbox">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4">
                                </path>
                            </svg>
                            <span id="inbox-bell-badge"
                                class="hidden absolute -top-1 -right-1 w-4 h-4 bg-pink-500 rounded-full text-[10px] font-bold flex items-center justify-center">0</span>
                        </button>
                        <!-- Notification Bell -->
                        <button id="notification-bell" onclick="toggleNotifications()"
                            class="hidden relative ng-icon-btn ng-icon-btn-pink" title="Notifications">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                                </path>
                            </svg>
                            <span id="notification-status"
                                class="absolute -top-1 -right-1 w-3 h-3 rounded-full border-2 border-[var(--ng-bg-dark)]"></span>
                        </button>
                    </div>
                    <button id="logout-btn-desktop"
                        class="hidden sm:block ng-btn-outline text-xs px-3 py-1.5">Logout</button>
                </div>
            </div>
        </nav>

        <div class="flex-grow p-4 md:p-6 overflow-auto relative z-10">

            <!-- Admin View -->
            <div id="admin-view" class="hidden space-y-6 md:space-y-8">

                <!-- Admin Navigation Tabs -->
                <div class="ng-card p-2">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="switchAdminTab('users')" id="admin-tab-users"
                            class="admin-tab admin-tab-active flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z">
                                </path>
                            </svg>
                            <span>Users</span>
                            <span id="admin-tab-users-badge" class="ng-badge-purple text-xs">0</span>
                        </button>
                        <button onclick="switchAdminTab('invitations')" id="admin-tab-invitations"
                            class="admin-tab flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z">
                                </path>
                            </svg>
                            <span>Invitations</span>
                            <span id="admin-tab-invitations-badge" class="ng-badge-warning text-xs">0</span>
                        </button>
                        <button onclick="switchAdminTab('groups')" id="admin-tab-groups"
                            class="admin-tab flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                                </path>
                            </svg>
                            <span>Groups</span>
                            <span id="admin-tab-groups-badge" class="ng-badge-default text-xs">0</span>
                        </button>
                        <button onclick="switchAdminTab('transactions')" id="admin-tab-transactions"
                            class="admin-tab flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z">
                                </path>
                            </svg>
                            <span>Transactions</span>
                            <span id="admin-tab-transactions-badge" class="ng-badge-success text-xs hidden">0</span>
                        </button>
                        <button onclick="switchAdminTab('pricing')" id="admin-tab-pricing"
                            class="admin-tab flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                </path>
                            </svg>
                            <span>Pricing</span>
                        </button>
                        <button onclick="switchAdminTab('history')" id="admin-tab-history"
                            class="admin-tab flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span>History</span>
                        </button>
                        <button onclick="switchAdminTab('inbox')" id="admin-tab-inbox"
                            class="admin-tab flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4">
                                </path>
                            </svg>
                            <span>Broadcast</span>
                        </button>
                        <button onclick="switchAdminTab('coupons')" id="admin-tab-coupons"
                            class="admin-tab flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z">
                                </path>
                            </svg>
                            <span>Coupons</span>
                            <span id="admin-tab-coupons-badge" class="ng-badge-teal text-xs hidden">0</span>
                        </button>
                        <button onclick="switchAdminTab('settings')" id="admin-tab-settings"
                            class="admin-tab flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                                </path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <span>Settings</span>
                        </button>
                    </div>
                </div>

                <!-- Admin Section: Users -->
                <div id="admin-section-users" class="admin-section">
                    <!-- User Management -->
                    <div class="ng-card p-4 md:p-6">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
                            <h2 class="ng-section-title">
                                <div class="ng-section-icon ng-section-icon-purple">
                                    <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z">
                                        </path>
                                    </svg>
                                </div>
                                User Management
                            </h2>
                            <div class="flex items-center gap-2">
                                <span id="users-count-badge" class="ng-badge-purple text-xs counter-animate">0
                                    users</span>
                                <button id="refresh-users-btn"
                                    class="ng-btn-outline text-xs px-4 py-2 flex items-center gap-2">
                                    <svg class="w-4 h-4 refresh-icon" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                        </path>
                                    </svg>
                                    Refresh
                                </button>
                            </div>
                        </div>

                        <!-- User Search and Sort Controls -->
                        <div
                            class="bg-gradient-to-r from-slate-800/50 to-slate-700/30 p-4 rounded-xl border border-slate-600/30 mb-4">
                            <div class="flex flex-col sm:flex-row gap-3">
                                <div class="flex-1">
                                    <div class="relative">
                                        <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                        </svg>
                                        <input type="text" id="user-search-input"
                                            placeholder="Search users by username..."
                                            class="ng-input pl-10 text-sm w-full" oninput="debounceUserSearch()">
                                        <span id="user-search-spinner"
                                            class="absolute right-3 top-1/2 -translate-y-1/2 hidden">
                                            <span class="loader w-4 h-4"></span>
                                        </span>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <select id="user-sort-field" class="ng-input text-sm"
                                        onchange="filterAndSortUsers()">
                                        <option value="username">Sort by: Username</option>
                                        <option value="role">Sort by: Role</option>
                                        <option value="credits">Sort by: Credits</option>
                                        <option value="max_groups">Sort by: Max Groups</option>
                                    </select>
                                    <button onclick="toggleUserSortOrder()" id="user-sort-order-btn"
                                        class="ng-btn-outline px-3 py-2 flex items-center gap-1"
                                        title="Toggle sort order">
                                        <svg id="user-sort-icon-asc" class="w-4 h-4" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"></path>
                                        </svg>
                                        <svg id="user-sort-icon-desc" class="w-4 h-4 hidden" fill="none"
                                            stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M3 4h13M3 8h9m-9 4h9m5-4v12m0 0l-4-4m4 4l4-4"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-gray-400">
                                <span id="user-filter-status">Showing all users</span>
                            </div>
                        </div>

                        <!-- Create User Form - Angular Style -->
                        <div
                            class="bg-gradient-to-r from-purple-500/10 to-pink-500/10 p-5 rounded-xl border border-purple-500/20 mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3
                                    class="text-sm font-semibold text-purple-300 uppercase tracking-wider flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z">
                                        </path>
                                    </svg>
                                    Create New User
                                </h3>
                                <button id="clear-form-btn"
                                    class="text-xs text-gray-400 hover:text-pink-400 transition-colors">Clear
                                    Form</button>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
                                <div class="sm:col-span-1">
                                    <label class="ng-form-label">Username <span class="text-pink-400">*</span></label>
                                    <input type="text" id="new-username" placeholder="john_doe"
                                        class="ng-input text-sm">
                                </div>
                                <div class="sm:col-span-1">
                                    <label class="ng-form-label">Password <span class="text-pink-400">*</span></label>
                                    <div class="relative">
                                        <input type="password" id="new-password" placeholder=""
                                            class="ng-input text-sm pr-10">
                                        <button type="button" onclick="togglePasswordVisibility('new-password', this)"
                                            class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-pink-400 transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z">
                                                </path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="sm:col-span-1">
                                    <label class="ng-form-label">Role</label>
                                    <select id="new-role" class="ng-input text-sm">
                                        <option value="user"> User</option>
                                        <option value="admin"> Admin</option>
                                    </select>
                                </div>
                                <div class="sm:col-span-1">
                                    <label class="ng-form-label">Credits</label>
                                    <input type="number" id="new-credits" placeholder="10" value="10" min="0"
                                        class="ng-input text-sm">
                                </div>
                                <div class="sm:col-span-1">
                                    <label class="ng-form-label">Max Groups</label>
                                    <input type="number" id="new-max-groups" placeholder="5" value="5" min="0"
                                        class="ng-input text-sm">
                                </div>
                                <div class="sm:col-span-2 lg:col-span-1 flex items-end">
                                    <button id="create-user-btn"
                                        class="w-full ng-btn-purple px-4 py-2.5 text-sm flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                        <svg id="create-user-icon" class="w-4 h-4" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                        <span id="create-user-text">Create User</span>
                                    </button>
                                </div>
                            </div>
                            <p id="create-form-error"
                                class="hidden mt-3 text-sm text-red-400 bg-red-500/10 px-3 py-2 rounded-lg border border-red-500/30">
                            </p>
                        </div>

                        <!-- Users Table - Angular Style -->
                        <div class="ng-table-container rounded-xl">
                            <table class="ng-table min-w-[700px]">
                                <thead>
                                    <tr>
                                        <th class="p-2 md:p-3">Username</th>
                                        <th class="p-2 md:p-3">Password</th>
                                        <th class="p-2 md:p-3">Role</th>
                                        <th class="p-2 md:p-3 text-center">Credits</th>
                                        <th class="p-2 md:p-3 text-center">Max Groups</th>
                                        <th class="p-2 md:p-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body"></tbody>
                            </table>
                        </div>

                        <!-- Mobile hint -->
                        <p class="text-xs text-gray-500 mt-2 md:hidden text-center"> Scroll horizontally to see all
                            columns </p>
                    </div>
                </div><!-- End admin-section-users -->

                <!-- Admin Section: Invitations -->
                <div id="admin-section-invitations" class="admin-section hidden">
                    <!-- Invitation Codes -->
                    <div class="ng-card p-4 md:p-6">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
                            <h2 class="ng-section-title">
                                <div class="ng-section-icon"
                                    style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(251, 191, 36, 0.1)); border: 1px solid rgba(251, 191, 36, 0.3);">
                                    <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z">
                                        </path>
                                    </svg>
                                </div>
                                <span class="text-amber-400">Invitation Codes</span>
                            </h2>
                            <div class="flex items-center gap-2">
                                <span id="invites-count-badge" class="ng-badge-warning text-xs">0 unused</span>
                                <button id="refresh-invites-btn" onclick="loadInvitations()"
                                    class="ng-btn-outline text-xs px-4 py-2 flex items-center gap-2">
                                    <svg class="w-4 h-4 refresh-icon" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                        </path>
                                    </svg>
                                    Refresh
                                </button>
                            </div>
                        </div>

                        <!-- Generate Codes Form - Angular Style -->
                        <div
                            class="bg-gradient-to-r from-amber-500/10 to-orange-500/10 p-5 rounded-xl border border-amber-500/20 mb-6">
                            <div class="flex flex-col sm:flex-row items-start sm:items-end gap-4">
                                <div class="flex-1">
                                    <label class="ng-form-label">Number of codes to generate</label>
                                    <input type="number" id="invite-count" value="1" min="1" max="50"
                                        class="ng-input text-sm w-full sm:w-32 focus:border-amber-500">
                                </div>
                                <button id="generate-invite-btn" onclick="generateInvitations()"
                                    class="ng-btn-warning px-6 py-2.5 text-sm flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    Generate Codes
                                </button>
                            </div>
                            <div id="generated-codes-display"
                                class="hidden mt-4 p-4 bg-black/30 rounded-lg border border-amber-500/30">
                                <p class="text-xs text-amber-400 mb-2 font-medium"> Newly Generated Codes (copy these):
                                </p>
                                <div id="new-codes-list"
                                    class="font-mono text-lg text-amber-300 tracking-wider space-y-1"></div>
                            </div>
                        </div>

                        <!-- Invitations Table - Angular Style -->
                        <div class="ng-table-container rounded-xl">
                            <table class="ng-table min-w-[600px]">
                                <thead>
                                    <tr>
                                        <th class="p-2 md:p-3">Code</th>
                                        <th class="p-2 md:p-3">Status</th>
                                        <th class="p-2 md:p-3">Created</th>
                                        <th class="p-2 md:p-3">Used By</th>
                                        <th class="p-2 md:p-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="invites-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div><!-- End admin-section-invitations -->

                <!-- Admin Section: Groups -->
                <div id="admin-section-groups" class="admin-section hidden">
                    <!-- All Groups -->
                    <div class="ng-card p-4 md:p-6">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
                            <h2 class="ng-section-title">
                                <div class="ng-section-icon"
                                    style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1)); border: 1px solid rgba(59, 130, 246, 0.3);">
                                    <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                                        </path>
                                    </svg>
                                </div>
                                <span class="text-blue-400">All Running Groups</span>
                            </h2>
                            <div class="flex items-center gap-2">
                                <button id="cleanup-old-groups-btn" onclick="openCleanupModal()"
                                    class="ng-btn-danger text-xs px-4 py-2 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                        </path>
                                    </svg>
                                    Cleanup Old
                                </button>
                                <button id="refresh-admin-groups"
                                    class="ng-btn-outline text-xs px-4 py-2 flex items-center gap-2">
                                    <svg class="w-4 h-4 refresh-icon" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                        </path>
                                    </svg>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        <div id="admin-groups-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>
                </div><!-- End admin-section-groups -->

                <!-- Admin Section: History -->
                <div id="admin-section-history" class="admin-section hidden">
                    <!-- Action History -->
                    <div class="ng-card p-4 md:p-6">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
                            <h2 class="ng-section-title">
                                <div class="ng-section-icon"
                                    style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(251, 191, 36, 0.1)); border: 1px solid rgba(251, 191, 36, 0.3);">
                                    <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <span class="text-amber-400">Action History</span>
                            </h2>
                            <button id="refresh-history"
                                class="ng-btn-outline text-xs px-4 py-2 flex items-center gap-2">
                                <svg class="w-4 h-4 refresh-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                    </path>
                                </svg>
                                Refresh
                            </button>
                        </div>
                        <div class="ng-table-container max-h-96 rounded-xl overflow-y-auto">
                            <table class="ng-table min-w-[600px]">
                                <thead>
                                    <tr>
                                        <th class="p-2 md:p-3">Time</th>
                                        <th class="p-2 md:p-3">User</th>
                                        <th class="p-2 md:p-3">Action</th>
                                        <th class="p-2 md:p-3">Group ID</th>
                                        <th class="p-2 md:p-3">Clan ID</th>
                                        <th class="p-2 md:p-3">Details</th>
                                    </tr>
                                </thead>
                                <tbody id="history-table-body" class="font-mono text-xs"></tbody>
                            </table>
                        </div>
                        <p class="text-xs text-gray-500 mt-2 md:hidden text-center"> Scroll horizontally to see all
                            columns </p>
                    </div>
                </div><!-- End admin-section-history -->

                <!-- Admin Section: Transactions -->
                <div id="admin-section-transactions" class="admin-section hidden">
                    <!-- Pending Transactions (Admin) -->
                    <div class="ng-card p-4 md:p-6">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
                            <h2 class="ng-section-title">
                                <div class="ng-section-icon"
                                    style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1)); border: 1px solid rgba(16, 185, 129, 0.3);">
                                    <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z">
                                        </path>
                                    </svg>
                                </div>
                                <span class="text-emerald-400">Credit Transactions</span>
                                <span id="pending-tx-badge" class="hidden ng-badge-warning text-xs animate-pulse">0
                                    Pending</span>
                            </h2>
                            <div class="flex gap-2">
                                <!-- <button onclick="repairMissingCredits()" class="ng-btn-warning text-xs px-4 py-2 flex items-center gap-2" title="Repair approved transactions that didn't grant credits">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                Repair Credits
                            </button> -->
                                <button id="refresh-transactions-admin" onclick="loadAdminTransactions()"
                                    class="ng-btn-outline text-xs px-4 py-2 flex items-center gap-2">
                                    <svg class="w-4 h-4 refresh-icon" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                        </path>
                                    </svg>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        <div id="admin-transactions-list"
                            class="ng-table-container max-h-96 rounded-xl overflow-y-auto">
                            <table class="ng-table min-w-[700px]">
                                <thead>
                                    <tr>
                                        <th class="p-2 md:p-3">Time</th>
                                        <th class="p-2 md:p-3">User</th>
                                        <th class="p-2 md:p-3">TX ID</th>
                                        <th class="p-2 md:p-3 text-center">Credits</th>
                                        <th class="p-2 md:p-3 text-center">Amount</th>
                                        <th class="p-2 md:p-3 text-center">Status</th>
                                        <th class="p-2 md:p-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-transactions-body" class="text-xs"></tbody>
                            </table>
                        </div>
                        <p class="text-xs text-gray-500 mt-2 md:hidden text-center"> Scroll horizontally to see all
                            columns </p>
                    </div>
                </div><!-- End admin-section-transactions -->

                <!-- Admin Section: Pricing -->
                <div id="admin-section-pricing" class="admin-section hidden">
                    <div class="ng-card p-4 md:p-6">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
                            <h2 class="ng-section-title">
                                <div class="ng-section-icon"
                                    style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(251, 191, 36, 0.1)); border: 1px solid rgba(251, 191, 36, 0.3);">
                                    <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                        </path>
                                    </svg>
                                </div>
                                <span class="text-amber-400">Credit Pricing & Regions</span>
                            </h2>
                            <button onclick="loadAdminPricing()"
                                class="ng-btn-outline text-xs px-4 py-2 flex items-center gap-2">
                                <svg class="w-4 h-4 refresh-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                    </path>
                                </svg>
                                Refresh
                            </button>
                        </div>

                        <!-- Credit Prices Section -->
                        <div
                            class="mb-6 p-4 bg-gradient-to-br from-emerald-500/10 to-blue-500/10 rounded-xl border border-emerald-500/30">
                            <h3 class="text-emerald-400 font-bold mb-4 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                    </path>
                                </svg>
                                Credit Prices
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl"></span>
                                    <div class="flex-1">
                                        <label class="text-sm text-gray-400">Basic Credit Price ($)</label>
                                        <div class="flex items-center gap-2 mt-1">
                                            <input type="number" id="admin-basic-price" value="1.70" min="0.01"
                                                step="0.01" class="ng-input flex-1 focus:border-blue-500">
                                            <button onclick="updateCreditPrice('basic')"
                                                class="ng-btn-primary text-xs px-3 py-2">Save</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl"></span>
                                    <div class="flex-1">
                                        <label class="text-sm text-gray-400">Premium Credit Price ($)</label>
                                        <div class="flex items-center gap-2 mt-1">
                                            <input type="number" id="admin-premium-price" value="20.00" min="0.01"
                                                step="0.01" class="ng-input flex-1 focus:border-amber-500">
                                            <button onclick="updateCreditPrice('premium')"
                                                class="ng-btn-warning text-xs px-3 py-2">Save</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Add New Region -->
                        <div
                            class="mb-6 p-4 bg-gradient-to-br from-purple-500/10 to-pink-500/10 rounded-xl border border-purple-500/30">
                            <h3 class="text-purple-400 font-bold mb-4 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Add New Region
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400">Region Name</label>
                                    <input type="text" id="new-region-name" placeholder="e.g., Europe"
                                        class="ng-input w-full mt-1">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400">Accounts File</label>
                                    <input type="text" id="new-region-file" placeholder="e.g., accounts_eu.txt"
                                        class="ng-input w-full mt-1">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400">Credit Tier</label>
                                    <select id="new-region-tier" class="ng-input w-full mt-1">
                                        <option value="basic"> Basic</option>
                                        <option value="premium"> Premium</option>
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button onclick="addNewRegion()"
                                        class="ng-btn-success w-full py-2 flex items-center justify-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                        Add Region
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Pricing Info -->
                        <div
                            class="mb-4 text-sm text-blue-300 bg-blue-500/10 p-3 rounded-xl border border-blue-500/30 flex items-start gap-2">
                            <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span> <strong>Basic regions</strong> cost 1 Basic Credit per launch.  <strong>Premium
                                    regions</strong> cost 1 Premium Credit per launch. Users need the appropriate credit
                                type for each region.</span>
                        </div>

                        <!-- Regions Table -->
                        <div id="admin-pricing-list" class="space-y-3">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div><!-- End admin-section-pricing -->

                <!-- Admin Section: Inbox / Broadcast -->
                <div id="admin-section-inbox" class="admin-section hidden">
                    <div class="ng-card p-4 md:p-6">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
                            <h2 class="ng-section-title">
                                <div class="ng-section-icon"
                                    style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1)); border: 1px solid rgba(59, 130, 246, 0.3);">
                                    <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4">
                                        </path>
                                    </svg>
                                </div>
                                <span class="text-blue-400">Broadcast Messages</span>
                            </h2>
                            <button onclick="loadAdminBroadcasts()"
                                class="ng-btn-outline text-xs px-4 py-2 flex items-center gap-2">
                                <svg class="w-4 h-4 refresh-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                    </path>
                                </svg>
                                Refresh
                            </button>
                        </div>

                        <!-- Send New Broadcast -->
                        <div
                            class="bg-gradient-to-r from-blue-500/10 to-cyan-500/10 p-5 rounded-xl border border-blue-500/20 mb-6">
                            <h3
                                class="text-sm font-semibold text-blue-300 uppercase tracking-wider flex items-center gap-2 mb-4">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z">
                                    </path>
                                </svg>
                                Send New Broadcast
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="ng-form-label">Title <span class="text-pink-400">*</span></label>
                                    <input type="text" id="broadcast-title" placeholder="Message title"
                                        class="ng-input text-sm">
                                </div>
                                <div>
                                    <label class="ng-form-label">Type</label>
                                    <select id="broadcast-type" class="ng-input text-sm">
                                        <option value="info"> Info</option>
                                        <option value="update"> Update</option>
                                        <option value="warning"> Warning</option>
                                        <option value="success"> Success</option>
                                        <option value="promo"> Promotion</option>
                                    </select>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="ng-form-label">Content <span class="text-pink-400">*</span></label>
                                    <textarea id="broadcast-content" placeholder="Enter your message content..."
                                        class="ng-input text-sm min-h-[100px] resize-y"></textarea>
                                </div>
                                <div>
                                    <label class="ng-form-label">Priority</label>
                                    <select id="broadcast-priority" class="ng-input text-sm">
                                        <option value="1"> Low</option>
                                        <option value="2" selected> Normal</option>
                                        <option value="3"> High</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="ng-form-label">Expires In (hours, 0=never)</label>
                                    <input type="number" id="broadcast-expires" value="0" min="0" max="720"
                                        class="ng-input text-sm">
                                </div>
                            </div>
                            <div class="mt-4 flex justify-end">
                                <button onclick="sendBroadcast()" class="ng-btn-pink text-sm px-6 py-2.5">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                    </svg>
                                    Send to All Users
                                </button>
                            </div>
                        </div>

                        <!-- Sent Broadcasts List -->
                        <div>
                            <h3 class="text-sm font-semibold text-gray-300 uppercase tracking-wider mb-4">Sent
                                Broadcasts</h3>
                            <div id="admin-broadcasts-list" class="space-y-3">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div><!-- End admin-section-inbox -->

                <!-- Admin Section: Coupons -->
                <div id="admin-section-coupons" class="admin-section hidden">
                    <div class="ng-card p-4 md:p-6">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
                            <h2 class="ng-section-title">
                                <div class="ng-section-icon"
                                    style="background: linear-gradient(135deg, rgba(20, 184, 166, 0.2), rgba(6, 182, 212, 0.1)); border: 1px solid rgba(20, 184, 166, 0.3);">
                                    <svg class="w-5 h-5 text-teal-400" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z">
                                        </path>
                                    </svg>
                                </div>
                                Coupon History
                            </h2>
                            <div class="flex items-center gap-2">
                                <select id="admin-coupon-filter" onchange="loadAdminCoupons()"
                                    class="ng-input text-sm py-1.5 px-3">
                                    <option value="all">All Coupons</option>
                                    <option value="active">Active Only</option>
                                    <option value="redeemed">Redeemed Only</option>
                                </select>
                                <button onclick="loadAdminCoupons()"
                                    class="ng-btn-outline text-xs px-3 py-1.5 flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                        </path>
                                    </svg>
                                    Refresh
                                </button>
                            </div>
                        </div>

                        <!-- Stats Cards -->
                        <div class="grid grid-cols-3 gap-3 mb-6">
                            <div class="bg-[var(--ng-bg-card)] rounded-xl p-3 border border-[var(--ng-border)]">
                                <div class="text-xs text-gray-500 uppercase">Total</div>
                                <div class="text-xl font-bold text-white" id="coupon-stat-total">0</div>
                            </div>
                            <div class="bg-[var(--ng-bg-card)] rounded-xl p-3 border border-teal-500/30">
                                <div class="text-xs text-teal-400 uppercase">Active</div>
                                <div class="text-xl font-bold text-teal-400" id="coupon-stat-active">0</div>
                            </div>
                            <div class="bg-[var(--ng-bg-card)] rounded-xl p-3 border border-gray-500/30">
                                <div class="text-xs text-gray-400 uppercase">Redeemed</div>
                                <div class="text-xl font-bold text-gray-400" id="coupon-stat-redeemed">0</div>
                            </div>
                        </div>

                        <!-- Coupons Table -->
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="text-left text-gray-400 border-b border-[var(--ng-border)]">
                                        <th class="pb-3 font-medium">Code</th>
                                        <th class="pb-3 font-medium">Credits</th>
                                        <th class="pb-3 font-medium">Created By</th>
                                        <th class="pb-3 font-medium">Status</th>
                                        <th class="pb-3 font-medium">Used By</th>
                                        <th class="pb-3 font-medium">Date</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-coupons-list" class="divide-y divide-[var(--ng-border)]">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <div id="admin-coupons-empty" class="hidden text-center py-8 text-gray-500">
                            <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z">
                                </path>
                            </svg>
                            <p>No coupons found</p>
                        </div>
                    </div>
                </div><!-- End admin-section-coupons -->

                <!-- Admin Section: Settings -->
                <div id="admin-section-settings" class="admin-section hidden">
                    <div class="ng-card p-4 md:p-6">
                        <h2 class="ng-section-title mb-6">
                            <div class="ng-section-icon ng-section-icon-purple">
                                <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                                    </path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </div>
                            Contact Settings
                        </h2>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="ng-form-label">WhatsApp Link</label>
                                <input type="text" id="admin-whatsapp-link" class="ng-input"
                                    placeholder="https://wa.me/...">
                            </div>
                            <div>
                                <label class="ng-form-label">Telegram Link</label>
                                <input type="text" id="admin-telegram-link" class="ng-input"
                                    placeholder="https://t.me/...">
                            </div>
                        </div>

                        <div class="mt-6 flex justify-end">
                            <button onclick="saveContactSettings()" class="ng-btn-primary">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4">
                                    </path>
                                </svg>
                                Save Settings
                            </button>
                        </div>
                    </div>
                </div>

            </div><!-- End admin-view -->

            <!-- User View -->
            <div id="user-view" class="hidden space-y-6 md:space-y-8">

                <!-- User Inbox Section (Collapsible) -->
                <div id="user-inbox-section" class="ng-card relative group overflow-visible hidden">
                    <div
                        class="absolute inset-0 bg-gradient-to-br from-blue-500/5 to-cyan-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500 rounded-2xl">
                    </div>

                    <!-- Header (Clickable to toggle) -->
                    <div onclick="toggleSection('user-inbox')"
                        class="p-4 md:p-6 cursor-pointer flex items-center justify-between hover:bg-white/5 transition-colors rounded-t-2xl">
                        <h2 class="ng-section-title relative">
                            <div class="ng-section-icon"
                                style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(6, 182, 212, 0.1)); border: 1px solid rgba(59, 130, 246, 0.3);">
                                <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4">
                                    </path>
                                </svg>
                            </div>
                            <span class="text-blue-400">Inbox</span>
                            <span id="inbox-unread-badge" class="ng-badge-pink text-xs hidden">
                                <span id="inbox-unread-count">0</span> new
                            </span>
                        </h2>
                        <svg id="user-inbox-chevron" class="w-5 h-5 text-gray-400 transition-transform duration-300"
                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </div>

                    <!-- Content (Collapsible - starts collapsed) -->
                    <div id="user-inbox-content"
                        class="px-4 md:px-6 pb-4 md:pb-6 overflow-hidden transition-all duration-300"
                        style="max-height: 0; padding-top: 0; padding-bottom: 0;">
                        <div class="flex justify-end mb-4">
                            <button onclick="markAllInboxRead()"
                                class="ng-btn-outline text-xs px-3 py-1.5 flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M5 13l4 4L19 7"></path>
                                </svg>
                                Mark All Read
                            </button>
                        </div>
                        <div id="user-inbox-messages" class="space-y-3">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Buy Credits Section (Collapsible) -->
                <div class="ng-card relative group overflow-visible">
                    <div
                        class="absolute inset-0 bg-gradient-to-br from-amber-500/5 to-pink-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500 rounded-2xl pointer-events-none">
                    </div>

                    <!-- Header (Clickable to toggle) -->
                    <div onclick="toggleSection('buy-credits')"
                        class="p-4 md:p-6 cursor-pointer flex items-center justify-between hover:bg-white/5 transition-colors rounded-t-2xl relative z-10">
                        <h2 class="ng-section-title relative flex-1">
                            <div class="ng-section-icon"
                                style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 0, 87, 0.1)); border: 1px solid rgba(251, 191, 36, 0.3);">
                                <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                    </path>
                                </svg>
                            </div>
                            <span class="text-amber-400">Buy Credits</span>
                            <span class="ng-badge-primary text-xs"> Basic: $<span
                                    id="basic-price-badge">1.70</span></span>
                            <span class="ng-badge-warning text-xs ml-1"> Premium: $<span
                                    id="premium-price-badge">20.00</span></span>
                        </h2>
                        <svg id="buy-credits-chevron"
                            class="w-5 h-5 text-gray-400 transition-transform duration-300 rotate-180" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </div>

                    <!-- Content (Collapsible - starts collapsed) -->
                    <div id="buy-credits-content"
                        class="px-4 md:px-6 pb-4 md:pb-6 overflow-hidden transition-all duration-300 relative z-10"
                        style="max-height: 0; padding-top: 0; padding-bottom: 0;">

                        <!-- Language Selector -->
                        <div class="mb-4 flex items-center justify-end gap-2">
                            <span class="text-xs text-gray-500"></span>
                            <div class="flex gap-1 bg-gray-800/50 p-1 rounded-xl">
                                <button type="button" onclick="event.stopPropagation(); setBuyCreditsLang('en')"
                                    id="lang-btn-en"
                                    class="buy-lang-btn px-3 py-1.5 text-xs font-medium rounded-lg transition-all bg-blue-500/20 text-blue-400 border border-blue-500/50 cursor-pointer">
                                     English
                                </button>
                                <button type="button" onclick="event.stopPropagation(); setBuyCreditsLang('ar')"
                                    id="lang-btn-ar"
                                    class="buy-lang-btn px-3 py-1.5 text-xs font-medium rounded-lg transition-all text-gray-400 hover:bg-white/5 cursor-pointer">
                                     
                                </button>
                                <button type="button" onclick="event.stopPropagation(); setBuyCreditsLang('hi')"
                                    id="lang-btn-hi"
                                    class="buy-lang-btn px-3 py-1.5 text-xs font-medium rounded-lg transition-all text-gray-400 hover:bg-white/5 cursor-pointer">
                                     
                                </button>
                                <button type="button" onclick="event.stopPropagation(); setBuyCreditsLang('id')"
                                    id="lang-btn-id"
                                    class="buy-lang-btn px-3 py-1.5 text-xs font-medium rounded-lg transition-all text-gray-400 hover:bg-white/5 cursor-pointer">
                                     Indonesia
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 relative">

                            <!-- Basic Credits Buy Form -->
                            <div
                                class="ng-card p-4 border-2 border-blue-500/30 hover:border-blue-500/50 transition-colors">
                                <div class="flex items-center gap-2 mb-4">
                                    <div class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center">
                                        <span class="text-lg"></span>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-blue-400" data-i18n="basic_credits">Basic Credits</h3>
                                        <p class="text-xs text-gray-500" data-i18n="basic_desc">For basic regions
                                            (India, BD, etc.)</p>
                                    </div>
                                </div>
                                <div class="ng-form-group">
                                    <label class="ng-form-label text-sm" data-i18n="num_basic">Number of Basic
                                        Credits</label>
                                    <div class="flex items-center gap-1">
                                        <button onclick="adjustBuyCredits('basic', -5)"
                                            class="ng-icon-btn text-xs font-bold px-2">-5</button>
                                        <button onclick="adjustBuyCredits('basic', -1)"
                                            class="ng-icon-btn text-xs font-bold px-2">-1</button>
                                        <input type="number" id="buy-basic-credits-amount" value="0" min="0" max="500"
                                            class="ng-input flex-1 text-center font-bold focus:border-blue-500"
                                            oninput="updateBuyTotal()">
                                        <button onclick="adjustBuyCredits('basic', 1)"
                                            class="ng-icon-btn text-xs font-bold px-2">+1</button>
                                        <button onclick="adjustBuyCredits('basic', 5)"
                                            class="ng-icon-btn text-xs font-bold px-2">+5</button>
                                    </div>
                                </div>
                                <div class="mt-3 p-2 bg-blue-500/10 rounded-lg text-center">
                                    <span class="text-sm text-gray-400">Subtotal: </span>
                                    <span class="font-bold text-blue-400">$<span
                                            id="buy-basic-subtotal">0.00</span></span>
                                </div>
                                <!-- Quick Basic Options -->
                                <div class="grid grid-cols-3 gap-1 mt-3">
                                    <button onclick="quickBuyBasic(5)"
                                        class="text-xs p-2 bg-blue-500/10 rounded hover:bg-blue-500/20 text-blue-300">5
                                        Basic</button>
                                    <button onclick="quickBuyBasic(10)"
                                        class="text-xs p-2 bg-blue-500/10 rounded hover:bg-blue-500/20 text-blue-300">10
                                        Basic</button>
                                    <button onclick="quickBuyBasic(20)"
                                        class="text-xs p-2 bg-blue-500/10 rounded hover:bg-blue-500/20 text-blue-300">20
                                        Basic</button>
                                </div>
                            </div>

                            <!-- Premium Credits Buy Form -->
                            <div
                                class="ng-card p-4 border-2 border-amber-500/30 hover:border-amber-500/50 transition-colors">
                                <div class="flex items-center gap-2 mb-4">
                                    <div class="w-8 h-8 rounded-lg bg-amber-500/20 flex items-center justify-center">
                                        <span class="text-lg"></span>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-amber-400" data-i18n="premium_credits">Premium Credits
                                        </h3>
                                        <p class="text-xs text-gray-500" data-i18n="premium_desc">For premium regions
                                            (ME, BR, etc.)</p>
                                    </div>
                                </div>
                                <div class="ng-form-group">
                                    <label class="ng-form-label text-sm" data-i18n="num_premium">Number of Premium
                                        Credits</label>
                                    <div class="flex items-center gap-1">
                                        <button onclick="adjustBuyCredits('premium', -5)"
                                            class="ng-icon-btn text-xs font-bold px-2">-5</button>
                                        <button onclick="adjustBuyCredits('premium', -1)"
                                            class="ng-icon-btn text-xs font-bold px-2">-1</button>
                                        <input type="number" id="buy-premium-credits-amount" value="0" min="0" max="100"
                                            class="ng-input flex-1 text-center font-bold focus:border-amber-500"
                                            oninput="updateBuyTotal()">
                                        <button onclick="adjustBuyCredits('premium', 1)"
                                            class="ng-icon-btn text-xs font-bold px-2">+1</button>
                                        <button onclick="adjustBuyCredits('premium', 5)"
                                            class="ng-icon-btn text-xs font-bold px-2">+5</button>
                                    </div>
                                </div>
                                <div class="mt-3 p-2 bg-amber-500/10 rounded-lg text-center">
                                    <span class="text-sm text-gray-400" data-i18n="subtotal">Subtotal:</span>
                                    <span class="font-bold text-amber-400">$<span
                                            id="buy-premium-subtotal">0.00</span></span>
                                </div>
                                <!-- Quick Premium Options -->
                                <div class="grid grid-cols-3 gap-1 mt-3">
                                    <button onclick="quickBuyPremium(1)"
                                        class="text-xs p-2 bg-amber-500/10 rounded hover:bg-amber-500/20 text-amber-300">1
                                        Premium</button>
                                    <button onclick="quickBuyPremium(3)"
                                        class="text-xs p-2 bg-amber-500/10 rounded hover:bg-amber-500/20 text-amber-300">3
                                        Premium</button>
                                    <button onclick="quickBuyPremium(5)"
                                        class="text-xs p-2 bg-amber-500/10 rounded hover:bg-amber-500/20 text-amber-300">5
                                        Premium</button>
                                </div>
                            </div>

                            <!-- Order Summary & Checkout -->
                            <div class="space-y-4">
                                <div
                                    class="ng-card p-4 bg-gradient-to-br from-emerald-500/10 to-blue-500/10 border-emerald-500/30">
                                    <h3 class="font-bold text-emerald-400 mb-3 flex items-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4">
                                            </path>
                                        </svg>
                                        <span data-i18n="order_summary">Order Summary</span>
                                    </h3>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-blue-400" data-i18n="basic_credits_label"> Basic
                                                Credits:</span>
                                            <span class="font-bold text-white"><span id="summary-basic-qty">0</span> 
                                                $<span id="summary-basic-price">1.70</span></span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-amber-400" data-i18n="premium_credits_label"> Premium
                                                Credits:</span>
                                            <span class="font-bold text-white"><span id="summary-premium-qty">0</span> 
                                                $<span id="summary-premium-price">20.00</span></span>
                                        </div>
                                        <hr class="border-white/10 my-2">
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-400" data-i18n="total_amount">Total Amount:</span>
                                            <span class="text-2xl font-bold text-emerald-400">$<span
                                                    id="buy-total-amount">0.00</span></span>
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-3" data-i18n="pay_via"> Pay via Binance Pay</p>
                                </div>

                                <!-- Binance Pay ID Display -->
                                <div
                                    class="ng-card p-4 bg-gradient-to-r from-yellow-900/30 to-orange-900/30 border-yellow-700/30">
                                    <h4 class="text-sm font-bold text-yellow-400 mb-2 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z">
                                            </path>
                                        </svg>
                                        <span data-i18n="step1">Step 1: Send Payment</span>
                                    </h4>
                                    <p class="text-xs text-gray-400 mb-2" data-i18n="send_amount">Send the exact amount
                                        to our Binance Pay ID:</p>
                                    <div class="bg-gray-800/80 p-3 rounded-lg flex items-center justify-between">
                                        <span id="checkout-binance-id"
                                            class="font-mono text-lg text-cyan-400 font-bold">Loading...</span>
                                        <button onclick="copyCheckoutBinanceId()"
                                            class="text-gray-400 hover:text-cyan-400 transition-colors p-2 bg-gray-700/50 rounded-lg">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                                                </path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                                <!-- Order ID Input (Required) -->
                                <div
                                    class="ng-card p-4 bg-gradient-to-r from-blue-900/30 to-purple-900/30 border-blue-700/30">
                                    <h4 class="text-sm font-bold text-blue-400 mb-2 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                            </path>
                                        </svg>
                                        <span data-i18n="step2">Step 2: Enter Order ID</span> <span
                                            class="text-red-400">*</span>
                                    </h4>
                                    <p class="text-xs text-gray-400 mb-2" data-i18n="enter_order_id">After payment,
                                        enter your Binance Order ID (found in transaction history):</p>
                                    <input type="text" id="buy-order-id" data-i18n-placeholder="order_placeholder"
                                        placeholder="e.g. 1234567890123456789"
                                        class="w-full bg-gray-800/80 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all"
                                        maxlength="100" required>
                                    <p class="text-xs text-gray-500 mt-1" data-i18n="order_hint"> Open Binance App 
                                        Transactions  Find your payment  Copy Order Number</p>
                                </div>

                                <button id="buy-credits-btn" onclick="initiatePurchase()"
                                    class="w-full ng-btn-success py-3.5 font-semibold flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span data-i18n="submit_btn">Submit Payment Request</span>
                                </button>

                                <!-- Region Info -->
                                <div class="ng-card p-3 text-xs">
                                    <p class="text-gray-400 mb-2" data-i18n="region_types"> Region Credit Types:</p>
                                    <div class="flex flex-wrap gap-1" id="region-tier-info">
                                        <!-- Populated by JS -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transaction History Section (Collapsible) -->
                <div class="ng-card relative overflow-visible">
                    <!-- Header (Clickable to toggle) -->
                    <div onclick="toggleSection('transactions')"
                        class="p-4 md:p-6 cursor-pointer flex items-center justify-between hover:bg-white/5 transition-colors rounded-t-2xl">
                        <h2 class="ng-section-title">
                            <div class="ng-section-icon ng-section-icon-purple">
                                <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01">
                                    </path>
                                </svg>
                            </div>
                            <span class="text-purple-400">Transaction History</span>
                            <span id="tx-count-badge" class="hidden ng-badge-purple text-xs">0</span>
                        </h2>
                        <div class="flex items-center gap-2">
                            <button id="refresh-transactions-btn"
                                onclick="event.stopPropagation(); loadTransactionHistory()"
                                class="ng-btn-outline text-xs px-3 py-1.5 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                    </path>
                                </svg>
                                Refresh
                            </button>
                            <svg id="transactions-chevron"
                                class="w-5 h-5 text-gray-400 transition-transform duration-300 rotate-180" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </div>

                    <!-- Content (Collapsible - starts collapsed) -->
                    <div id="transactions-content"
                        class="px-4 md:px-6 pb-4 md:pb-6 overflow-hidden transition-all duration-300"
                        style="max-height: 0; padding-top: 0; padding-bottom: 0;">
                        <div id="transactions-list" class="space-y-2 max-h-64 overflow-y-auto">
                            <div class="text-center py-8 text-gray-500">
                                <svg class="w-12 h-12 mx-auto mb-3 text-gray-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                                    </path>
                                </svg>
                                <p>No transactions yet</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Coupon System Section (Collapsible) -->
                <div class="ng-card relative overflow-visible">
                    <div
                        class="absolute inset-0 bg-gradient-to-br from-teal-500/5 to-cyan-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500 rounded-2xl pointer-events-none">
                    </div>

                    <!-- Header (Clickable to toggle) -->
                    <div onclick="toggleSection('coupons')"
                        class="p-4 md:p-6 cursor-pointer flex items-center justify-between hover:bg-white/5 transition-colors rounded-t-2xl">
                        <h2 class="ng-section-title">
                            <div class="ng-section-icon"
                                style="background: linear-gradient(135deg, rgba(20, 184, 166, 0.2), rgba(6, 182, 212, 0.1)); border: 1px solid rgba(20, 184, 166, 0.3);">
                                <svg class="w-5 h-5 text-teal-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z">
                                    </path>
                                </svg>
                            </div>
                            <span class="text-teal-400">Gift Coupons</span>
                            <span id="coupons-count-badge" class="hidden ng-badge-teal text-xs">0</span>
                        </h2>
                        <div class="flex items-center gap-2">
                            <button id="refresh-coupons-btn" onclick="event.stopPropagation(); loadMyCoupons()"
                                class="ng-btn-outline text-xs px-3 py-1.5 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                    </path>
                                </svg>
                                Refresh
                            </button>
                            <svg id="coupons-chevron"
                                class="w-5 h-5 text-gray-400 transition-transform duration-300 rotate-180" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </div>

                    <!-- Content (Collapsible - starts collapsed) -->
                    <div id="coupons-content"
                        class="px-4 md:px-6 pb-4 md:pb-6 overflow-hidden transition-all duration-300"
                        style="max-height: 0; padding-top: 0; padding-bottom: 0;">

                        <!-- Redeem & Create Tabs -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">

                            <!-- Redeem Coupon Card -->
                            <div
                                class="ng-card p-4 border border-teal-500/30 hover:border-teal-500/50 transition-colors">
                                <h4 class="font-semibold text-teal-400 mb-3 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7">
                                        </path>
                                    </svg>
                                    Redeem a Coupon
                                </h4>
                                <p class="text-xs text-gray-500 mb-3">Enter a coupon code to receive credits</p>
                                <div class="flex gap-2">
                                    <input type="text" id="redeem-coupon-input" placeholder="XXXX-XXXX-XXXX"
                                        class="flex-1 bg-black/30 border border-gray-700/50 rounded-lg px-3 py-2 text-white text-sm font-mono uppercase tracking-wider focus:border-teal-500/50 focus:ring-1 focus:ring-teal-500/50 outline-none transition-all placeholder-gray-600">
                                    <button onclick="redeemCoupon()" id="redeem-coupon-btn"
                                        class="px-4 py-2 bg-teal-600 hover:bg-teal-500 text-white font-medium rounded-lg transition-colors flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        Redeem
                                    </button>
                                </div>
                            </div>

                            <!-- Create Coupon Card -->
                            <div
                                class="ng-card p-4 border border-cyan-500/30 hover:border-cyan-500/50 transition-colors">
                                <h4 class="font-semibold text-cyan-400 mb-3 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    Create a Coupon
                                </h4>
                                <p class="text-xs text-gray-500 mb-3">Convert your credits into a shareable coupon</p>
                                <div class="grid grid-cols-2 gap-2 mb-3">
                                    <div>
                                        <label class="text-[10px] text-blue-400 uppercase tracking-wide">
                                            Basic</label>
                                        <div class="flex items-center gap-1 mt-1">
                                            <button onclick="adjustCouponCredits('basic', -1)"
                                                class="w-7 h-7 rounded bg-gray-800 hover:bg-gray-700 text-gray-300 font-bold">-</button>
                                            <input type="number" id="coupon-basic-credits" value="0" min="0" max="100"
                                                class="w-12 bg-black/30 border border-gray-700/50 rounded text-center text-white text-sm py-1 focus:border-blue-500/50 outline-none">
                                            <button onclick="adjustCouponCredits('basic', 1)"
                                                class="w-7 h-7 rounded bg-gray-800 hover:bg-gray-700 text-gray-300 font-bold">+</button>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-[10px] text-yellow-400 uppercase tracking-wide">
                                            Premium</label>
                                        <div class="flex items-center gap-1 mt-1">
                                            <button onclick="adjustCouponCredits('premium', -1)"
                                                class="w-7 h-7 rounded bg-gray-800 hover:bg-gray-700 text-gray-300 font-bold">-</button>
                                            <input type="number" id="coupon-premium-credits" value="0" min="0" max="20"
                                                class="w-12 bg-black/30 border border-gray-700/50 rounded text-center text-white text-sm py-1 focus:border-yellow-500/50 outline-none">
                                            <button onclick="adjustCouponCredits('premium', 1)"
                                                class="w-7 h-7 rounded bg-gray-800 hover:bg-gray-700 text-gray-300 font-bold">+</button>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="createCoupon()" id="create-coupon-btn"
                                    class="w-full px-4 py-2 bg-cyan-600 hover:bg-cyan-500 text-white font-medium rounded-lg transition-colors flex items-center justify-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z">
                                        </path>
                                    </svg>
                                    Generate Coupon
                                </button>
                            </div>
                        </div>

                        <!-- My Coupons List -->
                        <div class="border-t border-gray-700/50 pt-4">
                            <h4 class="font-semibold text-gray-300 mb-3 flex items-center gap-2">
                                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                                    </path>
                                </svg>
                                My Generated Coupons
                            </h4>
                            <div id="my-coupons-list" class="space-y-2 max-h-64 overflow-y-auto">
                                <div class="text-center py-6 text-gray-500">
                                    <svg class="w-10 h-10 mx-auto mb-2 text-gray-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z">
                                        </path>
                                    </svg>
                                    <p class="text-sm">No coupons created yet</p>
                                    <p class="text-xs text-gray-600 mt-1">Create a coupon to share credits with others
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Group History Section (Collapsible) -->
                <div class="ng-card relative overflow-visible">
                    <!-- Header (Clickable to toggle) -->
                    <div onclick="toggleSection('history')"
                        class="p-4 md:p-6 cursor-pointer flex items-center justify-between hover:bg-white/5 transition-colors rounded-t-2xl">
                        <h2 class="ng-section-title">
                            <div class="ng-section-icon"
                                style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(251, 191, 36, 0.1)); border: 1px solid rgba(251, 191, 36, 0.3);">
                                <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <span class="text-amber-400">Group History</span>
                            <span id="history-count-badge" class="hidden ng-badge-warning text-xs">0</span>
                        </h2>
                        <div class="flex items-center gap-2">
                            <button id="refresh-history-btn" onclick="event.stopPropagation(); loadGroupHistory()"
                                class="ng-btn-outline text-xs px-3 py-1.5 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                    </path>
                                </svg>
                                Refresh
                            </button>
                            <svg id="history-chevron"
                                class="w-5 h-5 text-gray-400 transition-transform duration-300 rotate-180" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </div>

                    <!-- Content (Collapsible - starts collapsed) -->
                    <div id="history-content"
                        class="px-4 md:px-6 pb-4 md:pb-6 overflow-hidden transition-all duration-300"
                        style="max-height: 0; padding-top: 0; padding-bottom: 0;">
                        <div id="history-list" class="space-y-3 max-h-96 overflow-y-auto">
                            <div class="text-center py-8 text-gray-500">
                                <svg class="w-12 h-12 mx-auto mb-3 text-gray-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <p>No group history yet</p>
                                <p class="text-xs text-gray-600 mt-1">Launch groups to see farming history</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Launch Group -->
                <div class="ng-card p-4 md:p-6 relative group overflow-visible">
                    <div
                        class="absolute inset-0 bg-gradient-to-br from-emerald-500/5 to-pink-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500 rounded-2xl">
                    </div>
                    <h2 class="ng-section-title mb-4 relative">
                        <div class="ng-section-icon"
                            style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1)); border: 1px solid rgba(16, 185, 129, 0.3);">
                            <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                        <span class="text-emerald-400">Launch New Group</span>
                    </h2>
                    <form id="launch-group-form" class="space-y-4 relative">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="ng-form-group">
                                <label class="ng-form-label flex items-center gap-2">
                                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064">
                                        </path>
                                    </svg>
                                    Accounts Region
                                </label>
                                <select name="accounts_file" id="region-select" class="modern-select" required
                                    onchange="updateRegionPrice()">
                                    <option value="" disabled selected>Loading regions...</option>
                                </select>
                                <!-- Price indicator -->
                                <div id="region-price-indicator" class="mt-2 flex items-center gap-2 text-sm">
                                    <span class="text-gray-400">Cost:</span>
                                    <span id="region-credit-cost" class="font-bold text-amber-400">1 Premium
                                        credit</span>
                                    <span class="text-gray-500"></span>
                                    <span id="region-usd-price" class="text-green-400">$20.00</span>
                                </div>
                            </div>
                            <div class="ng-form-group">
                                <label class="ng-form-label flex items-center gap-2">
                                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                                        </path>
                                    </svg>
                                    Clan ID
                                </label>
                                <input type="text" name="clan_id" placeholder="e.g. 123456789"
                                    class="ng-input focus:border-emerald-500" required>
                            </div>
                        </div>
                        <button type="button" id="launch-btn"
                            class="w-full ng-btn-success py-3.5 font-semibold flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            <span id="launch-btn-text">Start Group (1 Premium Credit)</span>
                        </button>
                    </form>
                    <p id="launch-msg" class="mt-3 text-sm text-center"></p>
                </div>

                <!-- My Groups -->
                <div class="ng-card p-4 md:p-6 relative">
                    <!-- Loading overlay for groups -->
                    <div id="groups-loading-overlay" class="loading-overlay">
                        <div class="flex flex-col items-center gap-3">
                            <div class="spinner-lg"></div>
                            <span class="text-sm text-gray-400">Loading groups...</span>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
                        <h2 class="ng-section-title">
                            <div class="ng-section-icon"
                                style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1)); border: 1px solid rgba(59, 130, 246, 0.3);">
                                <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                                    </path>
                                </svg>
                            </div>
                            <span class="text-blue-400">My Active Groups</span>
                            <span id="my-groups-count" class="ng-badge-pink text-xs counter-animate">0</span>
                        </h2>
                        <div class="flex items-center gap-3">
                            <div
                                class="hidden sm:flex items-center gap-2 text-xs text-gray-500 bg-black/30 px-3 py-1.5 rounded-full border border-white/10">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span id="last-refresh-time">--:--</span>
                            </div>
                            <button id="refresh-my-groups"
                                class="ng-btn-primary text-xs px-4 py-2.5 flex items-center gap-2 font-medium">
                                <svg class="w-4 h-4 refresh-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                    </path>
                                </svg>
                                <span>Refresh</span>
                            </button>
                        </div>
                    </div>
                    <div id="my-groups-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    <div id="my-groups-empty" class="hidden text-center py-12">
                        <div
                            class="w-16 h-16 mx-auto mb-4 rounded-full bg-white/5 flex items-center justify-center border border-white/10">
                            <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                                </path>
                            </svg>
                        </div>
                        <p class="text-gray-500 text-sm">No active groups yet</p>
                        <p class="text-gray-600 text-xs mt-1">Launch a new group to get started</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Delete User Confirmation Modal -->
    <div id="delete-user-modal"
        class="fixed inset-0 bg-black/70 hidden flex items-center justify-center z-50 backdrop-blur-md p-4">
        <div
            class="ng-card p-5 md:p-6 max-w-sm w-full transform transition-all scale-100 modal-slide-up border-red-500/20">
            <div class="text-center mb-4">
                <div
                    class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500/10 flex items-center justify-center border border-red-500/30 pulse-glow">
                    <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                        </path>
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Delete User?</h3>
                <p class="text-gray-400 text-sm">Are you sure you want to delete this user? This action cannot be
                    undone.</p>
            </div>
            <div class="bg-black/30 p-4 rounded-xl border border-white/10 mb-6">
                <div class="flex items-center gap-3">
                    <div id="delete-user-avatar"
                        class="w-10 h-10 rounded-full bg-gradient-to-br from-pink-500 to-purple-500 flex items-center justify-center text-white font-bold shadow-lg">
                    </div>
                    <div>
                        <p id="delete-user-name" class="font-semibold text-white"></p>
                        <p id="delete-user-role" class="text-xs text-gray-400"></p>
                    </div>
                </div>
            </div>
            <div class="flex flex-col-reverse sm:flex-row gap-3">
                <button onclick="closeDeleteUserModal()" class="ng-btn-outline flex-1">Cancel</button>
                <button id="confirm-delete-user-btn"
                    class="ng-btn-danger flex-1 flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                        </path>
                    </svg>
                    Delete User
                </button>
            </div>
        </div>
    </div>

    <!-- Cleanup Old Groups Modal -->
    <div id="cleanup-modal"
        class="fixed inset-0 bg-black/70 hidden flex items-center justify-center z-50 backdrop-blur-md p-4">
        <div class="ng-card p-5 md:p-6 rounded-2xl max-w-2xl w-full max-h-[85vh] overflow-auto transform transition-all scale-100 modal-slide-up"
            style="border-color: rgba(239, 68, 68, 0.2);">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-red-400 flex items-center gap-3">
                    <div
                        class="w-10 h-10 rounded-xl bg-red-600/20 flex items-center justify-center border border-red-500/30">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                            </path>
                        </svg>
                    </div>
                    Cleanup Old Groups
                </h3>
                <button onclick="closeCleanupModal()"
                    class="w-8 h-8 rounded-lg bg-gray-800/80 hover:bg-gray-700 text-gray-400 hover:text-white transition-all flex items-center justify-center">&times;</button>
            </div>

            <div
                class="mb-4 text-sm text-yellow-300 bg-yellow-900/20 p-3 rounded-xl border border-yellow-700/30 flex items-start gap-2">
                <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                    </path>
                </svg>
                <span>This will delete all <strong>stopped</strong> groups that are older than <strong>9 hours</strong>.
                    This action cannot be undone!</span>
            </div>

            <div id="cleanup-loading" class="text-center py-8">
                <div
                    class="w-10 h-10 border-2 border-red-500 border-t-transparent rounded-full animate-spin mx-auto mb-3">
                </div>
                <p class="text-gray-400">Scanning for old groups...</p>
            </div>

            <div id="cleanup-content" class="hidden">
                <div id="cleanup-summary"
                    class="bg-[var(--ng-bg-card)] p-4 rounded-xl border border-[var(--ng-border)] mb-4">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-400">Groups found:</span>
                        <span id="cleanup-count" class="text-2xl font-bold text-red-400">0</span>
                    </div>
                </div>

                <div id="cleanup-groups-list" class="max-h-64 overflow-auto space-y-2 mb-4"></div>

                <div id="cleanup-empty" class="hidden text-center py-8">
                    <div
                        class="w-16 h-16 mx-auto mb-4 rounded-full bg-green-900/30 flex items-center justify-center border border-green-500/30">
                        <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <p class="text-green-400 font-semibold">All Clean!</p>
                    <p class="text-gray-500 text-sm mt-1">No old stopped groups found.</p>
                </div>
            </div>

            <div id="cleanup-result" class="hidden mb-4">
                <div class="bg-green-900/20 p-4 rounded-xl border border-green-700/30">
                    <p id="cleanup-result-text" class="text-green-400 font-semibold"></p>
                </div>
            </div>

            <div class="flex flex-col-reverse sm:flex-row gap-3 mt-4">
                <button onclick="closeCleanupModal()"
                    class="flex-1 py-2.5 px-4 ng-btn-outline font-medium">Close</button>
                <button id="cleanup-confirm-btn" onclick="executeCleanup()"
                    class="flex-1 py-2.5 px-4 ng-btn-danger font-semibold flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                        </path>
                    </svg>
                    <span id="cleanup-btn-text">Delete All</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal"
        class="fixed inset-0 bg-black/70 hidden flex items-center justify-center z-50 backdrop-blur-md p-4">
        <div
            class="ng-card p-5 md:p-6 max-w-sm w-full transform transition-all scale-100 modal-slide-up border-emerald-500/20">
            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-3">
                <div
                    class="w-10 h-10 rounded-xl bg-emerald-500/20 flex items-center justify-center border border-emerald-500/30 pulse-glow">
                    <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                Confirm Launch
            </h3>

            <!-- Clan Configuration Steps (Small) -->
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="bg-gray-800/50 rounded p-2 border border-gray-700/50">
                    <div class="text-xs text-emerald-400 mb-1 font-medium text-center">Step 1: Configure</div>
                    <img src="/step1_clan.png" class="w-full rounded border border-gray-700/30">
                </div>
                <div class="bg-gray-800/50 rounded p-2 border border-gray-700/50">
                    <div class="text-xs text-emerald-400 mb-1 font-medium text-center">Step 2: Allow Bots</div>
                    <img src="/step2_clan.png" class="w-full rounded border border-gray-700/30">
                </div>
            </div>

            <div class="space-y-3 text-sm text-gray-300 mb-6">
                <p>Are you sure you want to launch a new group?</p>
                <div class="bg-black/30 p-4 rounded-xl border border-white/10">
                    <div class="flex justify-between items-center"><span class="text-gray-400">Region:</span> <span
                            id="confirm-region" class="font-mono text-pink-400 font-medium"></span></div>
                    <div class="flex justify-between items-center mt-2"><span class="text-gray-400">Clan ID:</span>
                        <span id="confirm-clan" class="font-mono text-purple-400 font-medium"></span>
                    </div>
                    <div class="flex justify-between items-center mt-2 border-t border-white/10 pt-2">
                        <span class="text-gray-400">Cost:</span>
                        <span class="flex items-center gap-2">
                            <span id="confirm-credits" class="text-amber-400 font-bold">12 credits</span>
                            <span class="text-gray-500"></span>
                            <span id="confirm-price" class="text-green-400 font-medium">$20.00</span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="flex flex-col-reverse sm:flex-row gap-3">
                <button onclick="closeConfirmModal()"
                    class="flex-1 py-2.5 px-4 ng-btn-outline font-medium">Cancel</button>
                <button id="confirm-proceed-btn"
                    class="flex-1 py-2.5 px-4 ng-btn-success font-semibold">Proceed</button>
            </div>
        </div>
    </div>

    <!-- Glory Modal -->
    <div id="glory-modal"
        class="fixed inset-0 bg-black/70 hidden flex items-center justify-center z-50 backdrop-blur-md p-4">
        <div class="ng-card p-5 md:p-6 max-w-2xl w-full max-h-[85vh] overflow-auto modal-slide-up border-purple-500/20">
            <div class="flex justify-between items-center mb-4">
                <h3 class="ng-section-title">
                    <div class="ng-section-icon ng-section-icon-purple">
                        <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z">
                            </path>
                        </svg>
                    </div>
                    <span class="text-purple-400">Group Glory</span>
                </h3>
                <button onclick="closeGloryModal()" class="ng-icon-btn">&times;</button>
            </div>
            <div
                class="mb-4 text-sm text-amber-300 bg-amber-500/10 p-3 rounded-xl border border-amber-500/30 flex items-start gap-2">
                <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                    </path>
                </svg>
                <span>Please wait at least 15 minutes after starting the group before seeing glory results.</span>
            </div>
            <div id="glory-content" class="space-y-4"></div>
        </div>
    </div>

    <!-- Refund Modal -->
    <div id="refund-modal"
        class="fixed inset-0 bg-black/70 hidden flex items-center justify-center z-50 backdrop-blur-md p-4">
        <div
            class="ng-card p-5 md:p-6 max-w-sm w-full transform transition-all scale-100 modal-slide-up border-blue-500/20">
            <h3 class="ng-section-title mb-4">
                <div class="ng-section-icon"
                    style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1)); border: 1px solid rgba(59, 130, 246, 0.3);">
                    <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                    </svg>
                </div>
                <span class="text-blue-400">Request Refund</span>
            </h3>

            <!-- Step 1: Info -->
            <div id="refund-step-info">
                <div class="space-y-3 text-sm text-gray-300 mb-6">
                    <p>You can request a refund if:</p>
                    <ul class="list-disc list-inside space-y-1 text-gray-400 ml-2">
                        <li>Group has been running for &gt; 30 mins</li>
                        <li>Total Glory gained is 0</li>
                    </ul>
                    <div class="bg-blue-500/10 p-3 rounded-xl border border-blue-500/30 mt-4">
                        <p class="text-xs text-blue-200">If eligible, the group will be deleted and <span
                                class="font-bold text-white">1 Credit</span> will be returned to your account.</p>
                    </div>
                </div>
                <div class="flex flex-col-reverse sm:flex-row gap-3">
                    <button onclick="closeRefundModal()"
                        class="flex-1 py-2.5 px-4 ng-btn-outline font-medium">Cancel</button>
                    <button id="refund-check-btn" class="flex-1 py-2.5 px-4 ng-btn-primary font-semibold">Check &
                        Refund</button>
                </div>
            </div>

            <!-- Step 2: Result -->
            <div id="refund-step-result" class="hidden text-center">
                <div id="refund-icon"
                    class="mx-auto mb-4 flex items-center justify-center w-16 h-16 rounded-full bg-black/30 text-3xl">
                </div>
                <h4 id="refund-title" class="text-lg font-bold mb-2"></h4>
                <p id="refund-message" class="text-sm text-gray-300 mb-6"></p>

                <div id="refund-credits-change"
                    class="hidden bg-black/30 p-4 rounded-xl border border-white/10 mb-6 space-y-2">
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-blue-400"> Basic Credits</span>
                        <div class="flex items-center gap-2">
                            <span id="refund-old-basic" class="text-gray-500 line-through"></span>
                            <span class="text-gray-400"></span>
                            <span id="refund-new-basic" class="text-green-400 font-bold"></span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-yellow-400"> Premium Credits</span>
                        <div class="flex items-center gap-2">
                            <span id="refund-old-premium" class="text-gray-500 line-through"></span>
                            <span class="text-gray-400"></span>
                            <span id="refund-new-premium" class="text-green-400 font-bold"></span>
                        </div>
                    </div>
                </div>

                <button onclick="closeRefundModal()"
                    class="w-full py-2.5 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-bold transition">Close</button>
            </div>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="message-modal"
        class="fixed inset-0 bg-black/70 hidden flex items-center justify-center z-50 backdrop-blur-md p-4">
        <div
            class="ng-card p-5 md:p-6 rounded-2xl max-w-sm w-full transform transition-all scale-100 text-center modal-slide-up">
            <div id="msg-icon"
                class="mx-auto mb-4 flex items-center justify-center w-16 h-16 rounded-full bg-gray-800/80 text-3xl">
            </div>
            <h3 id="msg-title" class="text-xl font-bold text-white mb-2"></h3>
            <p id="msg-body" class="text-gray-300 mb-6 text-sm"></p>
            <button onclick="closeMessageModal()" class="ng-btn-outline w-full">Close</button>
        </div>
    </div>

    <!-- Buy Credits Payment Modal -->
    <div id="payment-modal"
        class="fixed inset-0 bg-black/70 hidden flex items-center justify-center z-50 backdrop-blur-md p-4">
        <div class="ng-card p-5 md:p-6 rounded-2xl max-w-md w-full modal-slide-up"
            style="border-color: rgba(234, 179, 8, 0.2);">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-yellow-400 flex items-center gap-3">
                    <div
                        class="w-10 h-10 rounded-xl bg-yellow-600/20 flex items-center justify-center border border-yellow-500/30">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z">
                            </path>
                        </svg>
                    </div>
                    Payment Request Created
                </h3>
                <button onclick="closePaymentModal()"
                    class="w-8 h-8 rounded-lg bg-gray-800/80 hover:bg-gray-700 text-gray-400 hover:text-white transition-all flex items-center justify-center">&times;</button>
            </div>

            <div
                class="bg-gradient-to-r from-green-900/30 to-emerald-900/30 p-4 rounded-xl border border-green-700/30 mb-4">
                <div class="text-center">
                    <p class="text-gray-400 text-sm mb-1">Transaction ID</p>
                    <p id="payment-tx-id" class="font-mono text-lg text-green-400 font-bold"></p>
                </div>
            </div>

            <div
                class="bg-gradient-to-r from-yellow-900/30 to-orange-900/30 p-4 rounded-xl border border-yellow-700/30 mb-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-400">Credits:</span>
                    <span id="payment-credits" class="font-bold text-white"></span>
                </div>
                <div class="flex justify-between items-center border-t border-yellow-700/30 pt-2 mt-2">
                    <span class="text-gray-400">Amount to Pay:</span>
                    <span id="payment-amount" class="text-2xl font-bold text-green-400"></span>
                </div>
            </div>

            <div class="space-y-3 mb-4">
                <p class="text-sm text-gray-300 text-center">Send payment to this <span
                        class="text-yellow-400 font-bold">Binance Pay ID</span>:</p>
                <div class="bg-gray-800/80 p-4 rounded-xl border border-gray-700 relative group text-center">
                    <p id="payment-binance-id" class="font-mono text-xl text-cyan-400 font-bold"></p>
                    <button onclick="copyBinancePayId()"
                        class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-cyan-400 transition-colors p-2 bg-gray-700/50 rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="bg-blue-900/20 p-4 rounded-xl border border-blue-700/30 mb-4">
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 rounded-lg bg-blue-600/20 flex items-center justify-center flex-shrink-0">
                        <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-blue-200">
                        <p class="font-semibold mb-1">How to pay:</p>
                        <ol class="list-decimal list-inside text-xs text-blue-300 space-y-1">
                            <li>Open Binance App  Pay  Send</li>
                            <li>Enter the Binance Pay ID above</li>
                            <li>Send the exact amount shown</li>
                            <li>Wait for admin to confirm your payment</li>
                        </ol>
                    </div>
                </div>
            </div>

            <!-- Optional Order ID Field -->
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2 text-gray-300">Binance Order ID <span
                        class="text-gray-500">(optional)</span></label>
                <input type="text" id="payment-order-id" placeholder="Enter your order ID after payment..."
                    class="w-full bg-gray-800/80 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 transition-all"
                    maxlength="100">
                <p class="text-xs text-gray-500 mt-1">Helps admin verify your payment faster</p>
            </div>

            <div class="bg-yellow-900/20 p-3 rounded-xl border border-yellow-700/30 mb-4">
                <p class="text-xs text-yellow-300 flex items-center gap-2">
                    <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>Credits will be added automatically once admin confirms your payment.</span>
                </p>
            </div>

            <button onclick="submitPaymentWithOrderId()"
                class="ng-btn-success w-full flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                I've Sent the Payment
            </button>
        </div>
    </div>

    <script>
        const API = {
            login: '/api/auth/login',
            logout: '/api/auth/logout',
            signup: '/api/auth/signup',
            me: '/api/auth/me',
            adminUsers: '/api/admin/users',
            adminUserAction: '/api/admin/user-action',
            adminGroups: '/api/admin/all-groups',
            adminTransactions: '/api/admin/all-transactions',
            adminConfirmTransaction: '/api/admin/confirm-transaction',
            adminRepairCredits: '/api/admin/repair-credits',
            adminCleanupOldGroups: '/api/admin/cleanup-old-groups',
            adminInvitations: '/api/admin/invitations',
            adminGenerateInvitation: '/api/admin/generate-invitation',
            adminInboxSend: '/api/admin/inbox/send',
            adminInboxMessages: '/api/admin/inbox/messages',
            adminInboxDelete: '/api/admin/inbox/delete',
            inboxMessages: '/api/inbox/messages',
            inboxMarkRead: '/api/inbox/mark-read',
            inboxMarkAllRead: '/api/inbox/mark-all-read',
            inboxDismiss: '/api/inbox/dismiss',
            inboxUnreadCount: '/api/inbox/unread-count',
            clientLaunch: '/api/client/auto-clan-group',
            clientGroups: '/api/client/my-groups',
            clientAction: '/api/client/group-action',
            buyCredits: '/api/client/buy-credits',
            cancelTransaction: '/api/client/cancel-transaction',
            updateTransactionOrderId: '/api/client/update-transaction-order-id',
            transactions: '/api/client/transactions',
            notifications: '/api/client/notifications',
            vapidPublicKey: '/api/push/vapid-public-key',
            pushSubscribe: '/api/push/subscribe',
            pushUnsubscribe: '/api/push/unsubscribe',
            pricing: '/api/pricing',
            // Coupon System
            createCoupon: '/api/client/create-coupon',
            redeemCoupon: '/api/client/redeem-coupon',
            myCoupons: '/api/client/my-coupons',
            cancelCoupon: '/api/client/cancel-coupon'
        };

        let currentUser = null;
        let pendingDeleteUser = null;
        let swRegistration = null;

        // --- Toast Notification ---
        function showToast(message, type = 'success') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                ${type === 'success' ? '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' :
                    type === 'error' ? '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>' :
                        '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>'}
                <span>${message}</span>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // --- Loading Overlay Functions ---
        function showGroupsLoading() {
            const overlay = document.getElementById('groups-loading-overlay');
            if (overlay) {
                overlay.classList.add('show');
            }
        }

        function hideGroupsLoading() {
            const overlay = document.getElementById('groups-loading-overlay');
            if (overlay) {
                overlay.classList.remove('show');
            }
        }

        // --- Toggle Password Visibility ---
        function togglePasswordVisibility(inputId, btn) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path></svg>';
            } else {
                input.type = 'password';
                btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>';
            }
        }

        // --- Refresh Button Animation ---
        function animateRefreshButton(btn) {
            btn.classList.add('spinning');
            btn.disabled = true;
            setTimeout(() => {
                btn.classList.remove('spinning');
                btn.disabled = false;
            }, 800);
        }

        // --- Auth ---
        async function checkAuth() {
            try {
                const res = await fetch(API.me);
                if (res.ok) {
                    currentUser = await res.json();
                    showDashboard();
                } else {
                    showLogin();
                }
            } catch (e) {
                showLogin();
            }
        }

        // Dev mode detection (localhost)
        const isDevMode = window.location.hostname.includes('localhost') || window.location.hostname.includes('127.0.0.1');

        // Turnstile callback functions
        let turnstileToken = isDevMode ? 'dev-mode-bypass' : null;

        function onTurnstileSuccess(token) {
            turnstileToken = token;
            document.getElementById('signup-btn').disabled = false;
        }

        function onTurnstileExpired() {
            turnstileToken = isDevMode ? 'dev-mode-bypass' : null;
            document.getElementById('signup-btn').disabled = !isDevMode;
        }

        // In dev mode, enable signup button immediately
        if (isDevMode) {
            document.addEventListener('DOMContentLoaded', () => {
                const signupBtn = document.getElementById('signup-btn');
                if (signupBtn) signupBtn.disabled = false;
            });
        }

        // Auth tab switching
        function switchAuthTab(tab) {
            const loginTab = document.getElementById('login-tab');
            const signupTab = document.getElementById('signup-tab');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const authTitle = document.getElementById('auth-title');
            const authSubtitle = document.getElementById('auth-subtitle');
            const loginError = document.getElementById('login-error');
            const signupSuccess = document.getElementById('signup-success');

            // Hide error/success messages
            loginError.classList.add('hidden');
            signupSuccess.classList.add('hidden');

            if (tab === 'login') {
                loginTab.className = 'flex-1 py-2.5 px-4 rounded-lg text-sm font-medium transition-all bg-gradient-to-r from-cyan-600 to-blue-600 text-white';
                signupTab.className = 'flex-1 py-2.5 px-4 rounded-lg text-sm font-medium transition-all text-gray-400 hover:text-white';
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
                authTitle.textContent = 'Welcome Back';
                authSubtitle.innerHTML = 'Sign in to <span class="ng-gradient-text font-semibold">FFGlory</span> panel';
            } else {
                signupTab.className = 'flex-1 py-2.5 px-4 rounded-lg text-sm font-medium transition-all bg-gradient-to-r from-green-600 to-emerald-600 text-white';
                loginTab.className = 'flex-1 py-2.5 px-4 rounded-lg text-sm font-medium transition-all text-gray-400 hover:text-white';
                signupForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
                authTitle.textContent = 'Create Account';
                authSubtitle.innerHTML = 'Join <span class="text-green-500 font-semibold">FFGlory</span> panel';
                // Reset turnstile when switching to signup
                if (typeof turnstile !== 'undefined') {
                    turnstile.reset();
                    turnstileToken = null;
                    document.getElementById('signup-btn').disabled = true;
                }
            }
        }

        console.log('[Login] Response status:', res.status);

                if (res.ok) {
                    const body = await res.json();
                    console.log('[Login] Success:', body);
                    currentUser = { username: body.username, role: body.role };
                    checkAuth();
                } else {
                    const errorText = await res.text();
                    console.log('[Login] Error:', errorText);
                    loginError.textContent = errorText || 'Invalid username or password';
                    loginError.classList.remove('hidden');
                }
            } catch (err) {
                console.error('[Login] Exception:', err);
                loginError.textContent = 'Network error. Please check your connection.';
                loginError.classList.remove('hidden');
            } finally {
                loginBtn.disabled = false;
                loginText.textContent = 'Sign In';
            }
        });

        // Signup form - convert username to lowercase on input
        document.getElementById('signup-username').addEventListener('input', function (e) {
            this.value = this.value.toLowerCase().replace(/[^a-z0-9_]/g, '');
        });


                const body = await res.json();

                if (res.ok) {
                    signupSuccess.textContent = 'Account created successfully! You can now sign in.';
                    signupSuccess.classList.remove('hidden');
                    // Clear form
                    document.getElementById('signup-form').reset();
                    // Reset turnstile
                    if (typeof turnstile !== 'undefined') {
                        turnstile.reset();
                    }
                    turnstileToken = null;
                    // Switch to login after 2 seconds
                    setTimeout(() => {
                        switchAuthTab('login');
                    }, 2000);
                } else {
                    loginError.textContent = body.error || 'Signup failed';
                    loginError.classList.remove('hidden');
                    // Reset turnstile on failure
                    if (typeof turnstile !== 'undefined') {
                        turnstile.reset();
                    }
                    turnstileToken = null;
                }
            } catch (err) {
                loginError.textContent = 'Network error. Please try again.';
                loginError.classList.remove('hidden');
            }

            signupBtn.disabled = !turnstileToken;
            document.getElementById('signup-text').textContent = 'Create Account';
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await fetch(API.logout);
            location.reload();
        });

        document.getElementById('logout-btn-desktop').addEventListener('click', async () => {
            await fetch(API.logout);
            location.reload();
        });

        // --- UI Switching ---
        function showLogin() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('dashboard-screen').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard-screen').classList.remove('hidden');

            // Load pricing whenever dashboard is shown
            if (typeof loadPricing === 'function') loadPricing();

            document.getElementById('user-badge').textContent = `${currentUser.username} (${currentUser.role})`;

            if (currentUser.role === 'admin') {
                document.getElementById('admin-view').classList.remove('hidden');
                document.getElementById('user-view').classList.add('hidden');
                loadAdminData();
            } else {
                document.getElementById('admin-view').classList.add('hidden');
                document.getElementById('user-view').classList.remove('hidden');
                // Show both credit badges
                document.getElementById('basic-credits-badge').classList.remove('hidden');
                document.getElementById('premium-credits-badge').classList.remove('hidden');
                // Update credit values
                document.getElementById('basic-credits-val').textContent = currentUser.basic_credits || 0;
                document.getElementById('premium-credits-val').textContent = currentUser.premium_credits || 0;
                loadUserData();
            }
        }

        // --- Admin Tab Navigation ---
        let currentAdminTab = 'users';

        function switchAdminTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('admin-tab-active');
            });
            document.getElementById(`admin-tab-${tabName}`).classList.add('admin-tab-active');

            // Update sections
            document.querySelectorAll('.admin-section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(`admin-section-${tabName}`).classList.remove('hidden');

            currentAdminTab = tabName;

            // Load data for the section if needed
            if (tabName === 'users') loadUsersList();
            else if (tabName === 'invitations') loadInvitations();
            else if (tabName === 'groups') loadAdminGroups();
            else if (tabName === 'transactions') loadAdminTransactions();
            else if (tabName === 'pricing') loadAdminPricing();
            else if (tabName === 'history') loadHistory();
            else if (tabName === 'inbox') loadAdminBroadcasts();
            else if (tabName === 'settings') loadContactSettings();
        }

        // --- Contact Settings ---
        async function loadContactSettings() {
            try {
                const response = await fetch('/api/admin/contact-settings');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('admin-whatsapp-link').value = data.whatsapp || '';
                    document.getElementById('admin-telegram-link').value = data.telegram || '';
                }
            } catch (error) {
                console.error('Error loading contact settings:', error);
            }
        }

        async function saveContactSettings() {
            const whatsapp = document.getElementById('admin-whatsapp-link').value;
            const telegram = document.getElementById('admin-telegram-link').value;

            try {
                const response = await fetch('/api/admin/contact-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ whatsapp, telegram })
                });

                if (response.ok) {
                    showToast('Contact settings saved successfully', 'success');
                    updateContactLinks(whatsapp, telegram);
                } else {
                    showToast('Failed to save settings', 'error');
                }
            } catch (error) {
                console.error('Error saving contact settings:', error);
                showToast('Error saving settings', 'error');
            }
        }

        async function fetchPublicContactInfo() {
            try {
                const response = await fetch('/api/public/contact-info');
                if (response.ok) {
                    const data = await response.json();
                    updateContactLinks(data.whatsapp, data.telegram);
                }
            } catch (error) {
                console.error('Error fetching contact info:', error);
            }
        }

        function updateContactLinks(whatsapp, telegram) {
            // Update links in the UI
            const waLinks = document.querySelectorAll('a[href*="wa.me"]');
            waLinks.forEach(link => {
                if (whatsapp) link.href = whatsapp;
            });

            const tgLinks = document.querySelectorAll('a[href*="t.me"]');
            tgLinks.forEach(link => {
                if (telegram) link.href = telegram;
            });
        }

        // --- User Search and Sort ---
        let allUsersData = [];
        let userSortAscending = true;
        let userSearchTimeout = null;
        let totalUsersCount = 0;

        function toggleUserSortOrder() {
            userSortAscending = !userSortAscending;
            document.getElementById('user-sort-icon-asc').classList.toggle('hidden', !userSortAscending);
            document.getElementById('user-sort-icon-desc').classList.toggle('hidden', userSortAscending);
            filterAndSortUsers();
        }

        // Debounce search to avoid too many API calls
        function debounceUserSearch() {
            if (userSearchTimeout) clearTimeout(userSearchTimeout);
            userSearchTimeout = setTimeout(() => {
                const searchTerm = document.getElementById('user-search-input').value.trim();
                if (searchTerm.length >= 2 || searchTerm.length === 0) {
                    searchUsersFromServer(searchTerm);
                }
            }, 300);
        }

        // Search users from server (efficient MongoDB query)
        async function searchUsersFromServer(query) {
            const spinner = document.getElementById('user-search-spinner');
            spinner?.classList.remove('hidden');

            try {
                const url = query
                    ? `${API.adminUsers}?search=${encodeURIComponent(query)}&limit=100`
                    : `${API.adminUsers}?limit=100`;
                const res = await fetch(url);
                const data = await res.json();

                // Handle new response format
                allUsersData = data.users || data;
                totalUsersCount = data.total_count || allUsersData.length;

                // Update counts
                updateUserCounts();

                // Apply local sorting
                filterAndSortUsers();
            } catch (e) {
                console.error('Failed to search users:', e);
            } finally {
                spinner?.classList.add('hidden');
            }
        }

        function updateUserCounts() {
            const countBadge = document.getElementById('users-count-badge');
            if (countBadge) {
                const showing = allUsersData.length;
                if (totalUsersCount > showing) {
                    countBadge.textContent = `${showing} of ${totalUsersCount}`;
                } else {
                    countBadge.textContent = `${showing} user${showing !== 1 ? 's' : ''}`;
                }
            }
            const tabBadge = document.getElementById('admin-tab-users-badge');
            if (tabBadge) {
                tabBadge.textContent = totalUsersCount;
            }
        }

        function filterAndSortUsers() {
            const searchTerm = document.getElementById('user-search-input').value.toLowerCase().trim();
            const sortField = document.getElementById('user-sort-field').value;

            // If we have server-side search data, just sort locally
            let filteredUsers = allUsersData;

            filteredUsers.sort((a, b) => {
                let valA, valB;
                if (sortField === 'username') {
                    valA = a.username.toLowerCase();
                    valB = b.username.toLowerCase();
                } else if (sortField === 'role') {
                    valA = a.role;
                    valB = b.role;
                } else if (sortField === 'credits') {
                    valA = (a.basic_credits || 0) + (a.premium_credits || 0);
                    valB = (b.basic_credits || 0) + (b.premium_credits || 0);
                } else if (sortField === 'max_groups') {
                    valA = a.max_groups;
                    valB = b.max_groups;
                }

                if (typeof valA === 'string') {
                    return userSortAscending ? valA.localeCompare(valB) : valB.localeCompare(valA);
                } else {
                    return userSortAscending ? valA - valB : valB - valA;
                }
            });

            // Update filter status
            const shown = filteredUsers.length;
            const total = totalUsersCount;
            const statusText = searchTerm
                ? `Found ${shown} users matching "${searchTerm}"`
                : (total > shown ? `Showing top ${shown} of ${total} users` : `Showing all ${total} users`);
            document.getElementById('user-filter-status').textContent = statusText;

            renderUsersTable(filteredUsers);
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('users-table-body');
            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(u => `
                <tr class="border-b border-[var(--ng-border)] hover:bg-white/5 transition-colors user-row" data-username="${u.username}">
                    <td class="p-2 md:p-3">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br ${u.role === 'admin' ? 'from-[var(--ng-purple)] to-[var(--ng-pink)]' : 'from-[var(--ng-pink)] to-[var(--ng-purple)]'} flex items-center justify-center text-white font-bold text-sm shadow-lg">
                                ${u.username.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <span class="font-semibold text-[var(--ng-text)] block">${u.username}</span>
                                <span class="text-xs text-[var(--ng-text-muted)]">${u.created_groups ? u.created_groups.length : 0} groups created</span>
                            </div>
                        </div>
                    </td>
                    <td class="p-2 md:p-3">
                        <div class="flex items-center gap-2">
                            <code class="text-xs text-[var(--ng-text-muted)] bg-[var(--ng-bg-dark)] px-2.5 py-1.5 rounded-lg font-mono border border-[var(--ng-border)]">${u.plain_password || ''}</code>
                            <button onclick="copyToClipboard('${u.plain_password || ''}')" class="text-[var(--ng-text-muted)] hover:text-[var(--ng-pink)] transition-colors" title="Copy password">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                            </button>
                        </div>
                    </td>
                    <td class="p-2 md:p-3">
                        <span class="${u.role === 'admin' ? 'ng-badge-purple' : 'ng-badge-default'}">
                            ${u.role === 'admin' ? ' ' : ' '}${u.role}
                        </span>
                    </td>
                    <td class="p-2 md:p-3">
                        <div class="space-y-1.5">
                            <!-- Basic Credits -->
                            <div class="flex items-center gap-1">
                                <span class="text-xs text-blue-400 w-12"> Basic</span>
                                <div class="inline-flex items-center gap-1 bg-[var(--ng-bg-dark)] rounded border border-blue-500/30 p-0.5">
                                    <button onclick="adjustBasicCredits('${u.username}', ${u.basic_credits || 0}, -1)" class="w-5 h-5 rounded bg-[var(--ng-bg-card)] hover:bg-red-600/30 text-[var(--ng-text-muted)] hover:text-red-400 transition-colors flex items-center justify-center text-xs font-bold"></button>
                                    <input type="number" value="${u.basic_credits || 0}" id="basic-credits-${u.username}" class="bg-transparent w-10 px-0.5 py-0.5 text-center text-xs focus:outline-none text-blue-400 font-semibold" 
                                        onchange="updateUserField('${u.username}', 'update_basic_credits', this.value)">
                                    <button onclick="adjustBasicCredits('${u.username}', ${u.basic_credits || 0}, 1)" class="w-5 h-5 rounded bg-[var(--ng-bg-card)] hover:bg-green-600/30 text-[var(--ng-text-muted)] hover:text-green-400 transition-colors flex items-center justify-center text-xs font-bold">+</button>
                                </div>
                            </div>
                            <!-- Premium Credits -->
                            <div class="flex items-center gap-1">
                                <span class="text-xs text-amber-400 w-12"> Premium</span>
                                <div class="inline-flex items-center gap-1 bg-[var(--ng-bg-dark)] rounded border border-amber-500/30 p-0.5">
                                    <button onclick="adjustPremiumCredits('${u.username}', ${u.premium_credits || 0}, -1)" class="w-5 h-5 rounded bg-[var(--ng-bg-card)] hover:bg-red-600/30 text-[var(--ng-text-muted)] hover:text-red-400 transition-colors flex items-center justify-center text-xs font-bold"></button>
                                    <input type="number" value="${u.premium_credits || 0}" id="premium-credits-${u.username}" class="bg-transparent w-10 px-0.5 py-0.5 text-center text-xs focus:outline-none text-amber-400 font-semibold" 
                                        onchange="updateUserField('${u.username}', 'update_premium_credits', this.value)">
                                    <button onclick="adjustPremiumCredits('${u.username}', ${u.premium_credits || 0}, 1)" class="w-5 h-5 rounded bg-[var(--ng-bg-card)] hover:bg-green-600/30 text-[var(--ng-text-muted)] hover:text-green-400 transition-colors flex items-center justify-center text-xs font-bold">+</button>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="p-2 md:p-3 text-center">
                        <div class="inline-flex items-center gap-1 bg-[var(--ng-bg-dark)] rounded-lg border border-[var(--ng-border)] p-1">
                            <button onclick="adjustMaxGroups('${u.username}', ${u.max_groups}, -1)" class="w-6 h-6 rounded bg-[var(--ng-bg-card)] hover:bg-red-600/30 text-[var(--ng-text-muted)] hover:text-red-400 transition-colors flex items-center justify-center text-sm font-bold"></button>
                            <input type="number" value="${u.max_groups}" id="maxgroups-${u.username}" class="bg-transparent w-14 px-1 py-1 text-center text-sm focus:outline-none text-blue-400 font-semibold" 
                                onchange="updateUserField('${u.username}', 'update_max_groups', this.value)">
                            <button onclick="adjustMaxGroups('${u.username}', ${u.max_groups}, 1)" class="w-6 h-6 rounded bg-[var(--ng-bg-card)] hover:bg-green-600/30 text-[var(--ng-text-muted)] hover:text-green-400 transition-colors flex items-center justify-center text-sm font-bold">+</button>
                        </div>
                    </td>
                    <td class="p-2 md:p-3">
                        <div class="flex items-center justify-end gap-2">
                            <button onclick="openResetPasswordModal('${u.username}')" class="ng-btn-warning text-xs py-2 px-3 flex items-center gap-1.5">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                                </svg>
                                Reset
                            </button>
                            <button onclick="confirmDeleteUser('${u.username}', '${u.role}')" class="ng-btn-danger text-xs py-2 px-3 flex items-center gap-1.5">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Adjust basic credits with +/- buttons
        function adjustBasicCredits(username, currentVal, delta) {
            const newVal = Math.max(0, currentVal + delta);
            const input = document.getElementById(`basic-credits-${username}`);
            if (input) {
                input.value = newVal;
                input.classList.add('credits-pulse');
                setTimeout(() => input.classList.remove('credits-pulse'), 500);
            }
            updateUserField(username, 'update_basic_credits', newVal);
        }

        // Adjust premium credits with +/- buttons
        function adjustPremiumCredits(username, currentVal, delta) {
            const newVal = Math.max(0, currentVal + delta);
            const input = document.getElementById(`premium-credits-${username}`);
            if (input) {
                input.value = newVal;
                input.classList.add('credits-pulse');
                setTimeout(() => input.classList.remove('credits-pulse'), 500);
            }
            updateUserField(username, 'update_premium_credits', newVal);
        }

        // --- Admin Logic ---
        async function loadAdminData() {
            loadUsersList();
            loadAdminGroups();
            loadAdminTransactions();
            loadInvitations();
            loadAdminCoupons();
        }

        async function loadAdminTransactions() {
            try {
                const res = await fetch(API.adminTransactions);
                if (!res.ok) return;

                const txs = await res.json();
                const tbody = document.getElementById('admin-transactions-body');
                if (!tbody) return;

                // Count pending transactions
                const pendingCount = txs.filter(tx => tx.status === 'pending').length;
                const badge = document.getElementById('pending-tx-badge');
                if (badge) {
                    if (pendingCount > 0) {
                        badge.textContent = `${pendingCount} Pending`;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }

                // Update tab badge
                const tabBadge = document.getElementById('admin-tab-transactions-badge');
                if (tabBadge) {
                    if (pendingCount > 0) {
                        tabBadge.textContent = pendingCount;
                        tabBadge.classList.remove('hidden');
                    } else {
                        tabBadge.classList.add('hidden');
                    }
                }

                if (!txs || txs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-500">No transactions found</td></tr>';
                    return;
                }

                tbody.innerHTML = txs.map(tx => {
                    let statusClass = 'bg-gray-700 text-gray-300';
                    let statusText = tx.status;

                    if (tx.status === 'completed' || tx.status === 'approved') {
                        statusClass = 'bg-green-500/20 text-green-400 border border-green-500/30';
                        statusText = ' ' + (tx.status === 'approved' ? 'Approved' : 'Completed');
                    } else if (tx.status === 'failed') {
                        statusClass = 'bg-red-500/20 text-red-400 border border-red-500/30';
                        statusText = ' Failed';
                    } else if (tx.status === 'cancelled') {
                        statusClass = 'bg-gray-500/20 text-gray-400 border border-gray-500/30';
                        statusText = ' Cancelled';
                    } else if (tx.status === 'pending') {
                        statusClass = 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30 animate-pulse';
                        statusText = ' Pending';
                    }

                    const date = new Date(tx.created_at).toLocaleString();
                    const canModify = tx.status === 'pending';

                    // Build credits display for two-tier system
                    let creditsDisplay = [];
                    const basicGranted = tx.basic_credits_granted || 0;
                    const premiumGranted = tx.premium_credits_granted || 0;
                    const basicRequested = tx.basic_credits || 0;
                    const premiumRequested = tx.premium_credits || 0;

                    // Use granted if completed/approved, otherwise requested
                    const isApproved = tx.status === 'completed' || tx.status === 'approved';
                    const basicShow = isApproved ? basicGranted : basicRequested;
                    const premiumShow = isApproved ? premiumGranted : premiumRequested;

                    let creditsHtml = '';
                    if (basicRequested > 0 || basicGranted > 0) {
                        if (isApproved && basicGranted !== basicRequested) {
                            creditsHtml += `<div class="text-blue-400 text-xs"> ${basicGranted} <span class="text-gray-500">(req: ${basicRequested})</span></div>`;
                        } else {
                            creditsHtml += `<div class="text-blue-400 text-xs"> ${basicShow} Basic</div>`;
                        }
                    }
                    if (premiumRequested > 0 || premiumGranted > 0) {
                        if (isApproved && premiumGranted !== premiumRequested) {
                            creditsHtml += `<div class="text-amber-400 text-xs"> ${premiumGranted} <span class="text-gray-500">(req: ${premiumRequested})</span></div>`;
                        } else {
                            creditsHtml += `<div class="text-amber-400 text-xs"> ${premiumShow} Premium</div>`;
                        }
                    }
                    if (!creditsHtml) creditsHtml = '<div class="text-gray-500 text-xs">-</div>';

                    // Build old/new balance display for completed/approved transactions
                    let balanceChangeHtml = '';
                    if ((tx.status === 'completed' || tx.status === 'approved') && (tx.old_basic_credits !== undefined || tx.old_premium_credits !== undefined)) {
                        const oldBasic = tx.old_basic_credits || 0;
                        const oldPremium = tx.old_premium_credits || 0;
                        const newBasic = tx.new_basic_credits || 0;
                        const newPremium = tx.new_premium_credits || 0;

                        // Only show if there was actual change (not legacy tx with no data)
                        const hasData = (newBasic > oldBasic) || (newPremium > oldPremium) || (basicGranted > 0 && newBasic > 0) || (premiumGranted > 0 && newPremium > 0);

                        if (hasData) {
                            balanceChangeHtml = `
                                <div class="mt-1 pt-1 border-t border-gray-700/50 text-[9px]">
                                    <span class="text-gray-500">Balance:</span>
                                    <span class="text-blue-400">${oldBasic}${newBasic}</span>
                                    <span class="text-amber-400 ml-1">${oldPremium}${newPremium}</span>
                                </div>
                            `;
                        }
                    }


                    return `
                        <tr class="border-b border-[var(--ng-border)] hover:bg-white/5 transition-colors" data-tx-id="${tx.id}">
                            <td class="p-2 md:p-3 text-[var(--ng-text-muted)] whitespace-nowrap">${date}</td>
                            <td class="p-2 md:p-3 font-bold text-[var(--ng-text)]">${tx.username}</td>
                            <td class="p-2 md:p-3 font-mono text-[var(--ng-text-muted)] text-[10px]">
                                ${tx.id}
                                ${tx.order_id ? `<br><span class="text-[var(--ng-pink)]"> ${tx.order_id}</span>` : ''}
                            </td>
                            <td class="p-2 md:p-3 text-center">${creditsHtml}</td>
                            <td class="p-2 md:p-3 text-center text-yellow-400 font-bold">$${tx.amount.toFixed(2)}</td>
                            <td class="p-2 md:p-3 text-center">
                                <span class="text-[10px] px-2 py-1 rounded-full ${statusClass}">${statusText}</span>
                                ${tx.admin_note ? `<p class="text-[9px] text-[var(--ng-text-muted)] mt-1 italic">${tx.admin_note}</p>` : ''}
                                ${balanceChangeHtml}
                            </td>
                            <td class="p-2 md:p-3">
                                <div class="flex items-center justify-end gap-2">
                                    ${canModify ? `
                                        <button onclick="adminApproveTransaction('${tx.id}', ${basicRequested}, ${premiumRequested})" class="ng-btn-success text-xs py-1.5 px-2.5 flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                            Approve
                                        </button>
                                        <button onclick="adminCustomApprove('${tx.id}', ${basicRequested}, ${premiumRequested})" class="ng-btn-outline text-xs py-1.5 px-2.5 flex items-center gap-1" style="color: #60a5fa; border-color: rgba(96, 165, 250, 0.3);">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                            Custom
                                        </button>
                                        <button onclick="adminRejectTransaction('${tx.id}')" class="ng-btn-danger text-xs py-1.5 px-2.5 flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                            Reject
                                        </button>
                                    ` : '<span class="text-[var(--ng-text-muted)] text-[10px]">-</span>'}
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (e) {
                console.error('Failed to load admin transactions:', e);
            }
        }

        async function adminApproveTransaction(txId, basicCredits, premiumCredits) {
            let confirmMsg = 'Approve this transaction and add ';
            let parts = [];
            if (basicCredits > 0) parts.push(`${basicCredits} Basic`);
            if (premiumCredits > 0) parts.push(`${premiumCredits} Premium`);
            confirmMsg += parts.join(' + ') + ' credits to user?';

            if (!confirm(confirmMsg)) return;

            try {
                const res = await fetch(API.adminConfirmTransaction, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ transaction_id: txId, action: 'approve' })
                });

                if (res.ok) {
                    showToast('Transaction approved! Credits added.', 'success');
                    loadAdminTransactions();
                    loadUsersList();
                } else {
                    const err = await res.text();
                    showToast('Error: ' + err, 'error');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }

        async function adminCustomApprove(txId, defaultBasicCredits, defaultPremiumCredits) {
            const basicInput = prompt(`Enter Basic credits to grant (requested: ${defaultBasicCredits}):`, defaultBasicCredits);
            if (basicInput === null) return;

            const premiumInput = prompt(`Enter Premium credits to grant (requested: ${defaultPremiumCredits}):`, defaultPremiumCredits);
            if (premiumInput === null) return;

            const basicCredits = parseInt(basicInput);
            const premiumCredits = parseInt(premiumInput);

            if (isNaN(basicCredits) || isNaN(premiumCredits) || basicCredits < 0 || premiumCredits < 0) {
                showToast('Please enter valid non-negative credit amounts', 'error');
                return;
            }

            const note = prompt('Optional note for this transaction:', '');

            try {
                // Use -1 to indicate "use original value", any value >= 0 is the custom amount
                const res = await fetch(API.adminConfirmTransaction, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        transaction_id: txId,
                        action: 'approve',
                        custom_basic_credits: basicCredits,
                        custom_premium_credits: premiumCredits,
                        use_custom_credits: true,
                        admin_note: note || ''
                    })
                });

                let creditsStr = [];
                if (basicCredits > 0) creditsStr.push(`${basicCredits} Basic`);
                if (premiumCredits > 0) creditsStr.push(`${premiumCredits} Premium`);

                if (res.ok) {
                    showToast(`Transaction approved with ${creditsStr.join(' + ')} credits!`, 'success');
                    loadAdminTransactions();
                    loadUsersList();
                } else {
                    const err = await res.text();
                    showToast('Error: ' + err, 'error');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }

        async function adminRejectTransaction(txId) {
            const note = prompt('Rejection reason (optional):', '');
            if (!confirm('Reject this transaction?')) return;

            try {
                const res = await fetch(API.adminConfirmTransaction, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        transaction_id: txId,
                        action: 'reject',
                        admin_note: note || ''
                    })
                });

                if (res.ok) {
                    showToast('Transaction rejected.', 'warning');
                    loadAdminTransactions();
                } else {
                    const err = await res.text();
                    showToast('Error: ' + err, 'error');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }

        // --- Repair Missing Credits ---
        async function repairMissingCredits() {
            try {
                // First do a dry run to see what needs to be repaired
                const dryRes = await fetch(API.adminRepairCredits, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dry_run: true })
                });

                if (!dryRes.ok) {
                    showToast('Error checking repairs', 'error');
                    return;
                }

                const data = await dryRes.json();

                if (data.affected_transactions === 0) {
                    showToast('No transactions need repair!', 'success');
                    return;
                }

                // Show confirmation with details
                const confirmMsg = `Found ${data.affected_transactions} transactions that were approved but credits weren't granted!\n\n` +
                    `Total credits to restore:\n` +
                    ` Basic: ${data.total_basic_credits}\n` +
                    ` Premium: ${data.total_premium_credits}\n\n` +
                    `Do you want to repair all of them now?`;

                if (!confirm(confirmMsg)) {
                    return;
                }

                // Now do the actual repair
                const repairRes = await fetch(API.adminRepairCredits, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dry_run: false })
                });

                if (!repairRes.ok) {
                    showToast('Error repairing credits', 'error');
                    return;
                }

                const result = await repairRes.json();
                showToast(` Repaired ${result.repaired_count} transactions! Granted ${result.total_basic_credits} basic + ${result.total_premium_credits} premium credits.`, 'success');
                loadAdminTransactions();

            } catch (e) {
                console.error('Repair error:', e);
                showToast('Network error', 'error');
            }
        }

        // --- Admin Pricing Management ---
        async function loadAdminPricing() {
            try {
                const res = await fetch('/api/admin/pricing');
                if (!res.ok) return;

                const config = await res.json();
                const container = document.getElementById('admin-pricing-list');
                if (!container) return;

                // Update credit prices in inputs
                const basicPriceInput = document.getElementById('admin-basic-price');
                const premiumPriceInput = document.getElementById('admin-premium-price');
                if (basicPriceInput) basicPriceInput.value = (config.basic_price || 1.70).toFixed(2);
                if (premiumPriceInput) premiumPriceInput.value = (config.premium_price || 20.00).toFixed(2);

                const regionEmojis = {
                    'accounts_br.txt': '',      // Brazil
                    'accounts_me.txt': '',      // Middle East (Saudi Arabia as representative)
                    'accounts_ghrab.txt': '',   // Middle East Ghrab (UAE)
                    'accounts_bd.txt': '',      // Bangladesh
                    'accounts.txt': '',         // India
                    'accounts_pk.txt': '',      // Pakistan
                    'accounts_eu.txt': '',      // Europe
                    'accounts_indo.txt': '',    // Indonesia
                    'accounts_na.txt': '',      // North America (USA)
                    'accounts_ru.txt': '',      // Russia
                    'accounts_sg.txt': '',      // Singapore
                    'accounts_th.txt': '',      // Thailand
                    'accounts_vn.txt': '',      // Vietnam
                    'accounts_ph.txt': '',      // Philippines
                    'accounts_my.txt': '',      // Malaysia
                    'accounts_jp.txt': '',      // Japan
                    'accounts_kr.txt': '',      // South Korea
                    'accounts_tw.txt': '',      // Taiwan
                    'accounts_latam.txt': '',    // Latin America
                    'accounts_africa.txt': ''    // Africa
                };

                let html = '';
                for (const [region, regionConfig] of Object.entries(config.regions || {})) {
                    const emoji = regionEmojis[regionConfig.accounts_file] || '';
                    const isPremium = regionConfig.tier === 'premium';
                    const tierClass = isPremium ? 'bg-amber-500/20 text-amber-400 border-amber-500/30' : 'bg-blue-500/20 text-blue-400 border-blue-500/30';
                    const tierIcon = isPremium ? '' : '';
                    const tierText = isPremium ? 'Premium' : 'Basic';
                    const enabledClass = regionConfig.enabled !== false ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400';
                    const enabledText = regionConfig.enabled !== false ? 'Enabled' : 'Disabled';

                    html += `
                        <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700/50 hover:border-${isPremium ? 'amber' : 'blue'}-500/30 transition-colors">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">${emoji}</span>
                                    <div>
                                        <p class="font-bold text-white">${region}</p>
                                        <p class="text-xs text-gray-500 font-mono">${regionConfig.accounts_file || 'N/A'}</p>
                                    </div>
                                    <span class="text-xs px-2 py-1 rounded-full border ${tierClass}">${tierIcon} ${tierText}</span>
                                    <span class="text-xs px-2 py-1 rounded-full ${enabledClass}">${enabledText}</span>
                                </div>
                                <div class="flex items-center gap-2 flex-wrap">
                                    <select onchange="updateRegionTier('${regionConfig.accounts_file}', this.value)" class="ng-input text-xs py-1 px-2">
                                        <option value="basic" ${!isPremium ? 'selected' : ''}> Basic</option>
                                        <option value="premium" ${isPremium ? 'selected' : ''}> Premium</option>
                                    </select>
                                    <button onclick="toggleRegionEnabled('${regionConfig.accounts_file}', ${regionConfig.enabled !== false})" class="ng-btn-outline text-xs py-1.5 px-2 flex items-center gap-1" title="${regionConfig.enabled !== false ? 'Disable' : 'Enable'}">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${regionConfig.enabled !== false ? 'M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636' : 'M5 13l4 4L19 7'}"></path></svg>
                                        ${regionConfig.enabled !== false ? 'Disable' : 'Enable'}
                                    </button>
                                    <button onclick="deleteRegion('${regionConfig.accounts_file}')" class="ng-btn-danger text-xs py-1.5 px-2 flex items-center gap-1" title="Delete Region">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }

                container.innerHTML = html || '<p class="text-gray-500 text-center py-4">No regions configured</p>';
            } catch (e) {
                console.error('Failed to load admin pricing:', e);
            }
        }

        async function updateCreditPrice(tier) {
            const input = document.getElementById(`admin-${tier}-price`);
            const price = parseFloat(input?.value) || 0;

            if (price <= 0) {
                showToast('Price must be greater than 0', 'error');
                return;
            }

            try {
                const res = await fetch('/api/admin/update-credit-prices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tier, price })
                });

                if (res.ok) {
                    showToast(`${tier.charAt(0).toUpperCase() + tier.slice(1)} credit price updated!`, 'success');
                    loadCreditPrices(); // Refresh client-side prices
                } else {
                    const err = await res.text();
                    showToast('Error: ' + err, 'error');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }

        async function updateRegionTier(region, tier) {
            try {
                const res = await fetch('/api/admin/update-region-tier', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accounts_file: region, tier })
                });

                if (res.ok) {
                    showToast(`${region} tier updated to ${tier}!`, 'success');
                    loadAdminPricing();
                    loadCreditPrices();
                } else {
                    const err = await res.text();
                    showToast('Error: ' + err, 'error');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }

        async function toggleRegionEnabled(region, currentlyEnabled) {
            try {
                const res = await fetch('/api/admin/update-region-tier', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accounts_file: region, enabled: !currentlyEnabled })
                });

                if (res.ok) {
                    showToast(`${region} ${!currentlyEnabled ? 'enabled' : 'disabled'}!`, 'success');
                    loadAdminPricing();
                } else {
                    const err = await res.text();
                    showToast('Error: ' + err, 'error');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }

        async function addNewRegion() {
            const name = document.getElementById('new-region-name')?.value.trim();
            const file = document.getElementById('new-region-file')?.value.trim();
            const tier = document.getElementById('new-region-tier')?.value;

            if (!name || !file) {
                showToast('Please enter region name and accounts file', 'error');
                return;
            }

            try {
                const res = await fetch('/api/admin/add-region', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ region_name: name, accounts_file: file, tier: tier || 'basic' })
                });

                if (res.ok) {
                    showToast(`Region "${name}" added!`, 'success');
                    document.getElementById('new-region-name').value = '';
                    document.getElementById('new-region-file').value = '';
                    loadAdminPricing();
                    loadCreditPrices();
                } else {
                    const err = await res.text();
                    showToast('Error: ' + err, 'error');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }

        async function deleteRegion(region) {
            if (!confirm(`Are you sure you want to delete "${region}"?`)) return;

            try {
                const res = await fetch('/api/admin/delete-region', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accounts_file: region })
                });

                if (res.ok) {
                    showToast(`Region "${region}" deleted!`, 'success');
                    loadAdminPricing();
                    loadCreditPrices();
                } else {
                    const err = await res.text();
                    showToast('Error: ' + err, 'error');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }

        function editRegionPricing(accountsFile, regionName, currentCredits, currentUSD, currentEnabled) {
            // This function is kept for backward compatibility
            showToast('Use the tier dropdown to change region pricing', 'info');
        }

        async function updateRegionPricingAPI(accountsFile, regionName, creditCost, usdPrice, enabled) {
            // This function is kept for backward compatibility
            console.log('Legacy pricing API called');
        }

        // --- Admin Inbox / Broadcast Management ---
        async function loadAdminBroadcasts() {
            try {
                const res = await fetch(API.adminInboxMessages);
                if (!res.ok) return;

                const messages = await res.json();
                const container = document.getElementById('admin-broadcasts-list');
                if (!container) return;

                const typeIcons = {
                    'info': '',
                    'update': '',
                    'warning': '',
                    'success': '',
                    'promo': ''
                };

                const priorityBadges = {
                    1: '<span class="text-xs px-2 py-0.5 rounded-full bg-blue-500/20 text-blue-400">Low</span>',
                    2: '<span class="text-xs px-2 py-0.5 rounded-full bg-yellow-500/20 text-yellow-400">Normal</span>',
                    3: '<span class="text-xs px-2 py-0.5 rounded-full bg-red-500/20 text-red-400">High</span>'
                };

                let html = '';
                if (!messages || messages.length === 0) {
                    html = '<p class="text-gray-500 text-center py-8">No broadcasts sent yet</p>';
                } else {
                    for (const msg of messages) {
                        const date = new Date(msg.created_at).toLocaleString();
                        const icon = typeIcons[msg.type] || '';
                        const expiryText = msg.expires_at
                            ? `<span class="text-xs text-orange-400">Expires: ${new Date(msg.expires_at).toLocaleString()}</span>`
                            : '<span class="text-xs text-gray-500">Never expires</span>';

                        html += `
                            <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700/50">
                                <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-xl">${icon}</span>
                                            <h4 class="font-bold text-white">${msg.title}</h4>
                                            ${priorityBadges[msg.priority] || ''}
                                        </div>
                                        <p class="text-sm text-gray-300 mb-3">${msg.content}</p>
                                        <div class="flex flex-wrap items-center gap-3 text-xs text-gray-500">
                                            <span> ${date}</span>
                                            <span> ${msg.created_by}</span>
                                            ${expiryText}
                                            <span>${msg.target_all ? ' All Users' : ' Selected Users'}</span>
                                        </div>
                                    </div>
                                    <button onclick="deleteBroadcast('${msg.id}')" class="ng-btn-outline text-xs py-2 px-3 text-red-400 border-red-400/30 hover:bg-red-500/10">
                                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                        Delete
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                }

                container.innerHTML = html;
            } catch (e) {
                console.error('Failed to load admin broadcasts:', e);
            }
        }

        async function sendBroadcast() {
            const title = document.getElementById('broadcast-title').value.trim();
            const content = document.getElementById('broadcast-content').value.trim();
            const type = document.getElementById('broadcast-type').value;
            const priority = parseInt(document.getElementById('broadcast-priority').value);
            const expiresIn = parseInt(document.getElementById('broadcast-expires').value) || 0;

            if (!title || !content) {
                showToast('Title and content are required', 'error');
                return;
            }

            try {
                const res = await fetch(API.adminInboxSend, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title,
                        content,
                        type,
                        priority,
                        target_all: true,
                        expires_in: expiresIn
                    })
                });

                if (res.ok) {
                    showToast('Broadcast sent to all users!', 'success');
                    // Clear form
                    document.getElementById('broadcast-title').value = '';
                    document.getElementById('broadcast-content').value = '';
                    document.getElementById('broadcast-type').value = 'info';
                    document.getElementById('broadcast-priority').value = '2';
                    document.getElementById('broadcast-expires').value = '0';
                    // Refresh list
                    loadAdminBroadcasts();
                } else {
                    const err = await res.text();
                    showToast('Error: ' + err, 'error');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }

        async function deleteBroadcast(messageId) {
            if (!confirm('Delete this broadcast message?')) return;

            try {
                const res = await fetch(API.adminInboxDelete, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message_id: messageId })
                });

                if (res.ok) {
                    showToast('Broadcast deleted', 'success');
                    loadAdminBroadcasts();
                } else {
                    const err = await res.text();
                    showToast('Error: ' + err, 'error');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }

        // --- User Inbox Functions ---
        async function loadUserInbox() {
            try {
                const res = await fetch(API.inboxMessages);
                if (!res.ok) return;

                const messages = await res.json() || []; // Handle null response
                const container = document.getElementById('user-inbox-messages');
                const section = document.getElementById('user-inbox-section');
                const bell = document.getElementById('inbox-bell');
                const bellBadge = document.getElementById('inbox-bell-badge');
                const unreadBadge = document.getElementById('inbox-unread-badge');
                const unreadCount = document.getElementById('inbox-unread-count');

                // Guard against non-array response
                if (!Array.isArray(messages)) {
                    console.warn('Inbox messages response was not an array');
                    return;
                }

                // Count unread messages
                const unread = messages.filter(m => !m.is_read).length;

                // Show/hide inbox section and bell based on messages
                if (messages.length > 0) {
                    if (section) section.classList.remove('hidden');
                    if (bell) bell.classList.remove('hidden');
                } else {
                    if (section) section.classList.add('hidden');
                    if (bell) bell.classList.add('hidden');
                }

                // Update bell badge
                if (bellBadge) {
                    if (unread > 0) {
                        bellBadge.classList.remove('hidden');
                        bellBadge.textContent = unread > 9 ? '9+' : unread;
                    } else {
                        bellBadge.classList.add('hidden');
                    }
                }

                // Update section badge
                if (unreadBadge && unreadCount) {
                    if (unread > 0) {
                        unreadBadge.classList.remove('hidden');
                        unreadCount.textContent = unread;
                    } else {
                        unreadBadge.classList.add('hidden');
                    }
                }

                // Render messages
                if (!container) return;

                const typeStyles = {
                    'info': 'border-blue-500/30 bg-blue-500/10',
                    'update': 'border-cyan-500/30 bg-cyan-500/10',
                    'warning': 'border-orange-500/30 bg-orange-500/10',
                    'success': 'border-green-500/30 bg-green-500/10',
                    'promo': 'border-pink-500/30 bg-pink-500/10'
                };

                const typeIcons = {
                    'info': '<svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
                    'update': '<svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>',
                    'warning': '<svg class="w-5 h-5 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>',
                    'success': '<svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
                    'promo': '<svg class="w-5 h-5 text-pink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path></svg>'
                };

                let html = '';
                if (messages.length === 0) {
                    html = '<p class="text-gray-500 text-center py-4">No messages</p>';
                } else {
                    for (const msg of messages) {
                        const date = new Date(msg.created_at).toLocaleString();
                        const style = typeStyles[msg.type] || typeStyles['info'];
                        const icon = typeIcons[msg.type] || typeIcons['info'];
                        const readClass = msg.is_read ? 'opacity-70' : '';
                        const newBadge = !msg.is_read ? '<span class="text-xs px-2 py-0.5 rounded-full bg-pink-500/20 text-pink-400 font-bold">NEW</span>' : '';

                        html += `
                            <div class="p-4 rounded-xl border ${style} ${readClass} transition-opacity" data-message-id="${msg.id}">
                                <div class="flex items-start gap-3">
                                    <div class="flex-shrink-0 mt-0.5">${icon}</div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <h4 class="font-bold text-white">${msg.title}</h4>
                                            ${newBadge}
                                        </div>
                                        <p class="text-sm text-gray-300 mb-2 whitespace-pre-wrap">${msg.content}</p>
                                        <div class="flex items-center justify-between gap-3">
                                            <span class="text-xs text-gray-500">${date}</span>
                                            <div class="flex items-center gap-2">
                                                ${!msg.is_read ? `<button onclick="markInboxRead('${msg.id}')" class="text-xs text-blue-400 hover:text-blue-300">Mark Read</button>` : ''}
                                                <button onclick="dismissInboxMessage('${msg.id}')" class="text-xs text-red-400 hover:text-red-300">Dismiss</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }

                container.innerHTML = html;
            } catch (e) {
                console.error('Failed to load user inbox:', e);
            }
        }

        async function markInboxRead(messageId) {
            try {
                await fetch(API.inboxMarkRead, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message_id: messageId })
                });
                loadUserInbox();
            } catch (e) {
                console.error('Failed to mark read:', e);
            }
        }

        async function markAllInboxRead() {
            try {
                await fetch(API.inboxMarkAllRead, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                showToast('All messages marked as read', 'success');
                loadUserInbox();
            } catch (e) {
                console.error('Failed to mark all read:', e);
            }
        }

        async function dismissInboxMessage(messageId) {
            try {
                await fetch(API.inboxDismiss, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message_id: messageId })
                });
                loadUserInbox();
            } catch (e) {
                console.error('Failed to dismiss message:', e);
            }
        }

        function toggleInboxSection() {
            const section = document.getElementById('user-inbox-section');
            if (section && !section.classList.contains('hidden')) {
                toggleSection('user-inbox');
                // Mark visible messages as read
                markAllInboxRead();
            } else if (section) {
                toggleSection('user-inbox');
            }
        }

        async function loadUsersList() {
            try {
                const res = await fetch(`${API.adminUsers}?limit=100`);
                const data = await res.json();

                // Handle new response format {users, count, total_count, has_more}
                allUsersData = data.users || data;
                totalUsersCount = data.total_count || allUsersData.length;

                // Update user count badges
                updateUserCounts();

                // Apply current filter/sort
                filterAndSortUsers();
            } catch (e) {
                console.error('Failed to load users list:', e);
            }
        }

        // Copy to clipboard helper
        function copyToClipboard(text) {
            if (!text) return;
            navigator.clipboard.writeText(text);
            showToast('Password copied to clipboard', 'success');
        }

        // Legacy adjustCredits - now routes to basic credits for backward compatibility
        function adjustCredits(username, currentVal, delta) {
            adjustBasicCredits(username, currentVal, delta);
        }

        // Adjust max groups with +/- buttons
        function adjustMaxGroups(username, currentVal, delta) {
            const newVal = Math.max(0, currentVal + delta);
            const input = document.getElementById(`maxgroups-${username}`);
            if (input) {
                input.value = newVal;
                input.classList.add('credits-pulse');
                setTimeout(() => input.classList.remove('credits-pulse'), 500);
            }
            updateUserField(username, 'update_max_groups', newVal);
        }

        // Update user field with toast feedback
        async function updateUserField(username, action, value) {
            try {
                await fetch(API.adminUserAction, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, action, value: parseInt(value), string_val: '' })
                });
                showToast(`Updated ${username} successfully`, 'success');
                // Highlight the row
                const row = document.querySelector(`tr[data-username="${username}"]`);
                if (row) {
                    row.classList.add('row-highlight');
                    setTimeout(() => row.classList.remove('row-highlight'), 1500);
                }
            } catch (e) {
                showToast('Failed to update user', 'error');
            }
        }

        async function updateUser(username, action, value, stringVal = '') {
            await fetch(API.adminUserAction, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, action, value: parseInt(value), string_val: stringVal })
            });
            loadUsersList();
        }

        // Reset password with modal-style prompt
        function openResetPasswordModal(username) {
            const newPass = prompt(`Enter new password for ${username}:`);
            if (newPass && newPass.trim()) {
                updateUser(username, 'update_password', 0, newPass.trim());
                showToast(`Password reset for ${username}`, 'success');
            }
        }

        async function resetUserPassword(username) {
            openResetPasswordModal(username);
        }

        // Delete user confirmation modal
        function confirmDeleteUser(username, role) {
            pendingDeleteUser = username;
            document.getElementById('delete-user-avatar').textContent = username.charAt(0).toUpperCase();
            document.getElementById('delete-user-name').textContent = username;
            document.getElementById('delete-user-role').textContent = role === 'admin' ? ' Administrator' : ' User';
            document.getElementById('delete-user-modal').classList.remove('hidden');
        }

        function closeDeleteUserModal() {
            document.getElementById('delete-user-modal').classList.add('hidden');
            pendingDeleteUser = null;
        }

        // --- Invitation Codes ---
        async function loadInvitations() {
            try {
                const res = await fetch(API.adminInvitations);
                if (!res.ok) return;

                const data = await res.json();
                const tbody = document.getElementById('invites-table-body');
                const badge = document.getElementById('invites-count-badge');

                badge.textContent = `${data.unused_count} unused`;

                // Update tab badge
                const tabBadge = document.getElementById('admin-tab-invitations-badge');
                if (tabBadge) {
                    tabBadge.textContent = data.unused_count;
                }

                if (!data.invitations || data.invitations.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="p-8 text-center text-gray-500">
                                <div class="flex flex-col items-center gap-2">
                                    <svg class="w-12 h-12 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                                    </svg>
                                    <p>No invitation codes yet</p>
                                    <p class="text-xs">Generate codes to invite new users</p>
                                </div>
                            </td>
                        </tr>`;
                    return;
                }

                tbody.innerHTML = data.invitations.map(inv => {
                    const createdDate = new Date(inv.created_at).toLocaleDateString();
                    const usedDate = inv.used_at ? new Date(inv.used_at).toLocaleDateString() : '';
                    const statusBadge = inv.is_used
                        ? `<span class="ng-badge-default">Used</span>`
                        : `<span class="ng-badge-success">Active</span>`;

                    return `
                        <tr class="border-b border-[var(--ng-border)] hover:bg-white/5 transition-colors ${inv.is_used ? 'opacity-60' : ''}">
                            <td class="p-2 md:p-3 font-mono text-yellow-400 tracking-wider font-bold">${inv.code}</td>
                            <td class="p-2 md:p-3">${statusBadge}</td>
                            <td class="p-2 md:p-3 text-[var(--ng-text-muted)] text-xs">${createdDate}<br><span class="opacity-60">by ${inv.created_by}</span></td>
                            <td class="p-2 md:p-3 ${inv.used_by ? 'text-[var(--ng-pink)]' : 'text-[var(--ng-text-muted)] opacity-60'}">${inv.used_by || '-'}<br><span class="text-xs opacity-60">${usedDate}</span></td>
                            <td class="p-2 md:p-3 text-right">
                                ${!inv.is_used ? `<button onclick="copyInviteCode('${inv.code}')" class="ng-btn-outline text-xs py-1.5 px-3">Copy</button>` : ''}
                            </td>
                        </tr>`;
                }).join('');
            } catch (err) {
                console.error('Failed to load invitations:', err);
            }
        }

        async function generateInvitations() {
            const count = parseInt(document.getElementById('invite-count').value) || 1;
            const btn = document.getElementById('generate-invite-btn');

            btn.disabled = true;
            btn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> Generating...';

            try {
                const res = await fetch(API.adminGenerateInvitation, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ count })
                });

                const data = await res.json();

                if (res.ok && data.success) {
                    // Show newly generated codes
                    const display = document.getElementById('generated-codes-display');
                    const codesList = document.getElementById('new-codes-list');
                    codesList.innerHTML = data.codes.map(code => `
                        <div class="flex items-center justify-between bg-[var(--ng-bg-card)] px-3 py-2 rounded-lg border border-[var(--ng-border)]">
                            <span class="text-yellow-400 font-mono">${code}</span>
                            <button onclick="copyInviteCode('${code}')" class="ng-btn-outline text-xs py-1 px-2">Copy</button>
                        </div>
                    `).join('');
                    display.classList.remove('hidden');

                    // Reload table
                    loadInvitations();
                    showToast(data.message, 'success');
                } else {
                    showToast('Failed to generate codes', 'error');
                }
            } catch (err) {
                console.error('Failed to generate invitations:', err);
                showToast('Error generating codes', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg> Generate Codes';
            }
        }

        function copyInviteCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                showToast(`Code ${code} copied!`, 'success');
            }).catch(() => {
                // Fallback
                const input = document.createElement('input');
                input.value = code;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                showToast(`Code ${code} copied!`, 'success');
            });
        }

        // --- Cleanup Old Groups ---
        let cleanupOldGroups = [];

        async function openCleanupModal() {
            document.getElementById('cleanup-modal').classList.remove('hidden');
            document.getElementById('cleanup-loading').classList.remove('hidden');
            document.getElementById('cleanup-content').classList.add('hidden');
            document.getElementById('cleanup-result').classList.add('hidden');
            document.getElementById('cleanup-confirm-btn').disabled = true;

            try {
                const res = await fetch('/api/admin/cleanup-old-groups');
                if (!res.ok) throw new Error('Failed to fetch');

                const data = await res.json();
                cleanupOldGroups = data.old_groups || [];

                document.getElementById('cleanup-loading').classList.add('hidden');
                document.getElementById('cleanup-content').classList.remove('hidden');

                document.getElementById('cleanup-count').textContent = cleanupOldGroups.length;

                if (cleanupOldGroups.length === 0) {
                    document.getElementById('cleanup-empty').classList.remove('hidden');
                    document.getElementById('cleanup-groups-list').classList.add('hidden');
                    document.getElementById('cleanup-summary').classList.add('hidden');
                    document.getElementById('cleanup-confirm-btn').disabled = true;
                } else {
                    document.getElementById('cleanup-empty').classList.add('hidden');
                    document.getElementById('cleanup-groups-list').classList.remove('hidden');
                    document.getElementById('cleanup-summary').classList.remove('hidden');
                    document.getElementById('cleanup-confirm-btn').disabled = false;
                    document.getElementById('cleanup-btn-text').textContent = `Delete All (${cleanupOldGroups.length})`;

                    // Render groups list
                    const listEl = document.getElementById('cleanup-groups-list');
                    listEl.innerHTML = cleanupOldGroups.map(g => `
                        <div class="bg-gray-800/50 p-3 rounded-lg border border-gray-700/50 flex items-center justify-between">
                            <div>
                                <span class="font-mono text-sm text-cyan-400">${g.group_id}</span>
                                <span class="text-gray-500 mx-2"></span>
                                <span class="text-xs text-purple-400">Clan: ${g.clan_id}</span>
                            </div>
                            <div class="text-right">
                                <span class="text-xs text-red-400 font-medium">${g.age}</span>
                                <span class="text-gray-600 text-xs ml-1">(${Math.floor(g.age_hours)}h)</span>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Failed to load cleanup data:', err);
                document.getElementById('cleanup-loading').innerHTML = `
                    <p class="text-red-400">Failed to load data. Please try again.</p>
                `;
            }
        }

        function closeCleanupModal() {
            document.getElementById('cleanup-modal').classList.add('hidden');
            cleanupOldGroups = [];
        }

        async function executeCleanup() {
            if (cleanupOldGroups.length === 0) return;

            const btn = document.getElementById('cleanup-confirm-btn');
            btn.disabled = true;
            document.getElementById('cleanup-btn-text').textContent = 'Deleting...';

            try {
                const res = await fetch('/api/admin/cleanup-old-groups', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!res.ok) throw new Error('Failed to cleanup');

                const data = await res.json();

                document.getElementById('cleanup-content').classList.add('hidden');
                document.getElementById('cleanup-result').classList.remove('hidden');
                document.getElementById('cleanup-result-text').textContent = data.message;

                if (data.failed > 0) {
                    document.getElementById('cleanup-result').querySelector('div').className =
                        'bg-yellow-900/20 p-4 rounded-xl border border-yellow-700/30';
                    document.getElementById('cleanup-result-text').className = 'text-yellow-400 font-semibold';
                }

                showToast(data.message, data.failed > 0 ? 'warning' : 'success');

                // Refresh admin groups list
                loadAdminGroups();

            } catch (err) {
                console.error('Cleanup failed:', err);
                showToast('Cleanup failed. Please try again.', 'error');
            } finally {
                btn.disabled = false;
                document.getElementById('cleanup-btn-text').textContent = 'Delete All';
            }
        }

        document.getElementById('confirm-delete-user-btn').addEventListener('click', async () => {
            if (!pendingDeleteUser) return;

            const btn = document.getElementById('confirm-delete-user-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loader"></span> Deleting...';

            try {
                await updateUser(pendingDeleteUser, 'delete', 0);
                showToast(`User ${pendingDeleteUser} deleted`, 'success');
                closeDeleteUserModal();
            } catch (e) {
                showToast('Failed to delete user', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg> Delete User`;
            }
        });

        // Clear form button
        document.getElementById('clear-form-btn')?.addEventListener('click', () => {
            document.getElementById('new-username').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('new-role').value = 'user';
            document.getElementById('new-credits').value = '10';
            document.getElementById('new-max-groups').value = '5';
            document.getElementById('create-form-error').classList.add('hidden');
        });

        // Refresh users button
        document.getElementById('refresh-users-btn')?.addEventListener('click', function () {
            animateRefreshButton(this);
            loadUsersList();
            showToast('Users list refreshed', 'success');
        });

        document.getElementById('create-user-btn').addEventListener('click', async () => {
            const username = document.getElementById('new-username').value.trim();
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-role').value;
            const credits = parseInt(document.getElementById('new-credits').value) || 10;
            const maxGroups = parseInt(document.getElementById('new-max-groups').value) || 5;
            const errorEl = document.getElementById('create-form-error');
            const btn = document.getElementById('create-user-btn');
            const btnText = document.getElementById('create-user-text');
            const btnIcon = document.getElementById('create-user-icon');

            // Validation
            if (!username) {
                errorEl.textContent = ' Username is required';
                errorEl.classList.remove('hidden');
                document.getElementById('new-username').classList.add('shake', 'border-red-500');
                setTimeout(() => document.getElementById('new-username').classList.remove('shake', 'border-red-500'), 500);
                return;
            }
            if (!password) {
                errorEl.textContent = ' Password is required';
                errorEl.classList.remove('hidden');
                document.getElementById('new-password').classList.add('shake', 'border-red-500');
                setTimeout(() => document.getElementById('new-password').classList.remove('shake', 'border-red-500'), 500);
                return;
            }

            // Show loading state
            btn.disabled = true;
            btnText.textContent = 'Creating...';
            btnIcon.innerHTML = '<span class="loader"></span>';
            errorEl.classList.add('hidden');

            try {
                const res = await fetch(API.adminUsers, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, role, credits, max_groups: maxGroups })
                });

                if (res.ok) {
                    showToast(' User created successfully!', 'success');
                    // Clear form
                    document.getElementById('new-username').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('new-role').value = 'user';
                    document.getElementById('new-credits').value = '10';
                    document.getElementById('new-max-groups').value = '5';
                    // Reload users list with highlight
                    await loadUsersList();
                    // Highlight new user row
                    const newRow = document.querySelector(`[data-username="${username}"]`);
                    if (newRow) {
                        newRow.classList.add('row-highlight');
                        setTimeout(() => newRow.classList.remove('row-highlight'), 2000);
                    }
                } else {
                    const err = await res.json().catch(() => ({ error: 'Failed to create user' }));
                    errorEl.textContent = ' ' + (err.error || 'Failed to create user');
                    errorEl.classList.remove('hidden');
                    showToast(' ' + (err.error || 'Failed to create user'), 'error');
                }
            } catch (e) {
                errorEl.textContent = ' Network error';
                errorEl.classList.remove('hidden');
                showToast(' Network error', 'error');
            } finally {
                // Reset button state
                btn.disabled = false;
                btnText.textContent = 'Create User';
                btnIcon.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>';
            }
        });

        async function loadAdminGroups() {
            const [groupsRes, usersRes] = await Promise.all([
                fetch(API.adminGroups),
                fetch(API.adminUsers)
            ]);
            const groups = await groupsRes.json();
            const usersData = await usersRes.json();
            // Handle new response format {users, count, total_count, has_more}
            const users = usersData.users || usersData;

            // Update tab badge
            const tabBadge = document.getElementById('admin-tab-groups-badge');
            if (tabBadge) {
                tabBadge.textContent = groups.length;
            }

            renderAdminGroupsByUser(groups, users);
            loadHistory(); // Also load history
        }
        const refreshAdminGroupsBtn = document.getElementById('refresh-admin-groups');
        if (refreshAdminGroupsBtn) {
            refreshAdminGroupsBtn.addEventListener('click', loadAdminGroups);
        }

        async function loadHistory() {
            try {
                const res = await fetch('/api/admin/history');
                if (!res.ok) return;
                const logs = await res.json();
                const tbody = document.getElementById('history-table-body');
                if (!tbody) return;

                if (!logs || logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">No history found</td></tr>';
                    return;
                }

                tbody.innerHTML = logs.map(log => {
                    const date = new Date(log.timestamp).toLocaleString();
                    let actionColor = 'text-[var(--ng-text)]';
                    if (log.action === 'start') actionColor = 'text-green-400';
                    if (log.action === 'stop') actionColor = 'text-orange-400';
                    if (log.action === 'delete') actionColor = 'text-red-400';
                    if (log.action === 'refund') actionColor = 'text-blue-400';

                    return `
                        <tr class="border-b border-[var(--ng-border)] hover:bg-white/5">
                            <td class="p-2 text-[var(--ng-text-muted)] whitespace-nowrap">${date}</td>
                            <td class="p-2 font-bold text-[var(--ng-text)]">${log.username}</td>
                            <td class="p-2 ${actionColor} uppercase font-bold">${log.action}</td>
                            <td class="p-2 text-[var(--ng-text-muted)]">${log.group_id}</td>
                            <td class="p-2 text-[var(--ng-text-muted)]">${log.clan_id || '-'}</td>
                            <td class="p-2 text-[var(--ng-text-muted)]">${log.details || ''}</td>
                        </tr>
                    `;
                }).join('');
            } catch (e) {
                console.error("Failed to load history", e);
            }
        }
        const refreshHistoryBtn = document.getElementById('refresh-history');
        if (refreshHistoryBtn) {
            refreshHistoryBtn.addEventListener('click', loadHistory);
        }

        function renderAdminGroupsByUser(groups, users) {
            const container = document.getElementById('admin-groups-list');
            container.innerHTML = '';

            if (!groups || groups.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center py-10 text-gray-500 italic">No active groups found.</div>';
                return;
            }

            // Map groups to users
            const userGroups = {};
            const orphanedGroups = [];
            const groupMap = new Map(groups.map(g => [g.group_id, g]));

            users.forEach(u => {
                userGroups[u.username] = [];
                if (u.created_groups) {
                    u.created_groups.forEach(gid => {
                        if (groupMap.has(gid)) {
                            userGroups[u.username].push(groupMap.get(gid));
                            groupMap.delete(gid);
                        }
                    });
                }
            });

            // Remaining groups are orphaned
            groupMap.forEach(g => orphanedGroups.push(g));

            // Render User Sections
            let sectionIndex = 0;
            for (const [username, uGroups] of Object.entries(userGroups)) {
                if (uGroups.length > 0) {
                    sectionIndex++;
                    const sectionId = `user-group-section-${sectionIndex}`;

                    const section = document.createElement('div');
                    section.className = 'col-span-full mb-6';
                    section.innerHTML = `
                        <h3 class="ng-section-title mb-3 border-b border-[var(--ng-border)] pb-2">
                            <div class="ng-section-icon-pink">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <span class="ng-gradient-text-pink truncate">${username}</span>
                            <span class="ng-badge-default text-[11px]">${uGroups.length} groups</span>
                        </h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="${sectionId}"></div>
                    `;
                    container.appendChild(section);

                    // Render cards into this section
                    const subContainer = document.getElementById(sectionId);
                    if (subContainer) {
                        subContainer.innerHTML = uGroups.map(g => generateGroupCardHTML(g, true)).join('');
                    }

                    // Init glory updates
                    uGroups.forEach(g => {
                        if (g.status === 'running') {
                            // Manual update only
                        }
                    });
                }
            }

            // Render Orphans
            if (orphanedGroups.length > 0) {
                const section = document.createElement('div');
                section.className = 'col-span-full mb-6';
                section.innerHTML = `
                    <h3 class="ng-section-title mb-3 border-b border-[var(--ng-border)] pb-2">
                        <div class="ng-section-icon" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1)); border: 1px solid rgba(239, 68, 68, 0.3);">
                            <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                        </div>
                        <span class="text-red-400">Unassigned / Orphaned</span>
                        <span class="ng-badge-danger text-[11px]">${orphanedGroups.length} groups</span>
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="orphaned-groups-container"></div>
                `;
                container.appendChild(section);

                const subContainer = document.getElementById('orphaned-groups-container');
                if (subContainer) {
                    subContainer.innerHTML = orphanedGroups.map(g => generateGroupCardHTML(g, true)).join('');
                }

                orphanedGroups.forEach(g => {
                    if (g.status === 'running') {
                        // Manual update only
                    }
                });
            }
        }

        function generateGroupCardHTML(g, isAdmin) {
            return `
                <div class="ng-card p-4 md:p-5 rounded-xl relative overflow-hidden group-card" id="card-${g.group_id}">
                    <div class="absolute top-0 right-0 p-2 opacity-10 pointer-events-none">
                        <svg class="w-20 h-20 md:w-24 md:h-24 text-[var(--ng-pink)]" fill="currentColor" viewBox="0 0 20 20"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"></path></svg>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-2 mb-3 relative z-10">
                        <div class="min-w-0 flex-1">
                            <h3 class="font-bold text-base md:text-lg ng-gradient-text-pink tracking-tight font-mono truncate">${g.group_id}</h3>
                            <div class="flex flex-wrap items-center gap-1.5 mt-1">
                                <span class="ng-badge-default text-[11px]">Clan: ${g.clan_id}</span>
                                <span class="ng-badge-default text-[11px]">Region: ${g.region}</span>
                            </div>
                        </div>
                        <span class="${g.status === 'running' ? 'ng-badge-success' : 'ng-badge-danger'} text-[11px] uppercase tracking-wider flex items-center gap-1.5 whitespace-nowrap">
                            ${g.status === 'running' ? '<span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span></span>' : ''}
                            ${g.status}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mb-4 text-sm relative z-10">
                        <div class="bg-[var(--ng-bg-dark)] p-2 rounded-lg border border-[var(--ng-border)]">
                            <p class="text-[var(--ng-text-muted)] text-xs uppercase">Uptime</p>
                            <p class="text-[var(--ng-text)] font-mono text-sm md:text-base">${getUptime(g.created_at)}</p>
                        </div>
                        <div class="bg-[var(--ng-bg-dark)] p-2 rounded-lg border border-[var(--ng-border)] relative">
                            <p class="text-[var(--ng-text-muted)] text-xs uppercase">Total Glory</p>
                            <div class="flex items-center justify-between">
                                <p class="text-[var(--ng-purple)] font-bold font-mono text-base md:text-lg" id="glory-val-${g.group_id}">
                                    <span class="animate-pulse">...</span>
                                </p>
                                <div id="glory-diff-${g.group_id}" class="absolute top-1 right-2 text-xs font-bold opacity-0 pointer-events-none transition-all duration-1000 transform translate-y-2"></div>
                            </div>
                            <p class="text-[10px] text-[var(--ng-text-muted)] mt-1 text-right truncate" id="glory-time-${g.group_id}"></p>
                        </div>
                    </div>

                    <div id="clan-info-${g.group_id}" class="mb-4 hidden relative z-10">
                        <div class="bg-[var(--ng-bg-dark)] p-2 rounded-lg border border-[var(--ng-border)]">
                            <p class="text-[var(--ng-text-muted)] text-xs uppercase mb-1 flex justify-between items-center">
                                <span>Clan Info Response</span>
                                <span class="text-[10px] opacity-50">Raw Hex</span>
                            </p>
                            <div class="relative group">
                                <pre id="clan-info-content-${g.group_id}" class="text-[10px] text-[var(--ng-text-muted)] overflow-x-auto whitespace-pre-wrap font-mono max-h-20 scrollbar-thin break-all p-1"></pre>
                                <button onclick="copyToClipboard(document.getElementById('clan-info-content-${g.group_id}').textContent)" class="absolute top-0 right-0 p-1 bg-[var(--ng-bg-card)] text-[var(--ng-text-muted)] rounded opacity-0 group-hover:opacity-100 transition-opacity" title="Copy">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 sm:flex sm:flex-wrap gap-2 mt-2 relative z-10">
                        ${!isAdmin ? `
                            <button onclick="groupAction('${g.group_id}', 'restart')" class="ng-btn-warning text-xs py-2 px-2 md:px-3 flex items-center justify-center gap-1">
                                <svg class="w-3 h-3 hidden sm:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                Restart
                            </button>
                            <button onclick="groupAction('${g.group_id}', 'stop')" class="ng-btn-outline text-xs py-2 px-2 md:px-3 flex items-center justify-center gap-1" style="color: #fb923c; border-color: rgba(251, 146, 60, 0.3);">
                                <svg class="w-3 h-3 hidden sm:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path></svg>
                                Stop
                            </button>
                            <button onclick="groupAction('${g.group_id}', 'get-glory')" class="ng-btn-purple text-xs py-2 px-2 md:px-3 flex items-center justify-center gap-1">
                                <svg class="w-3 h-3 hidden sm:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                <span id="glory-icon-${g.group_id}">Details</span>
                            </button>
                            <button onclick="groupAction('${g.group_id}', 'delete')" class="ng-btn-danger text-xs py-2 px-2 md:px-3 flex items-center justify-center gap-1">
                                <svg class="w-3 h-3 hidden sm:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                Delete
                            </button>
                            <button onclick="groupAction('${g.group_id}', 'refund')" class="ng-btn-outline col-span-2 sm:col-span-1 text-xs py-2 px-2 md:px-3 flex items-center justify-center gap-1" style="color: #60a5fa; border-color: rgba(96, 165, 250, 0.3);">
                                <svg class="w-3 h-3 hidden sm:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg>
                                Refund
                            </button>
                        ` : `
                            <button onclick="groupAction('${g.group_id}', 'get-glory')" class="ng-btn-purple text-xs py-2 px-2 md:px-3 flex items-center justify-center gap-1">
                                <svg class="w-3 h-3 hidden sm:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                <span id="glory-icon-${g.group_id}">Details</span>
                            </button>
                            <button onclick="fetchClanInfo('${g.group_id}', true)" class="ng-btn-purple text-xs py-2 px-2 md:px-3 flex items-center justify-center gap-1">
                                <svg class="w-3 h-3 hidden sm:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Clan Info
                            </button>
                            <button onclick="groupAction('${g.group_id}', 'stop')" class="ng-btn-outline text-xs py-2 px-2 md:px-3 flex items-center justify-center gap-1" style="color: #fb923c; border-color: rgba(251, 146, 60, 0.3);">
                                <svg class="w-3 h-3 hidden sm:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path></svg>
                                Stop
                            </button>
                            <button onclick="groupAction('${g.group_id}', 'delete')" class="ng-btn-danger text-xs py-2 px-2 md:px-3 flex items-center justify-center gap-1">
                                <svg class="w-3 h-3 hidden sm:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                Delete
                            </button>
                        `}
                    </div>
                </div>
            `;
        }

        function renderGroups(groups, containerId, isAdmin) {
            const container = document.getElementById(containerId);
            if (!groups || groups.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center py-10 text-gray-500 italic">No active groups found.</div>';
                // Show empty state if exists
                const emptyState = document.getElementById('my-groups-empty');
                if (emptyState && containerId === 'my-groups-list') {
                    emptyState.classList.remove('hidden');
                    container.classList.add('hidden');
                }
                return;
            }

            // Hide empty state, show container
            const emptyState = document.getElementById('my-groups-empty');
            if (emptyState && containerId === 'my-groups-list') {
                emptyState.classList.add('hidden');
                container.classList.remove('hidden');
            }

            // Update count badge
            const countBadge = document.getElementById('my-groups-count');
            if (countBadge && containerId === 'my-groups-list') {
                countBadge.textContent = groups.length;
                countBadge.classList.add('credits-pulse');
                setTimeout(() => countBadge.classList.remove('credits-pulse'), 600);
            }

            // Group by Clan ID for my-groups-list
            if (containerId === 'my-groups-list') {
                container.innerHTML = '';
                const clans = {};
                groups.forEach(g => {
                    if (!clans[g.clan_id]) clans[g.clan_id] = [];
                    clans[g.clan_id].push(g);
                });

                Object.entries(clans).forEach(([clanID, clanGroups]) => {
                    // Determine best group to fetch info
                    const now = new Date();
                    const EIGHT_HOURS = 8 * 60 * 60 * 1000;

                    // Sort running groups by creation time (newest first)
                    const runningGroups = clanGroups
                        .filter(g => g.status === 'running')
                        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                    let fetchGroup = runningGroups.find(g => (now - new Date(g.created_at)) < EIGHT_HOURS);

                    if (!fetchGroup && runningGroups.length > 0) {
                        fetchGroup = runningGroups[0]; // Fallback to newest running
                    }

                    if (!fetchGroup) {
                        fetchGroup = clanGroups[0]; // Fallback to any
                    }

                    const section = document.createElement('div');
                    section.className = 'col-span-full mb-8';
                    section.innerHTML = `
                        <!-- Clan Header Card (Leaderboard Style) -->
                        <div class="w-full bg-gradient-to-r from-[#2b2418] to-[#1a1612] border border-[#4a3f2b] rounded-lg p-3 flex flex-col md:flex-row items-center justify-between shadow-lg relative overflow-hidden mb-4 group">
                            <!-- Background Shine -->
                            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-[#ffd700]/5 to-transparent skew-x-12 translate-x-[-100%] group-hover:animate-shine transition-all duration-1000"></div>

                            <!-- Left: Rank & Identity -->
                            <div class="flex items-center gap-4 z-10 w-full md:w-auto">
                                <!-- Rank (Laurels) -->
                                <div class="hidden md:flex flex-col items-center justify-center w-12 shrink-0">
                                     <svg class="w-10 h-10 text-[#ffd700]" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 2l2.4 7.2h7.6l-6 4.8 2.4 7.2-6-4.8-6 4.8 2.4-7.2-6-4.8h7.6z" />
                                     </svg>
                                     <span class="text-[#ffd700] font-bold text-xs mt-1">#1</span>
                                </div>

                                <!-- Clan Icon & Name -->
                                <div class="flex items-center gap-4">
                                    <div class="w-14 h-14 rounded-lg border-2 border-[#ffd700] overflow-hidden bg-black relative shrink-0">
                                         <img src="/clan.png" class="w-full h-full object-cover">
                                         <div id="clan-level-${clanID}" class="absolute bottom-0 right-0 bg-[#ffd700] text-black text-[10px] font-bold px-1">LV.?</div>
                                    </div>
                                    <div class="flex flex-col min-w-0">
                                        <h3 id="clan-name-${clanID}" class="text-[#ffd700] font-bold text-xl tracking-wide uppercase font-['Outfit'] truncate">${clanID}</h3>
                                        <p id="clan-slogan-${clanID}" class="text-gray-400 text-xs italic truncate max-w-[200px] mb-1 hidden md:block"></p>
                                        <div class="flex items-center gap-2 text-gray-500 text-[10px] font-mono uppercase">
                                            <span>ID: ${clanID}</span>
                                            <span class="text-gray-700">|</span>
                                            <span id="clan-region-${clanID}">REGION</span>
                                            <span class="text-gray-700">|</span>
                                            <span class="text-blue-400">${clanGroups.length} Bots</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Right: Activity & Stats -->
                            <div class="flex items-center gap-6 z-10 mt-4 md:mt-0 w-full md:w-auto justify-between md:justify-end">
                                <!-- Members - Visible on Mobile too -->
                                <div class="flex flex-col items-end">
                                    <div class="flex items-center gap-1.5 text-gray-400">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path></svg>
                                        <span class="text-[10px] font-bold tracking-wider uppercase">Members</span>
                                    </div>
                                    <span id="clan-members-${clanID}" class="text-sm md:text-lg font-bold text-white font-mono">0/0</span>
                                </div>

                                <!-- Captain - Visible on Mobile too -->
                                <div class="flex flex-col items-end">
                                     <div class="flex items-center gap-1.5 text-gray-400">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                                        <span class="text-[10px] font-bold tracking-wider uppercase">Captain</span>
                                    </div>
                                    <span id="clan-captain-${clanID}" class="text-xs md:text-sm font-bold text-[#ffd700] font-mono truncate max-w-[80px] md:max-w-[100px]">-</span>
                                </div>

                                <!-- Total Glory -->
                                <div class="flex flex-col items-end">
                                    <div class="flex items-center gap-1.5 text-[#ffd700]">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M5 16L3 5L8.5 10L12 4L15.5 10L21 5L19 16H5M19 19C19 19.6 18.6 20 18 20H6C5.4 20 5 19.6 5 19V18H19V19Z" /></svg>
                                        <span class="text-[10px] font-bold tracking-wider uppercase">Total Glory</span>
                                    </div>
                                    <span id="clan-total-glory-${clanID}" class="text-xl md:text-3xl font-bold text-white font-mono tracking-tight">0</span>
                                </div>
                                
                                <!-- Menu -->
                                <div class="text-gray-500 cursor-pointer hover:text-white p-2 hidden sm:block">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 16C13.1 16 14 16.9 14 18S13.1 20 12 20 10 19.1 10 18 10.9 16 12 16M12 10C13.1 10 14 10.9 14 12S13.1 14 12 14 10 13.1 10 12 10.9 10 12 10M12 4C13.1 4 14 4.9 14 6S13.1 8 12 8 10 7.1 10 6 10.9 4 12 4Z" /></svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bots Grid -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            ${clanGroups.map((g, i) => {
                        const card = generateGroupCardHTML(g, isAdmin);
                        return card.replace('class="group-card', `class="group-card card-animate" style="animation-delay: ${i * 50}ms;`);
                    }).join('')}
                        </div>
                    `;
                    container.appendChild(section);

                    if (fetchGroup) {
                        console.log(`Fetching clan info for clan ${clanID} using group ${fetchGroup.group_id} (Status: ${fetchGroup.status}, Age: ${((now - new Date(fetchGroup.created_at)) / 3600000).toFixed(1)}h)`);
                        fetchClanSectionInfo(fetchGroup.group_id, clanID, isAdmin);
                    }

                    // Fetch total glory from ALL running bots in this clan
                    const runningBots = clanGroups.filter(g => g.status === 'running');
                    if (runningBots.length > 0) {
                        fetchTotalClanGlory(clanID, runningBots, isAdmin);
                        // Also fetch individual glory for each running bot's card
                        runningBots.forEach(g => updateCardGlory(g.group_id, isAdmin));
                    }

                    // Set non-running groups glory to '-'
                    clanGroups.filter(g => g.status !== 'running').forEach(g => {
                        const el = document.getElementById(`glory-val-${g.group_id}`);
                        if (el) el.textContent = '-';
                    });
                });
            } else {
                // Default rendering for other containers (like orphans in admin view)
                container.innerHTML = groups.map((g, i) => {
                    const card = generateGroupCardHTML(g, isAdmin);
                    return card.replace('class="group-card', `class="group-card card-animate" style="animation-delay: ${i * 50}ms;`);
                }).join('');

                // Fetch glory for running groups in non-grouped view
                groups.forEach(g => {
                    if (g.status === 'running') {
                        updateCardGlory(g.group_id, isAdmin);
                    } else {
                        const el = document.getElementById(`glory-val-${g.group_id}`);
                        if (el) el.textContent = '-';
                    }
                });
            }
        }

        // --- Two-Tier Pricing System ---
        let regionPricing = {}; // AccountsFile -> {tier, region_name, enabled, accounts_file}

        async function loadPricing() {
            try {
                const res = await fetch('/api/pricing');
                if (!res.ok) return;
                const data = await res.json();

                // Update credit prices (API returns basic_credit_usd and premium_credit_usd)
                creditPrices.basic = data.basic_credit_usd || 1.70;
                creditPrices.premium = data.premium_credit_usd || 20.00;

                // Update UI badges for Buy Credits section
                const basicBadge = document.getElementById('basic-price-badge');
                const premiumBadge = document.getElementById('premium-price-badge');
                if (basicBadge) basicBadge.textContent = creditPrices.basic.toFixed(2);
                if (premiumBadge) premiumBadge.textContent = creditPrices.premium.toFixed(2);

                // Update summary prices
                const summaryBasicPrice = document.getElementById('summary-basic-price');
                const summaryPremiumPrice = document.getElementById('summary-premium-price');
                if (summaryBasicPrice) summaryBasicPrice.textContent = creditPrices.basic.toFixed(2);
                if (summaryPremiumPrice) summaryPremiumPrice.textContent = creditPrices.premium.toFixed(2);

                // Update totals if inputs have values
                if (typeof updateBuyTotal === 'function') {
                    updateBuyTotal();
                }

                // Store Binance Pay ID for checkout
                if (data.binance_pay_id) {
                    const checkoutBinanceId = document.getElementById('checkout-binance-id');
                    if (checkoutBinanceId) {
                        checkoutBinanceId.textContent = data.binance_pay_id;
                    }
                }

                // Build lookup map from regions (API returns array, not object)
                regionPricing = {};
                if (data.regions && Array.isArray(data.regions)) {
                    for (const config of data.regions) {
                        if (config.accounts_file) {
                            regionPricing[config.accounts_file] = {
                                tier: config.tier || 'basic',
                                region_name: config.region_name,
                                enabled: config.enabled !== false,
                                accounts_file: config.accounts_file
                            };
                        }
                    }
                }

                // Update the select options
                updateRegionSelectOptions();
                // Update the price display
                updateRegionPrice();

                // Populate region tier info for Buy Credits section
                if (typeof populateRegionTierInfo === 'function') {
                    populateRegionTierInfo(data.regions || []);
                }
            } catch (e) {
                console.error('Failed to load pricing:', e);
            }
        }

        function updateRegionSelectOptions() {
            const select = document.getElementById('region-select');
            if (!select) return;

            const currentVal = select.value;
            select.innerHTML = ''; // Clear hardcoded options

            const regions = Object.values(regionPricing);

            // Sort: Premium first, then alphabetical
            regions.sort((a, b) => {
                if (a.tier === 'premium' && b.tier !== 'premium') return -1;
                if (a.tier !== 'premium' && b.tier === 'premium') return 1;
                return a.region_name.localeCompare(b.region_name);
            });

            regions.forEach(pricing => {
                if (!pricing.enabled) return;

                const option = document.createElement('option');
                option.value = pricing.accounts_file;
                option.dataset.tier = pricing.tier;

                // Complete flag mapping using accounts file
                const flagMap = {
                    'accounts_br.txt': '',      // Brazil
                    'accounts_me.txt': '',      // Middle East (Saudi Arabia)
                    'accounts_ghrab.txt': '',   // Middle East Ghrab (UAE)
                    'accounts_bd.txt': '',      // Bangladesh
                    'accounts.txt': '',         // India
                    'accounts_pk.txt': '',      // Pakistan
                    'accounts_eu.txt': '',      // Europe
                    'accounts_indo.txt': '',    // Indonesia
                    'accounts_na.txt': '',      // North America (USA)
                    'accounts_ru.txt': '',      // Russia
                    'accounts_sg.txt': '',      // Singapore
                    'accounts_th.txt': '',      // Thailand
                    'accounts_vn.txt': '',      // Vietnam
                    'accounts_ph.txt': '',      // Philippines
                    'accounts_my.txt': '',      // Malaysia
                    'accounts_jp.txt': '',      // Japan
                    'accounts_kr.txt': '',      // South Korea
                    'accounts_tw.txt': '',      // Taiwan
                    'accounts_latam.txt': '',    // Latin America
                    'accounts_africa.txt': ''    // Africa
                };
                const flag = flagMap[pricing.accounts_file] || '';

                const tierIcon = pricing.tier === 'premium' ? '' : '';
                const tierText = pricing.tier === 'premium' ? 'Premium' : 'Basic';

                option.textContent = `${flag} ${pricing.region_name} ${tierIcon} ${tierText}`;
                select.appendChild(option);
            });

            // Restore selection or select first
            if (currentVal && regionPricing[currentVal] && regionPricing[currentVal].enabled) {
                select.value = currentVal;
            } else if (select.options.length > 0) {
                select.value = select.options[0].value;
            }
        }

        function updateRegionPrice() {
            const select = document.getElementById('region-select');
            const creditCostEl = document.getElementById('region-credit-cost');
            const usdPriceEl = document.getElementById('region-usd-price');
            const launchBtnText = document.getElementById('launch-btn-text');

            if (!select) return;

            const selectedOption = select.options[select.selectedIndex];
            const tier = selectedOption.dataset.tier || 'premium';
            const isPremium = tier === 'premium';
            const price = isPremium ? creditPrices.premium : creditPrices.basic;
            const tierIcon = isPremium ? '' : '';
            const tierText = isPremium ? 'Premium' : 'Basic';

            if (creditCostEl) {
                creditCostEl.textContent = `1 ${tierText} credit`;
                creditCostEl.className = isPremium
                    ? 'font-bold text-amber-400'
                    : 'font-bold text-blue-400';
            }
            if (usdPriceEl) {
                usdPriceEl.textContent = `$${price.toFixed(2)}`;
            }
            if (launchBtnText) {
                launchBtnText.textContent = `Start Group (1 ${tierText} Credit)`;
            }

            // Check if user has enough credits
            const userBasicCredits = currentUser?.basic_credits || 0;
            const userPremiumCredits = currentUser?.premium_credits || 0;
            const hasEnoughCredits = isPremium ? userPremiumCredits >= 1 : userBasicCredits >= 1;

            const launchBtn = document.getElementById('launch-btn');
            if (launchBtn) {
                if (!hasEnoughCredits) {
                    launchBtn.disabled = true;
                    launchBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    const currentCredits = isPremium ? userPremiumCredits : userBasicCredits;
                    launchBtnText.textContent = `Insufficient ${tierText} Credits (Need 1, Have ${currentCredits})`;
                } else {
                    launchBtn.disabled = false;
                    launchBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        }

        // --- User Logic ---
        async function loadUserData() {
            await loadPricing(); // Load pricing first
            loadMyGroups();
            loadTransactionHistory();
            loadGroupHistory();
            loadMyCoupons(); // Load user's coupons
            loadUserInbox(); // Load inbox messages
            requestNotificationPermission();
            startTransactionPolling();
            // Poll inbox every 30 seconds for new messages
            setInterval(loadUserInbox, 30000);
        }

        // Refresh user credits from server
        async function refreshUserCredits() {
            try {
                const res = await fetch(API.me);
                if (res.ok) {
                    const userData = await res.json();
                    currentUser.basic_credits = userData.basic_credits || 0;
                    currentUser.premium_credits = userData.premium_credits || 0;
                    document.getElementById('basic-credits-val').textContent = currentUser.basic_credits;
                    document.getElementById('premium-credits-val').textContent = currentUser.premium_credits;
                }
            } catch (e) {
                console.error('Failed to refresh user credits:', e);
            }
        }

        // --- Notification System with Service Worker ---
        let notificationPermission = 'default';
        let lastKnownTransactions = {};
        let pollingInterval = null;

        // Register Service Worker for background push notifications
        async function registerServiceWorker() {
            if (!('serviceWorker' in navigator)) {
                console.log('Service Workers not supported');
                return null;
            }

            try {
                const registration = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
                console.log('Service Worker registered:', registration.scope);
                swRegistration = registration;

                // Wait for the service worker to be ready
                await navigator.serviceWorker.ready;
                console.log('Service Worker ready');

                return registration;
            } catch (error) {
                console.error('Service Worker registration failed:', error);
                return null;
            }
        }

        // Subscribe to Web Push notifications
        async function subscribeToPush() {
            if (!swRegistration) {
                console.log('No service worker registration');
                return false;
            }

            try {
                // Get VAPID public key from server
                const keyRes = await fetch(API.vapidPublicKey);
                if (!keyRes.ok) {
                    console.error('Failed to get VAPID public key');
                    return false;
                }
                const { publicKey } = await keyRes.json();

                // Convert base64 to Uint8Array
                const applicationServerKey = urlBase64ToUint8Array(publicKey);

                // Subscribe to push
                const subscription = await swRegistration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: applicationServerKey
                });

                console.log('Push subscription:', subscription);

                // Send subscription to server
                const res = await fetch(API.pushSubscribe, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(subscription.toJSON())
                });

                if (res.ok) {
                    console.log('Push subscription saved to server');
                    return true;
                } else {
                    console.error('Failed to save push subscription');
                    return false;
                }
            } catch (error) {
                console.error('Failed to subscribe to push:', error);
                return false;
            }
        }

        // Helper function to convert base64 to Uint8Array
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/-/g, '+')
                .replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('This browser does not support notifications');
                return;
            }

            // Register service worker first
            await registerServiceWorker();

            // Update bell status regardless of permission state
            updateNotificationBellStatus();

            if (Notification.permission === 'granted') {
                notificationPermission = 'granted';
                // Subscribe to push if not already
                await subscribeToPush();
                return;
            }

            if (Notification.permission !== 'denied') {
                // Show a prompt to ask user
                showNotificationPrompt();
            }
        }

        function showNotificationPrompt() {
            // Create notification prompt banner
            const existingPrompt = document.getElementById('notification-prompt');
            if (existingPrompt) return;

            const prompt = document.createElement('div');
            prompt.id = 'notification-prompt';
            prompt.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-gradient-to-r from-blue-600/95 to-purple-600/95 backdrop-blur-lg rounded-2xl p-4 shadow-2xl border border-blue-500/30 max-w-md mx-4 animate-slideDown';
            prompt.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-white font-bold text-sm">Enable Notifications</h3>
                        <p class="text-blue-100 text-xs mt-1">Get notified when your credit purchase is approved!</p>
                    </div>
                    <button onclick="dismissNotificationPrompt()" class="text-white/60 hover:text-white transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="flex gap-2 mt-3">
                    <button onclick="enableNotifications()" class="flex-1 bg-white text-blue-600 font-bold py-2 px-4 rounded-xl text-sm hover:bg-blue-50 transition-colors">
                        Enable
                    </button>
                    <button onclick="dismissNotificationPrompt()" class="flex-1 bg-white/20 text-white font-medium py-2 px-4 rounded-xl text-sm hover:bg-white/30 transition-colors">
                        Not Now
                    </button>
                </div>
            `;
            document.body.appendChild(prompt);
        }

        async function enableNotifications() {
            try {
                const permission = await Notification.requestPermission();
                notificationPermission = permission;
                updateNotificationBellStatus();
                if (permission === 'granted') {
                    // Subscribe to Web Push for background notifications
                    const subscribed = await subscribeToPush();

                    if (subscribed) {
                        showToast('Background notifications enabled! ', 'success');
                        // Send a test notification via service worker
                        if (swRegistration) {
                            swRegistration.showNotification('Notifications Enabled! ', {
                                body: 'You will receive notifications even when the site is closed.',
                                icon: 'https://cdn-icons-png.flaticon.com/512/3135/3135706.png',
                                badge: 'https://cdn-icons-png.flaticon.com/512/3135/3135706.png',
                                tag: 'welcome'
                            });
                        }
                    } else {
                        showToast('Notifications enabled!', 'success');
                        new Notification('Notifications Enabled! ', {
                            body: 'You will be notified when your transactions are processed.',
                            icon: 'https://cdn-icons-png.flaticon.com/512/3135/3135706.png'
                        });
                    }
                }
            } catch (e) {
                console.error('Failed to request notification permission:', e);
            }
            dismissNotificationPrompt();
        }

        function dismissNotificationPrompt() {
            const prompt = document.getElementById('notification-prompt');
            if (prompt) {
                prompt.style.animation = 'slideUp 0.3s ease forwards';
                setTimeout(() => prompt.remove(), 300);
            }
            updateNotificationBellStatus();
        }

        function updateNotificationBellStatus() {
            const bell = document.getElementById('notification-bell');
            const status = document.getElementById('notification-status');
            if (!bell || !status) return;

            bell.classList.remove('hidden');

            if (Notification.permission === 'granted') {
                status.classList.remove('bg-red-500', 'bg-yellow-500');
                status.classList.add('bg-green-500');
                bell.title = 'Notifications: Enabled (works in background)';
            } else if (Notification.permission === 'denied') {
                status.classList.remove('bg-green-500', 'bg-yellow-500');
                status.classList.add('bg-red-500');
                bell.title = 'Notifications: Blocked (enable in browser settings)';
            } else {
                status.classList.remove('bg-green-500', 'bg-red-500');
                status.classList.add('bg-yellow-500');
                bell.title = 'Notifications: Click to enable';
            }
        }

        async function toggleNotifications() {
            if (!('Notification' in window)) {
                showToast('Your browser does not support notifications', 'error');
                return;
            }

            if (Notification.permission === 'granted') {
                showToast('Notifications are enabled', 'success');
            } else if (Notification.permission === 'denied') {
                showToast('Notifications are blocked. Please enable them in your browser settings.', 'warning');
            } else {
                await enableNotifications();
            }
        }

        function sendNotification(title, body, type = 'info') {
            if (notificationPermission !== 'granted' && Notification.permission !== 'granted') return;

            try {
                const notification = new Notification(title, {
                    body: body,
                    icon: type === 'success'
                        ? 'https://cdn-icons-png.flaticon.com/512/845/845646.png'
                        : type === 'error'
                            ? 'https://cdn-icons-png.flaticon.com/512/753/753345.png'
                            : 'https://cdn-icons-png.flaticon.com/512/3135/3135706.png',
                    tag: 'transaction-' + Date.now(),
                    requireInteraction: true
                });

                notification.onclick = () => {
                    window.focus();
                    notification.close();
                    // Expand transaction history if collapsed
                    if (!sectionStates['transactions']) {
                        toggleSection('transactions');
                    }
                };
            } catch (e) {
                console.error('Failed to send notification:', e);
            }
        }

        function startTransactionPolling() {
            // Stop any existing polling
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }

            // Initialize last known transactions
            initializeTransactionState();

            // Poll every 5 seconds for faster notification delivery
            pollingInterval = setInterval(checkForNotifications, 5000);
        }

        // Check for server-side notifications (pushed by admin actions)
        async function checkForNotifications() {
            if (currentUser?.role === 'admin') return; // Admin doesn't need polling

            try {
                const res = await fetch(API.notifications);
                if (!res.ok) return;

                const notifications = await res.json();
                if (!notifications || notifications.length === 0) return;

                // Process each notification
                for (const notif of notifications) {
                    // Send browser push notification
                    sendNotification(notif.title, notif.message, notif.type);

                    // Show toast
                    showToast(notif.message, notif.type);

                    // If it's a credit approval, refresh user data
                    if (notif.type === 'success' && notif.title.includes('Credits')) {
                        // Refresh user data to get updated credits
                        const meRes = await fetch(API.me);
                        if (meRes.ok) {
                            const userData = await meRes.json();
                            currentUser.basic_credits = userData.basic_credits || 0;
                            currentUser.premium_credits = userData.premium_credits || 0;
                            document.getElementById('basic-credits-val').textContent = currentUser.basic_credits;
                            document.getElementById('premium-credits-val').textContent = currentUser.premium_credits;
                        }
                        // Refresh transaction history
                        loadTransactionHistory();
                    } else if (notif.type === 'error') {
                        // Refresh transaction history for rejections
                        loadTransactionHistory();
                    }
                }
            } catch (e) {
                console.error('Failed to check notifications:', e);
            }
        }

        async function initializeTransactionState() {
            try {
                const res = await fetch(API.transactions);
                if (!res.ok) return;

                const txs = await res.json();
                if (txs && txs.length > 0) {
                    txs.forEach(tx => {
                        lastKnownTransactions[tx.id] = tx.status;
                    });
                }
            } catch (e) {
                console.error('Failed to initialize transaction state:', e);
            }
        }

        async function checkTransactionUpdates() {
            if (currentUser?.role === 'admin') return; // Admin doesn't need polling

            try {
                const res = await fetch(API.transactions);
                if (!res.ok) return;

                const txs = await res.json();
                if (!txs || txs.length === 0) return;

                let hasChanges = false;

                txs.forEach(tx => {
                    const lastStatus = lastKnownTransactions[tx.id];

                    // Check if status changed from pending to something else
                    if (lastStatus && lastStatus === 'pending' && tx.status !== 'pending') {
                        hasChanges = true;

                        if (tx.status === 'completed' || tx.status === 'approved') {
                            const basicCredits = tx.basic_credits_granted || 0;
                            const premiumCredits = tx.premium_credits_granted || 0;
                            let creditText = [];
                            if (basicCredits > 0) creditText.push(`${basicCredits} Basic`);
                            if (premiumCredits > 0) creditText.push(`${premiumCredits} Premium`);
                            const creditsStr = creditText.join(' + ') || 'credits';

                            sendNotification(
                                ' Credits Added!',
                                `Your purchase of ${creditsStr} credits has been approved!`,
                                'success'
                            );
                            showToast(` ${creditsStr} credits added to your account!`, 'success');

                            // Update credits display
                            if (currentUser) {
                                currentUser.basic_credits = (currentUser.basic_credits || 0) + basicCredits;
                                currentUser.premium_credits = (currentUser.premium_credits || 0) + premiumCredits;
                                document.getElementById('basic-credits-val').textContent = currentUser.basic_credits;
                                document.getElementById('premium-credits-val').textContent = currentUser.premium_credits;
                            }
                        } else if (tx.status === 'failed') {
                            sendNotification(
                                ' Transaction Rejected',
                                tx.admin_note ? `Reason: ${tx.admin_note}` : 'Your credit purchase was not approved.',
                                'error'
                            );
                            showToast('Transaction was rejected', 'error');
                        }
                    }

                    // Update tracked status
                    lastKnownTransactions[tx.id] = tx.status;
                });

                // Refresh transaction history if there were changes
                if (hasChanges) {
                    loadTransactionHistory();
                }
            } catch (e) {
                console.error('Failed to check transaction updates:', e);
            }
        }

        // --- Confirmation Logic ---
        let pendingLaunchData = null;

        const regionInfo = {
            'accounts_br.txt': { name: 'Brasil', flag: '' },
            'accounts_me.txt': { name: 'Mena', flag: '' },
            'accounts_ghrab.txt': { name: 'Mena (Ghrab)', flag: '' },
            'accounts_bd.txt': { name: 'Bangladesh', flag: '' },
            'accounts.txt': { name: 'India', flag: '' }
        };

        const launchGroupForm = document.getElementById('launch-group-form');
        if (launchGroupForm) {
            launchGroupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                pendingLaunchData = Object.fromEntries(formData.entries());

                // Show confirmation modal with pricing (two-tier system)
                const region = regionInfo[pendingLaunchData.accounts_file] || { name: pendingLaunchData.accounts_file, flag: '' };
                const pricing = regionPricing[pendingLaunchData.accounts_file] || { tier: 'premium' };
                const isPremium = pricing.tier === 'premium';
                const price = isPremium ? creditPrices.premium : creditPrices.basic;
                const tierText = isPremium ? 'Premium' : 'Basic';
                const tierIcon = isPremium ? '' : '';

                document.getElementById('confirm-region').innerHTML = `${region.flag} ${pricing.region_name || region.name}`;
                document.getElementById('confirm-clan').textContent = pendingLaunchData.clan_id;
                document.getElementById('confirm-credits').textContent = `1 ${tierIcon} ${tierText} credit`;
                document.getElementById('confirm-price').textContent = `$${price.toFixed(2)}`;
                document.getElementById('confirm-modal').classList.remove('hidden');
            });
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').classList.add('hidden');
            pendingLaunchData = null;
        }

        const confirmProceedBtn = document.getElementById('confirm-proceed-btn');
        if (confirmProceedBtn) {
            confirmProceedBtn.addEventListener('click', async () => {
                if (!pendingLaunchData) return;

                const btn = document.getElementById('confirm-proceed-btn');
                const originalText = btn.textContent;
                btn.textContent = 'Launching...';
                btn.disabled = true;

                const msgEl = document.getElementById('launch-msg');
                msgEl.textContent = 'Launching...';
                msgEl.className = 'mt-2 text-sm text-yellow-400';

                try {
                    const res = await fetch(API.clientLaunch, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(pendingLaunchData)
                    });

                    if (res.ok) {
                        msgEl.textContent = 'Group launched successfully!';
                        msgEl.className = 'mt-2 text-sm text-green-400';
                        showToast(' Group launched successfully!', 'success');
                        loadMyGroups();
                        // Refresh credits with animation
                        const meRes = await fetch(API.me);
                        const me = await meRes.json();
                        currentUser = me; // Update current user

                        // Update both credit displays (two-tier system)
                        const basicCreditsEl = document.getElementById('basic-credits-val');
                        const premiumCreditsEl = document.getElementById('premium-credits-val');
                        if (basicCreditsEl) {
                            basicCreditsEl.textContent = me.basic_credits || 0;
                            basicCreditsEl.classList.add('credits-pulse');
                            setTimeout(() => basicCreditsEl.classList.remove('credits-pulse'), 600);
                        }
                        if (premiumCreditsEl) {
                            premiumCreditsEl.textContent = me.premium_credits || 0;
                            premiumCreditsEl.classList.add('credits-pulse');
                            setTimeout(() => premiumCreditsEl.classList.remove('credits-pulse'), 600);
                        }

                        updateRegionPrice(); // Update button state based on new credits
                        closeConfirmModal();
                        document.getElementById('launch-group-form').reset();
                        updateRegionPrice(); // Reset price display after form reset
                    } else {
                        // Try to parse JSON error response
                        let errMsg = '';
                        try {
                            const errData = await res.json();
                            if (errData.error) {
                                errMsg = errData.error;
                                if (errData.required && errData.available !== undefined) {
                                    errMsg += ` (Need ${errData.required} credits, have ${errData.available})`;
                                }
                                if (errData.region) {
                                    errMsg += ` for ${errData.region}`;
                                }
                            }
                        } catch {
                            errMsg = await res.text();
                        }
                        msgEl.textContent = 'Error: ' + errMsg;
                        msgEl.className = 'mt-2 text-sm text-red-400';
                        showToast(' ' + errMsg, 'error');
                        closeConfirmModal();
                    }
                } catch (e) {
                    msgEl.textContent = 'Network Error';
                    msgEl.className = 'mt-2 text-sm text-red-400';
                    closeConfirmModal();
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            });
        }

        async function loadMyGroups() {
            showGroupsLoading();
            try {
                const res = await fetch(API.clientGroups);
                const groups = await res.json();
                renderGroups(groups, 'my-groups-list', false);
                // Update last refresh time
                const lastRefreshEl = document.getElementById('last-refresh-time');
                if (lastRefreshEl) {
                    lastRefreshEl.textContent = new Date().toLocaleTimeString();
                }
                // Animate the count badge
                const countBadge = document.getElementById('my-groups-count');
                if (countBadge) {
                    countBadge.classList.add('updated');
                    setTimeout(() => countBadge.classList.remove('updated'), 400);
                }
            } catch (e) {
                console.error('Failed to load groups:', e);
                showToast('Failed to load groups', 'error');
            } finally {
                setTimeout(hideGroupsLoading, 300);
            }
        }
        const refreshMyGroupsBtn = document.getElementById('refresh-my-groups');
        if (refreshMyGroupsBtn) {
            refreshMyGroupsBtn.addEventListener('click', async () => {
                animateRefreshButton(refreshMyGroupsBtn);
                await loadMyGroups();
            });
        }

        // --- Shared Rendering ---
        let gloryCache = {}; // Stores last known glory: { groupID: { val: number, time: string } }

        function getUptime(createdAt) {
            if (!createdAt) return 'Unknown';
            const start = new Date(createdAt);
            const now = new Date();
            const diff = now - start;

            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) return `${days}d ${hours % 24}h`;
            if (hours > 0) return `${hours}h ${minutes % 60}m`;
            return `${minutes}m`;
        }

        async function updateCardGlory(groupID, isAdmin) {
            const el = document.getElementById(`glory-val-${groupID}`);
            const diffEl = document.getElementById(`glory-diff-${groupID}`);
            const timeEl = document.getElementById(`glory-time-${groupID}`);

            if (!el) return;

            try {
                const endpoint = isAdmin ? '/api/admin/group-action' : API.clientAction;
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ group_id: groupID, action: 'get-glory' })
                });

                if (res.ok) {
                    const data = await res.json();
                    if (data.success) {
                        const currentVal = parseInt(data.total_glory) || 0;
                        const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

                        // Check cache for diff
                        if (gloryCache[groupID]) {
                            const diff = currentVal - gloryCache[groupID].val;
                            if (diff > 0) {
                                diffEl.textContent = `+${diff}`;
                                diffEl.className = 'absolute top-1 right-2 text-xs font-bold text-green-400 transition-all duration-1000 transform -translate-y-4 opacity-0';
                                // Trigger reflow
                                void diffEl.offsetWidth;
                                diffEl.classList.remove('opacity-0', '-translate-y-4');
                                diffEl.classList.add('opacity-100', 'translate-y-0');

                                setTimeout(() => {
                                    diffEl.classList.add('opacity-0', '-translate-y-4');
                                }, 2000);
                            }
                        }

                        // Update Cache
                        gloryCache[groupID] = { val: currentVal, time: now };

                        el.textContent = currentVal;
                        el.classList.add('text-green-400', 'glory-updated');
                        el.classList.remove('text-purple-400');
                        setTimeout(() => el.classList.remove('glory-updated'), 500);

                        if (timeEl) timeEl.textContent = `Updated: ${now}`;

                    } else {
                        el.textContent = 'N/A';
                        el.classList.add('text-gray-500');
                    }
                } else {
                    el.textContent = 'Err';
                    el.classList.add('text-red-400');
                }
            } catch (e) {
                console.error('Glory fetch error:', e);
                el.textContent = 'Err';
            }
        }

        // Fetch and sum glory from ALL running bots in a clan
        async function fetchTotalClanGlory(clanID, runningBots, isAdmin) {
            const el = document.getElementById(`clan-total-glory-${clanID}`);
            if (!el) return;

            try {
                const endpoint = isAdmin ? '/api/admin/group-action' : API.clientAction;

                // Fetch glory from all running bots in parallel
                const gloryPromises = runningBots.map(bot =>
                    fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ group_id: bot.group_id, action: 'get-glory' })
                    }).then(res => res.ok ? res.json() : null).catch(() => null)
                );

                const results = await Promise.all(gloryPromises);

                // Sum up all glory values
                let totalGlory = 0;
                results.forEach(data => {
                    if (data && data.success) {
                        totalGlory += parseInt(data.total_glory) || 0;
                    }
                });

                // Update display
                el.textContent = totalGlory.toLocaleString();
                el.classList.add('text-green-400', 'glory-updated');
                setTimeout(() => el.classList.remove('glory-updated'), 500);

                console.log(`Clan ${clanID} total glory: ${totalGlory} from ${runningBots.length} bots`);
            } catch (e) {
                console.error('Total glory fetch error:', e);
                el.textContent = 'Err';
                el.classList.add('text-red-400');
            }
        }

        async function fetchClanSectionInfo(groupID, clanID, isAdmin) {

            try {
                const endpoint = isAdmin ? '/api/admin/group-action' : API.clientAction;
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ group_id: groupID, action: 'get-clan-info' })
                });

                if (res.ok) {
                    const data = await res.json();
                    if (data.success && data.decoded) {
                        const d = data.decoded;

                        // Update Clan Name
                        const nameEl = document.getElementById(`clan-name-${clanID}`);
                        if (nameEl && d.clan_name) {
                            nameEl.textContent = d.clan_name;
                        }

                        // Update Clan Level
                        const lvlEl = document.getElementById(`clan-level-${clanID}`);
                        if (lvlEl && d.clan_level) {
                            lvlEl.textContent = `LV.${d.clan_level}`;
                        }

                        // Update Region
                        const regionEl = document.getElementById(`clan-region-${clanID}`);
                        if (regionEl && d.region) {
                            regionEl.textContent = d.region;
                        }

                        // Update Slogan
                        const sloganEl = document.getElementById(`clan-slogan-${clanID}`);
                        if (sloganEl && d.slogan) {
                            sloganEl.textContent = `"${d.slogan}"`;
                        }

                        // Update Members
                        const memEl = document.getElementById(`clan-members-${clanID}`);
                        if (memEl && d.member_num !== undefined) {
                            memEl.textContent = `${d.member_num}/${d.capacity || '?'}`;
                        }

                        // Update Captain
                        const capEl = document.getElementById(`clan-captain-${clanID}`);
                        if (capEl && d.captain_id) {
                            capEl.textContent = d.captain_id;
                        }
                    }
                }
            } catch (e) {
                console.error("Failed to fetch clan info", e);
            }
        }

        async function fetchClanInfo(groupID, isAdmin) {
            const container = document.getElementById(`clan-info-${groupID}`);
            const content = document.getElementById(`clan-info-content-${groupID}`);
            if (!container || !content) return;

            try {
                const endpoint = isAdmin ? '/api/admin/group-action' : API.clientAction;
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ group_id: groupID, action: 'get-clan-info' })
                });

                if (res.ok) {
                    const data = await res.json();
                    if (data.success && data.response_hex) {
                        container.classList.remove('hidden');
                        content.textContent = data.response_hex;
                    }
                }
            } catch (e) {
                console.error("Failed to fetch clan info", e);
            }
        }


        // --- Refund Logic ---
        let pendingRefundGroupID = null;

        function openRefundModal(groupID) {
            pendingRefundGroupID = groupID;
            document.getElementById('refund-step-info').classList.remove('hidden');
            document.getElementById('refund-step-result').classList.add('hidden');
            document.getElementById('refund-modal').classList.remove('hidden');
        }

        function closeRefundModal() {
            document.getElementById('refund-modal').classList.add('hidden');
            pendingRefundGroupID = null;
        }

        // Safely attach refund button handler
        const refundCheckBtn = document.getElementById('refund-check-btn');
        if (refundCheckBtn) {
            refundCheckBtn.addEventListener('click', async () => {
                if (!pendingRefundGroupID) return;

                const btn = document.getElementById('refund-check-btn');
                const originalText = btn.textContent;
                btn.textContent = 'Checking...';
                btn.disabled = true;

                try {
                    const endpoint = currentUser.role === 'admin' ? '/api/admin/group-action' : API.clientAction;
                    // Capture current credits before refund (two-tier system)
                    const oldBasicCredits = currentUser.basic_credits || 0;
                    const oldPremiumCredits = currentUser.premium_credits || 0;

                    const res = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ group_id: pendingRefundGroupID, action: 'refund' })
                    });

                    const text = await res.text();
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                        data = { message: text.trim() };
                    }

                    // Show Result Step
                    document.getElementById('refund-step-info').classList.add('hidden');
                    const resultStep = document.getElementById('refund-step-result');
                    resultStep.classList.remove('hidden');

                    const icon = document.getElementById('refund-icon');
                    const title = document.getElementById('refund-title');
                    const msg = document.getElementById('refund-message');
                    const creditsBox = document.getElementById('refund-credits-change');

                    if (res.ok && data.success) {
                        icon.textContent = '';
                        icon.className = 'mx-auto mb-4 flex items-center justify-center w-16 h-16 rounded-full bg-green-900/30 text-green-400 text-3xl border border-green-500/30';
                        title.textContent = 'Refund Successful';
                        title.className = 'text-lg font-bold mb-2 text-green-400';
                        msg.textContent = data.message;
                        // showMessage('Success', data.message, 'success'); // Removed to prevent double popup

                        // Refresh credits to get new value
                        const meRes = await fetch(API.me);
                        const me = await meRes.json();
                        currentUser = me; // Update local user

                        // Update UI with new credits (two-tier system)
                        document.getElementById('basic-credits-val').textContent = me.basic_credits || 0;
                        document.getElementById('premium-credits-val').textContent = me.premium_credits || 0;

                        // Show credits change - use data from response if available, else computed values
                        creditsBox.classList.remove('hidden');
                        document.getElementById('refund-old-basic').textContent = data.old_basic ?? oldBasicCredits;
                        document.getElementById('refund-new-basic').textContent = data.new_basic ?? (me.basic_credits || 0);
                        document.getElementById('refund-old-premium').textContent = data.old_premium ?? oldPremiumCredits;
                        document.getElementById('refund-new-premium').textContent = data.new_premium ?? (me.premium_credits || 0);

                        // Highlight which credit type changed
                        const basicRow = document.getElementById('refund-old-basic').parentElement.parentElement;
                        const premiumRow = document.getElementById('refund-old-premium').parentElement.parentElement;
                        if (data.credit_type === 'basic') {
                            basicRow.classList.add('bg-green-900/20', 'rounded');
                            premiumRow.classList.remove('bg-green-900/20', 'rounded');
                        } else if (data.credit_type === 'premium') {
                            premiumRow.classList.add('bg-green-900/20', 'rounded');
                            basicRow.classList.remove('bg-green-900/20', 'rounded');
                        }

                        showToast(' Refund successful! Credits restored.', 'success');

                        loadMyGroups();
                    } else {
                        icon.textContent = '';
                        icon.className = 'mx-auto mb-4 flex items-center justify-center w-16 h-16 rounded-full bg-red-900/30 text-red-400 text-3xl border border-red-500/30';
                        title.textContent = 'Refund Failed';
                        title.className = 'text-lg font-bold mb-2 text-red-400';
                        msg.textContent = data.message || 'Unknown error';
                        // showMessage('Refund Failed', data.message || 'Unknown error', 'error'); // Removed to prevent double popup
                        creditsBox.classList.add('hidden');
                        showToast(' Refund failed: ' + (data.message || 'Unknown error'), 'error');
                    }

                } catch (e) {
                    console.error(e);
                    closeRefundModal();
                    showMessage('Error', 'Network error', 'error');
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            });
        } else {
            console.error('Refund check button not found!');
        }

        async function groupAction(groupID, action) {
            if (action === 'refund') {
                openRefundModal(groupID);
                return;
            }

            if (action !== 'get-glory' && !confirm(`Are you sure you want to ${action} group ${groupID}?`)) return;

            // Details Button Spinner
            let iconEl = null;
            let originalText = '';
            if (action === 'get-glory') {
                iconEl = document.getElementById(`glory-icon-${groupID}`);
                if (iconEl) {
                    originalText = iconEl.innerHTML;
                    iconEl.innerHTML = `<svg class="animate-spin h-3 w-3 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
                    iconEl.closest('button')?.setAttribute('disabled', 'true');
                }
            }

            const endpoint = currentUser.role === 'admin' ? '/api/admin/group-action' : API.clientAction;

            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ group_id: groupID, action })
                });

                if (res.ok) {
                    const data = await res.json();
                    if (action === 'get-glory') {
                        showGloryModal(data);
                    } else {
                        if (data.message) showMessage('Success', data.message, 'success');
                        // Show toast based on action
                        if (action === 'stop') showToast(' Group stopped successfully', 'success');
                        else if (action === 'delete') showToast(' Group deleted successfully', 'success');

                        if (currentUser.role === 'admin') loadAdminGroups();
                        else loadMyGroups();
                    }
                } else {
                    const err = await res.text();
                    showMessage('Action Failed', err, 'error');
                    showToast(' ' + err, 'error');
                }
            } catch (e) {
                console.error(e);
                showToast(' Error: ' + e.message, 'error');
            } finally {
                if (action === 'get-glory' && iconEl) {
                    iconEl.innerHTML = originalText;
                    iconEl.closest('button')?.removeAttribute('disabled');
                }
            }
        }

        function showGloryModal(data) {
            const modal = document.getElementById('glory-modal');
            const content = document.getElementById('glory-content');
            modal.classList.remove('hidden');

            if (!data.success) {
                content.innerHTML = `<p class="text-red-400">Error: ${data.message}</p>`;
                return;
            }

            let html = `
                <div class="flex justify-between items-center bg-[var(--ng-bg-card)] p-3 rounded-lg border border-[var(--ng-border)]">
                    <span class="text-[var(--ng-text-muted)]">Total Glory</span>
                    <span class="text-2xl font-bold text-[var(--ng-purple)]">${data.total_glory}</span>
                </div>
            `;

            if (data.details && data.details.length > 0) {
                html += `
                    <table class="ng-table w-full text-sm mt-4">
                        <thead>
                            <tr>
                                <th class="p-2 text-left">Account ID</th>
                                <th class="p-2 text-left">Nickname</th>
                                <th class="p-2 text-center">Level</th>
                                <th class="p-2 text-center">Likes</th>
                                <th class="p-2 text-right">Glory</th>
                                <th class="p-2 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.details.map(d => `
                                <tr class="border-b border-[var(--ng-border)]">
                                    <td class="p-2 font-mono">${d.account_id}</td>
                                    <td class="p-2 text-[var(--ng-text)]">${d.nickname || '-'}</td>
                                    <td class="p-2 text-center text-[var(--ng-text-muted)]">${d.level || '-'}</td>
                                    <td class="p-2 text-center text-[var(--ng-pink-light)]">${d.liked || '-'}</td>
                                    <td class="p-2 text-right font-bold ${d.glory > 0 ? 'text-green-400' : 'text-[var(--ng-text-muted)]'}">${d.glory}</td>
                                    <td class="p-2 text-center">
                                        <button onclick="changeNickname('${data.group_id}', '${d.account_id}', '${d.nickname || ''}')" class="ng-btn-outline text-xs py-1 px-2 border-[var(--ng-border)] hover:bg-[var(--ng-bg-elevated)]">
                                             Rename
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                html += `<p class="text-gray-500 text-center mt-4">No individual details available yet.</p>`;
            }

            content.innerHTML = html;
        }

        let renameContext = null;

        function changeNickname(groupID, accountID, currentName) {
            renameContext = { groupID, accountID, currentName };
            const input = document.getElementById('rename-input');
            input.value = currentName || '';
            document.getElementById('rename-modal').classList.remove('hidden');
            setTimeout(() => input.focus(), 100);
        }

        function closeRenameModal() {
            document.getElementById('rename-modal').classList.add('hidden');
            renameContext = null;
            document.getElementById('rename-input').value = '';
            toggleRenameLoading(false);
        }

        function toggleRenameLoading(isLoading) {
            const spinner = document.getElementById('rename-spinner');
            const submitBtn = document.getElementById('rename-submit-btn');
            const input = document.getElementById('rename-input');

            if (isLoading) {
                spinner.classList.remove('hidden');
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                input.disabled = true;
            } else {
                spinner.classList.add('hidden');
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                input.disabled = false;
            }
        }

        async function submitRename() {
            if (!renameContext) return;

            const newName = document.getElementById('rename-input').value.trim();
            if (!newName) {
                showToast('Please enter a nickname', 'error');
                return;
            }

            if (newName === renameContext.currentName) {
                closeRenameModal();
                return;
            }

            toggleRenameLoading(true);

            const endpoint = currentUser.role === 'admin' ? '/api/admin/group-action' : API.clientAction;

            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        group_id: renameContext.groupID,
                        action: 'change-nickname',
                        account_id: renameContext.accountID,
                        nickname: newName
                    })
                });

                if (res.ok) {
                    const data = await res.json();
                    if (data.success) {
                        showToast(' Nickname change request sent', 'success');
                        closeRenameModal();
                    } else {
                        showToast(' ' + (data.message || 'Failed'), 'error');
                    }
                } else {
                    const errorMsg = await res.text();
                    showToast(' ' + errorMsg, 'error');
                }

            } catch (e) {
                console.error(e);
                showToast(' Error: ' + e.message, 'error');
            } finally {
                toggleRenameLoading(false);
            }
        }

        function closeGloryModal() {
            document.getElementById('glory-modal').classList.add('hidden');
        }

        // --- Message Modal ---
        function showMessage(title, message, type = 'info') {
            const modal = document.getElementById('message-modal');
            const icon = document.getElementById('msg-icon');
            const titleEl = document.getElementById('msg-title');
            const bodyEl = document.getElementById('msg-body');

            modal.classList.remove('hidden');
            titleEl.textContent = title;
            bodyEl.textContent = message;

            if (type === 'success') {
                icon.textContent = '';
                icon.className = 'mx-auto mb-4 flex items-center justify-center w-16 h-16 rounded-full bg-green-900/30 text-green-400 text-3xl border border-green-500/30';
                titleEl.className = 'text-xl font-bold text-green-400 mb-2';
            } else if (type === 'error') {
                icon.textContent = '';
                icon.className = 'mx-auto mb-4 flex items-center justify-center w-16 h-16 rounded-full bg-red-900/30 text-red-400 text-3xl border border-red-500/30';
                titleEl.className = 'text-xl font-bold text-red-400 mb-2';
            } else {
                icon.textContent = '';
                icon.className = 'mx-auto mb-4 flex items-center justify-center w-16 h-16 rounded-full bg-blue-900/30 text-blue-400 text-3xl border border-blue-500/30';
                titleEl.className = 'text-xl font-bold text-blue-400 mb-2';
            }
        }

        function closeMessageModal() {
            document.getElementById('message-modal').classList.add('hidden');
        }

        // --- Particles Initialization ---
        function initParticles() {
            const container = document.getElementById('particles');
            if (!container) return;

            const particleCount = window.innerWidth < 768 ? 15 : 30;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.cssText = `
                    position: absolute;
                    width: ${Math.random() * 4 + 2}px;
                    height: ${Math.random() * 4 + 2}px;
                    background: rgba(59, 130, 246, ${Math.random() * 0.3 + 0.1});
                    border-radius: 50%;
                    left: ${Math.random() * 100}%;
                    top: ${Math.random() * 100}%;
                    animation: particleFloat ${Math.random() * 10 + 10}s linear infinite;
                    animation-delay: -${Math.random() * 10}s;
                `;
                container.appendChild(particle);
            }
        }

        // --- Touch Feedback ---
        document.querySelectorAll('.touch-feedback').forEach(el => {
            el.addEventListener('touchstart', () => el.classList.add('active'));
            el.addEventListener('touchend', () => el.classList.remove('active'));
        });

        // --- Buy Credits Logic ---
        let currentPaymentTxId = null;
        let currentBinancePayId = null;

        // Section collapse state (all start collapsed)
        const sectionStates = {
            'buy-credits': false,  // starts collapsed
            'transactions': false, // starts collapsed
            'history': false,      // starts collapsed
            'user-inbox': false    // starts collapsed
        };

        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const chevron = document.getElementById(sectionId + '-chevron');

            if (!content || !chevron) return;

            sectionStates[sectionId] = !sectionStates[sectionId];

            if (sectionStates[sectionId]) {
                // Expand
                content.style.maxHeight = content.scrollHeight + 'px';
                content.style.paddingTop = '';
                content.style.paddingBottom = '';
                chevron.classList.remove('rotate-180');

                // After transition, remove max-height to allow responsiveness
                setTimeout(() => {
                    if (sectionStates[sectionId]) {
                        content.style.maxHeight = 'none';
                        content.style.overflow = 'visible';
                    }
                }, 300); // Match transition duration
            } else {
                // Collapse
                // First set explicit height to enable transition from 'none'
                content.style.maxHeight = content.scrollHeight + 'px';
                content.style.overflow = 'hidden';

                // Force reflow
                void content.offsetHeight;

                // Now collapse
                content.style.maxHeight = '0';
                content.style.paddingTop = '0';
                content.style.paddingBottom = '0';
                chevron.classList.add('rotate-180');
            }
        }

        // Credit prices (loaded from API)
        let creditPrices = { basic: 1.70, premium: 20.00 };

        // Load credit prices from API
        async function loadCreditPrices() {
            try {
                const res = await fetch(API.pricing);
                if (res.ok) {
                    const data = await res.json();
                    creditPrices.basic = data.basic_credit_usd || 1.70;
                    creditPrices.premium = data.premium_credit_usd || 20.00;
                    // Update UI badges
                    const basicBadge = document.getElementById('basic-price-badge');
                    const premiumBadge = document.getElementById('premium-price-badge');
                    if (basicBadge) basicBadge.textContent = creditPrices.basic.toFixed(2);
                    if (premiumBadge) premiumBadge.textContent = creditPrices.premium.toFixed(2);
                    // Update summary prices
                    const summaryBasicPrice = document.getElementById('summary-basic-price');
                    const summaryPremiumPrice = document.getElementById('summary-premium-price');
                    if (summaryBasicPrice) summaryBasicPrice.textContent = creditPrices.basic.toFixed(2);
                    if (summaryPremiumPrice) summaryPremiumPrice.textContent = creditPrices.premium.toFixed(2);

                    // Populate region tier info
                    populateRegionTierInfo(data.regions || []);

                    // Populate region select dropdown
                    populateRegionSelect(data.regions || []);
                }
            } catch (e) {
                console.error('Failed to load credit prices:', e);
            }
        }

        function populateRegionSelect(regions) {
            const select = document.getElementById('region-select');
            if (!select) return;

            // Save currently selected value if any
            const currentVal = select.value;

            select.innerHTML = '';

            // Handle if regions is array or object
            const regionList = Array.isArray(regions) ? regions : Object.values(regions);

            // Sort to keep consistent order (prioritize premium, then alphabetical)
            regionList.sort((a, b) => {
                if (a.tier === 'premium' && b.tier !== 'premium') return -1;
                if (a.tier !== 'premium' && b.tier === 'premium') return 1;
                return a.region_name.localeCompare(b.region_name);
            });

            regionList.forEach(region => {
                if (!region.enabled) return; // Skip disabled regions

                const option = document.createElement('option');
                option.value = region.accounts_file;
                option.dataset.tier = region.tier; // 'basic' or 'premium'

                // Add flag based on file mapping or name guess
                let flag = '';
                const f = region.accounts_file;
                if (f.includes('br')) flag = '';
                else if (f.includes('me')) flag = '';
                else if (f.includes('ghrab')) flag = '';
                else if (f.includes('bd')) flag = '';
                else if (f === 'accounts.txt' || f.includes('in')) flag = '';
                else if (f.includes('id')) flag = '';
                else if (f.includes('ru')) flag = '';
                else if (f.includes('eu')) flag = '';

                const tierIcon = region.tier === 'premium' ? '' : '';
                const tierName = region.tier.charAt(0).toUpperCase() + region.tier.slice(1);

                option.textContent = `${flag} ${region.region_name} ${tierIcon} ${tierName}`;
                select.appendChild(option);
            });

            // Restore selection or default to first
            if (currentVal && Array.from(select.options).some(o => o.value === currentVal)) {
                select.value = currentVal;
            } else if (select.options.length > 0) {
                select.value = select.options[0].value;
            }

            // Trigger update to set price display
            if (typeof updateRegionPrice === 'function') updateRegionPrice();
        }

        function populateRegionTierInfo(regions) {
            const container = document.getElementById('region-tier-info');
            if (!container) return;

            container.innerHTML = '';

            // Handle if regions is array or object
            const regionList = Array.isArray(regions) ? regions : Object.values(regions);

            regionList.forEach(config => {
                if (!config.enabled) return;
                const isPremium = config.tier === 'premium';
                const badge = document.createElement('span');
                badge.className = isPremium
                    ? 'px-2 py-0.5 rounded bg-amber-500/20 text-amber-300 border border-amber-500/30'
                    : 'px-2 py-0.5 rounded bg-blue-500/20 text-blue-300 border border-blue-500/30';
                badge.textContent = `${isPremium ? '' : ''} ${config.region_name}`;
                container.appendChild(badge);
            });
        }

        function updateBuyTotal() {
            const basicInput = document.getElementById('buy-basic-credits-amount');
            const premiumInput = document.getElementById('buy-premium-credits-amount');
            const totalEl = document.getElementById('buy-total-amount');
            const basicSubtotalEl = document.getElementById('buy-basic-subtotal');
            const premiumSubtotalEl = document.getElementById('buy-premium-subtotal');
            const summaryBasicQty = document.getElementById('summary-basic-qty');
            const summaryPremiumQty = document.getElementById('summary-premium-qty');

            const basicCredits = parseInt(basicInput?.value) || 0;
            const premiumCredits = parseInt(premiumInput?.value) || 0;

            const basicSubtotal = basicCredits * creditPrices.basic;
            const premiumSubtotal = premiumCredits * creditPrices.premium;
            const total = basicSubtotal + premiumSubtotal;

            if (basicSubtotalEl) basicSubtotalEl.textContent = basicSubtotal.toFixed(2);
            if (premiumSubtotalEl) premiumSubtotalEl.textContent = premiumSubtotal.toFixed(2);
            if (totalEl) totalEl.textContent = total.toFixed(2);
            if (summaryBasicQty) summaryBasicQty.textContent = basicCredits;
            if (summaryPremiumQty) summaryPremiumQty.textContent = premiumCredits;
        }

        function adjustBuyCredits(type, delta) {
            const inputId = type === 'basic' ? 'buy-basic-credits-amount' : 'buy-premium-credits-amount';
            const input = document.getElementById(inputId);
            if (input) {
                let val = parseInt(input.value) || 0;
                val = Math.max(0, Math.min(type === 'basic' ? 500 : 100, val + delta));
                input.value = val;
                updateBuyTotal();
            }
        }

        function quickBuyBasic(amount) {
            const input = document.getElementById('buy-basic-credits-amount');
            if (input) {
                input.value = amount;
                updateBuyTotal();
            }
        }

        function quickBuyPremium(amount) {
            const input = document.getElementById('buy-premium-credits-amount');
            if (input) {
                input.value = amount;
                updateBuyTotal();
            }
        }

        // Buy Credits Language Translations
        const buyCreditsTranslations = {
            en: {
                basic_credits: 'Basic Credits',
                basic_desc: 'For standard regions (IND, BD, etc.)',
                num_basic: 'Number of Basic Credits',
                premium_credits: 'Premium Credits',
                premium_desc: 'For premium regions (ME, BR, etc.)',
                num_premium: 'Number of Premium Credits',
                subtotal: 'Subtotal:',
                order_summary: 'Order Summary',
                basic_credits_label: ' Basic Credits:',
                premium_credits_label: ' Premium Credits:',
                total_amount: 'Total Amount:',
                pay_via: ' Pay via Binance Pay',
                step1: 'Step 1: Send Payment',
                send_amount: 'Send the exact amount to our Binance Pay ID:',
                step2: 'Step 2: Enter Order ID',
                enter_order_id: 'After payment, enter your Binance Order ID (found in transaction history):',
                order_placeholder: 'e.g. 1234567890123456789',
                order_hint: ' Open Binance App  Transactions  Find your payment  Copy Order Number',
                submit_btn: 'Submit Payment Request',
                region_types: ' Region Credit Types:'
            },
            ar: {
                basic_credits: ' ',
                basic_desc: '  (IND, BD, )',
                num_basic: '  ',
                premium_credits: ' ',
                premium_desc: '  (ME, BR, )',
                num_premium: '  ',
                subtotal: ' :',
                order_summary: ' ',
                basic_credits_label: '  :',
                premium_credits_label: '  :',
                total_amount: ' :',
                pay_via: '   Binance Pay',
                step1: ' 1:  ',
                send_amount: '     Binance Pay  :',
                step2: ' 2:   ',
                enter_order_id: '     Binance   (   ):',
                order_placeholder: ': 1234567890123456789',
                order_hint: '   Binance          ',
                submit_btn: '  ',
                region_types: '   :'
            },
            hi: {
                basic_credits: ' ',
                basic_desc: '    (IND, BD, )',
                num_basic: '   ',
                premium_credits: ' ',
                premium_desc: '    (ME, BR, )',
                num_premium: '   ',
                subtotal: '-:',
                order_summary: ' ',
                basic_credits_label: '  :',
                premium_credits_label: '  :',
                total_amount: ' :',
                pay_via: ' Binance Pay     ',
                step1: ' 1:  ',
                send_amount: '   Binance Pay ID  :',
                step2: ' 2:  ID  ',
                enter_order_id: '  ,  Binance Order ID   (   ):',
                order_placeholder: '. 1234567890123456789',
                order_hint: ' Binance             ',
                submit_btn: '   ',
                region_types: '   :'
            },
            id: {
                basic_credits: 'Kredit Dasar',
                basic_desc: 'Untuk region standar (IND, BD, dll)',
                num_basic: 'Jumlah Kredit Dasar',
                premium_credits: 'Kredit Premium',
                premium_desc: 'Untuk region premium (ME, BR, dll)',
                num_premium: 'Jumlah Kredit Premium',
                subtotal: 'Subtotal:',
                order_summary: 'Ringkasan Pesanan',
                basic_credits_label: ' Kredit Dasar:',
                premium_credits_label: ' Kredit Premium:',
                total_amount: 'Total Jumlah:',
                pay_via: ' Bayar via Binance Pay',
                step1: 'Langkah 1: Kirim Pembayaran',
                send_amount: 'Kirim jumlah yang tepat ke Binance Pay ID kami:',
                step2: 'Langkah 2: Masukkan Order ID',
                enter_order_id: 'Setelah pembayaran, masukkan Order ID Binance Anda (ditemukan di riwayat transaksi):',
                order_placeholder: 'cth. 1234567890123456789',
                order_hint: ' Buka Aplikasi Binance  Transaksi  Temukan pembayaran Anda  Salin Nomor Order',
                submit_btn: 'Kirim Permintaan Pembayaran',
                region_types: ' Jenis Kredit Region:'
            }
        };

        let currentBuyCreditsLang = 'en';

        function setBuyCreditsLang(lang) {
            currentBuyCreditsLang = lang;
            const translations = buyCreditsTranslations[lang];
            if (!translations) return;

            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[key]) {
                    el.textContent = translations[key];
                }
            });

            // Update placeholder
            const orderInput = document.getElementById('buy-order-id');
            if (orderInput && translations['order_placeholder']) {
                orderInput.placeholder = translations['order_placeholder'];
            }

            // Update active button style
            document.querySelectorAll('.buy-lang-btn').forEach(btn => {
                btn.classList.remove('bg-blue-500/20', 'text-blue-400', 'border', 'border-blue-500/50');
                btn.classList.add('text-gray-400', 'hover:bg-white/5');
            });
            const activeBtn = document.getElementById(`lang-btn-${lang}`);
            if (activeBtn) {
                activeBtn.classList.remove('text-gray-400', 'hover:bg-white/5');
                activeBtn.classList.add('bg-blue-500/20', 'text-blue-400', 'border', 'border-blue-500/50');
            }

            // Set text direction for Arabic
            const buyCreditsContent = document.getElementById('buy-credits-content');
            if (buyCreditsContent) {
                if (lang === 'ar') {
                    buyCreditsContent.style.direction = 'rtl';
                } else {
                    buyCreditsContent.style.direction = 'ltr';
                }
            }
        }

        // Add event listeners
        document.addEventListener('DOMContentLoaded', () => {
            loadCreditPrices();
            fetchPublicContactInfo();
        });

        async function initiatePurchase() {
            const basicCredits = parseInt(document.getElementById('buy-basic-credits-amount')?.value) || 0;
            const premiumCredits = parseInt(document.getElementById('buy-premium-credits-amount')?.value) || 0;
            const orderId = document.getElementById('buy-order-id')?.value?.trim() || '';

            if (basicCredits < 0 || premiumCredits < 0) {
                showToast('Credits cannot be negative', 'error');
                return;
            }

            if (basicCredits === 0 && premiumCredits === 0) {
                showToast('Please select at least 1 credit to purchase', 'error');
                return;
            }

            // Validate Order ID is required
            if (!orderId) {
                showToast('Binance Order ID is required. Please enter your order ID from Binance transaction history.', 'error');
                document.getElementById('buy-order-id')?.focus();
                return;
            }

            if (orderId.length < 5) {
                showToast('Invalid Order ID. Order ID must be at least 5 characters.', 'error');
                document.getElementById('buy-order-id')?.focus();
                return;
            }

            const btn = document.getElementById('buy-credits-btn');
            btn.disabled = true;
            btn.innerHTML = `<span class="loader"></span> Verifying with Binance...`;

            // Show verification modal
            showVerificationModal(orderId);

            try {
                const res = await fetch(API.buyCredits, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        basic_credits: basicCredits,
                        premium_credits: premiumCredits,
                        order_id: orderId
                    })
                });

                // Close verification modal
                closeVerificationModal();

                if (res.ok) {
                    const data = await res.json();

                    // Clear the order ID field
                    document.getElementById('buy-order-id').value = '';

                    if (data.verified) {
                        // Payment was instantly verified!
                        showPaymentVerifiedModal(data);
                        showToast(' Payment verified! Credits added to your account!', 'success');
                        // Refresh user info to show new credits
                        refreshUserCredits();
                    } else {
                        // Payment pending verification
                        showPaymentPendingModal(data);
                        showToast('Payment submitted. Verification in progress...', 'info');
                    }

                    // Refresh transaction history
                    loadTransactionHistory();
                } else {
                    const err = await res.text();
                    showToast('Error: ' + err, 'error');
                }
            } catch (e) {
                closeVerificationModal();
                showToast('Network error', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Submit Payment Request`;
            }
        }

        function showVerificationModal(orderId) {
            const modal = document.createElement('div');
            modal.id = 'verification-modal';
            modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="ng-card p-8 max-w-sm w-full mx-4 text-center">
                    <div class="mb-6">
                        <div class="w-20 h-20 mx-auto relative">
                            <div class="absolute inset-0 border-4 border-yellow-500/30 rounded-full"></div>
                            <div class="absolute inset-0 border-4 border-yellow-500 rounded-full border-t-transparent animate-spin"></div>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <svg class="w-8 h-8 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold text-yellow-400 mb-2">Verifying Payment</h3>
                    <p class="text-gray-400 text-sm mb-4">Checking your Binance transaction...</p>
                    <p class="text-xs text-gray-500 font-mono bg-gray-800/50 p-2 rounded">Order ID: ${orderId}</p>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeVerificationModal() {
            const modal = document.getElementById('verification-modal');
            if (modal) modal.remove();
        }

        function showPaymentVerifiedModal(data) {
            const modal = document.createElement('div');
            modal.id = 'payment-success-modal';
            modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="ng-card p-6 max-w-md w-full mx-4 animate-modal-in">
                    <div class="text-center mb-6">
                        <div class="w-20 h-20 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-10 h-10 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-emerald-400 mb-2"> Payment Verified!</h3>
                        <p class="text-gray-300">Your credits have been added instantly!</p>
                    </div>
                    
                    <div class="space-y-3 text-sm bg-emerald-500/10 p-4 rounded-xl border border-emerald-500/30">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Order ID:</span>
                            <span class="font-mono text-yellow-400">${data.order_id || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Credits Added:</span>
                            <span class="font-bold text-emerald-400">
                                ${data.basic_credits > 0 ? data.basic_credits + ' Basic' : ''}
                                ${data.basic_credits > 0 && data.premium_credits > 0 ? ' + ' : ''}
                                ${data.premium_credits > 0 ? data.premium_credits + ' Premium' : ''}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Amount:</span>
                            <span class="font-bold text-white">$${data.amount.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <button onclick="closePaymentSuccessModal()" class="w-full mt-6 ng-btn-success py-3 font-semibold text-lg">
                        Awesome! 
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showPaymentPendingModal(data) {
            const modal = document.createElement('div');
            modal.id = 'payment-success-modal';
            modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="ng-card p-6 max-w-md w-full mx-4 animate-modal-in">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-yellow-400 mb-2">Payment Pending</h3>
                        <p class="text-gray-400 text-sm">Could not verify automatically. Admin will review shortly.</p>
                    </div>
                    
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Transaction ID:</span>
                            <span class="font-mono text-cyan-400">${data.transaction_id}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Order ID:</span>
                            <span class="font-mono text-yellow-400">${data.order_id || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Credits:</span>
                            <span class="font-bold text-white">
                                ${data.basic_credits > 0 ? data.basic_credits + ' Basic' : ''}
                                ${data.basic_credits > 0 && data.premium_credits > 0 ? ' + ' : ''}
                                ${data.premium_credits > 0 ? data.premium_credits + ' Premium' : ''}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Amount:</span>
                            <span class="font-bold text-emerald-400">$${data.amount.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Status:</span>
                            <span class="px-2 py-1 bg-yellow-500/20 text-yellow-400 rounded-full text-xs">Pending Review</span>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                        <p class="text-xs text-blue-300">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            The system will retry verification automatically, or an admin will manually approve your payment.
                        </p>
                    </div>
                    
                    <button onclick="closePaymentSuccessModal()" class="w-full mt-4 ng-btn-primary py-3 font-semibold">
                        OK, Got it
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showPaymentSuccessModal(data) {
            // Legacy function - redirect to appropriate modal based on verified status
            if (data.verified) {
                showPaymentVerifiedModal(data);
            } else {
                showPaymentPendingModal(data);
            }
        }

        function closePaymentSuccessModal() {
            const modal = document.getElementById('payment-success-modal');
            if (modal) modal.remove();
        }

        function copyCheckoutBinanceId() {
            const binanceId = document.getElementById('checkout-binance-id')?.textContent;
            if (binanceId && binanceId !== 'Loading...') {
                navigator.clipboard.writeText(binanceId).then(() => {
                    showToast('Binance Pay ID copied!', 'success');
                }).catch(() => {
                    showToast('Failed to copy', 'error');
                });
            }
        }

        async function submitPaymentWithOrderId() {
            const orderIdField = document.getElementById('payment-order-id');
            const orderId = orderIdField ? orderIdField.value.trim() : '';

            // If user provided an order ID, update the transaction
            if (orderId && currentPaymentTxId) {
                try {
                    const res = await fetch(API.updateTransactionOrderId, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            transaction_id: currentPaymentTxId,
                            order_id: orderId
                        })
                    });

                    if (res.ok) {
                        showToast('Order ID saved! Waiting for admin confirmation.', 'success');
                    }
                } catch (e) {
                    // Silently fail, the transaction is already created
                    console.error('Failed to update order ID:', e);
                }
            }

            closePaymentModal();
        }

        function copyBinancePayId() {
            const binanceId = document.getElementById('payment-binance-id').textContent;
            navigator.clipboard.writeText(binanceId);
            showToast('Binance Pay ID copied!', 'success');
        }

        function closePaymentModal() {
            document.getElementById('payment-modal').classList.add('hidden');
            currentPaymentTxId = null;
            loadTransactionHistory();
        }

        async function cancelTransaction(txId) {
            if (!confirm('Cancel this pending transaction?')) return;

            try {
                const res = await fetch(API.cancelTransaction, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ transaction_id: txId })
                });

                if (res.ok) {
                    showToast('Transaction cancelled', 'success');
                    loadTransactionHistory();
                } else {
                    const err = await res.text();
                    showToast('Error: ' + err, 'error');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }

        async function loadTransactionHistory() {
            const container = document.getElementById('transactions-list');
            if (!container) return;

            try {
                const res = await fetch(API.transactions);
                if (!res.ok) return;

                const txs = await res.json();

                // Update badge count
                const badge = document.getElementById('tx-count-badge');
                if (badge) {
                    if (txs && txs.length > 0) {
                        badge.textContent = txs.length;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }

                if (!txs || txs.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <svg class="w-12 h-12 mx-auto mb-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                            <p>No transactions yet</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = txs.map(tx => {
                    let statusClass = 'bg-gray-700 text-gray-300';
                    let statusIcon = '';

                    if (tx.status === 'completed' || tx.status === 'approved') {
                        statusClass = 'bg-green-500/20 text-green-400 border border-green-500/30';
                        statusIcon = '';
                    } else if (tx.status === 'failed') {
                        statusClass = 'bg-red-500/20 text-red-400 border border-red-500/30';
                        statusIcon = '';
                    } else if (tx.status === 'cancelled') {
                        statusClass = 'bg-gray-500/20 text-gray-400 border border-gray-500/30';
                        statusIcon = '';
                    } else if (tx.status === 'pending') {
                        statusClass = 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30 animate-pulse';
                        statusIcon = '';
                    }

                    const date = new Date(tx.created_at).toLocaleString();

                    // Build credits display for two-tier system
                    let creditsDisplay = [];
                    const basicGranted = tx.basic_credits_granted || 0;
                    const premiumGranted = tx.premium_credits_granted || 0;
                    const basicRequested = tx.basic_credits || 0;
                    const premiumRequested = tx.premium_credits || 0;

                    // Use granted if completed, otherwise requested
                    const basicShow = tx.status === 'completed' ? basicGranted : basicRequested;
                    const premiumShow = tx.status === 'completed' ? premiumGranted : premiumRequested;

                    if (basicShow > 0) creditsDisplay.push(` ${basicShow} Basic`);
                    if (premiumShow > 0) creditsDisplay.push(` ${premiumShow} Premium`);
                    const creditsStr = creditsDisplay.join(' + ') || 'Credits';
                    const totalCredits = basicShow + premiumShow;

                    // Build old/new balance display for completed/approved transactions
                    let balanceChangeHtml = '';
                    if ((tx.status === 'completed' || tx.status === 'approved') && (tx.old_basic_credits !== undefined || tx.old_premium_credits !== undefined)) {
                        const oldBasic = tx.old_basic_credits || 0;
                        const oldPremium = tx.old_premium_credits || 0;
                        const newBasic = tx.new_basic_credits || 0;
                        const newPremium = tx.new_premium_credits || 0;

                        // Only show if there was actual change (not legacy tx with no data)
                        const hasData = (newBasic > oldBasic) || (newPremium > oldPremium) || (basicGranted > 0 && newBasic > 0) || (premiumGranted > 0 && newPremium > 0);

                        if (hasData) {
                            balanceChangeHtml = `
                                <div class="mt-2 pt-2 border-t border-gray-700/50">
                                    <p class="text-[10px] text-gray-500 mb-1">Balance Change:</p>
                                    <div class="flex flex-wrap gap-2 text-[10px]">
                                        <span class="px-2 py-0.5 rounded bg-blue-900/30 text-blue-400">
                                             Basic: ${oldBasic}  ${newBasic} <span class="text-green-400">(+${basicGranted})</span>
                                        </span>
                                        <span class="px-2 py-0.5 rounded bg-amber-900/30 text-amber-400">
                                             Premium: ${oldPremium}  ${newPremium} <span class="text-green-400">(+${premiumGranted})</span>
                                        </span>
                                    </div>
                                </div>
                            `;
                        }
                    }

                    return `
                        <div class="bg-gray-800/50 rounded-xl p-3 border border-gray-700/50 hover:border-gray-600/50 transition-all">
                            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500/20 to-amber-500/20 flex items-center justify-center text-white font-bold text-sm">
                                        ${totalCredits}
                                    </div>
                                    <div>
                                        <p class="font-mono text-xs text-gray-400">${tx.id}</p>
                                        <p class="text-sm text-white">$${tx.amount.toFixed(2)} <span class="text-gray-500"></span> <span class="text-green-400">${creditsStr}</span></p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-gray-500">${date}</span>
                                    <span class="text-xs px-2 py-1 rounded-full ${statusClass}">${statusIcon} ${tx.status}</span>
                                    ${tx.status === 'pending' ? `<button onclick="cancelTransaction('${tx.id}')" class="text-xs text-red-400 hover:text-red-300 px-2 py-1 rounded bg-red-900/20 hover:bg-red-900/30 transition-colors">Cancel</button>` : ''}
                                </div>
                            </div>
                            ${tx.order_id ? `<p class="text-[10px] text-cyan-400 mt-1 font-mono">Order: ${tx.order_id}</p>` : ''}
                            ${tx.admin_note ? `<p class="text-xs text-gray-500 mt-1 italic">Note: ${tx.admin_note}</p>` : ''}
                            ${balanceChangeHtml}
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('Failed to load transactions:', e);
            }
        }

        // --- Group History ---
        async function loadGroupHistory() {
            const container = document.getElementById('history-list');
            if (!container) return;

            try {
                const res = await fetch('/api/client/group-history');
                if (!res.ok) return;

                const history = await res.json();

                // Update badge count
                const badge = document.getElementById('history-count-badge');
                if (badge) {
                    if (history && history.length > 0) {
                        badge.textContent = history.length;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }

                if (!history || history.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <svg class="w-12 h-12 mx-auto mb-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p>No group history yet</p>
                            <p class="text-xs text-gray-600 mt-1">Launch groups to see farming history</p>
                        </div>
                    `;
                    return;
                }

                // Sort by launch date (newest first)
                history.sort((a, b) => new Date(b.launched_at) - new Date(a.launched_at));

                container.innerHTML = history.map(entry => {
                    let statusClass = 'bg-gray-500/20 text-gray-400';
                    let statusIcon = '';

                    if (entry.status === 'running') {
                        statusClass = 'bg-green-500/20 text-green-400 border border-green-500/30 animate-pulse';
                        statusIcon = '';
                    } else if (entry.status === 'stopped') {
                        statusClass = 'bg-orange-500/20 text-orange-400 border border-orange-500/30';
                        statusIcon = '';
                    } else if (entry.status === 'expired') {
                        statusClass = 'bg-red-500/20 text-red-400 border border-red-500/30';
                        statusIcon = '';
                    } else if (entry.status === 'deleted') {
                        statusClass = 'bg-gray-500/20 text-gray-500 border border-gray-500/30';
                        statusIcon = '';
                    }

                    const launchDate = new Date(entry.launched_at).toLocaleString();
                    const clanName = entry.clan_data?.clan_name || entry.clan_id;
                    const clanLevel = entry.clan_data?.clan_level || '?';
                    const members = entry.clan_data ? `${entry.clan_data.member_num}/${entry.clan_data.capacity}` : '?/?';

                    // Calculate uptime
                    let uptime = '';
                    if (entry.status === 'running') {
                        const hours = ((Date.now() - new Date(entry.launched_at).getTime()) / 3600000).toFixed(1);
                        uptime = `${hours}h`;
                    } else if (entry.stopped_at) {
                        const hours = ((new Date(entry.stopped_at).getTime() - new Date(entry.launched_at).getTime()) / 3600000).toFixed(1);
                        uptime = `${hours}h`;
                    }

                    // Glory progression
                    const initialGlory = entry.glory_snapshots?.length > 0 ? entry.glory_snapshots[0].total_glory : 0;
                    const finalGlory = entry.final_glory?.total_glory || (entry.glory_snapshots?.length > 0 ? entry.glory_snapshots[entry.glory_snapshots.length - 1].total_glory : 0);
                    const gloryFarmed = entry.glory_farmed || (finalGlory > initialGlory ? finalGlory - initialGlory : 0);

                    return `
                        <div class="bg-gradient-to-r from-gray-800/70 to-gray-800/50 rounded-xl p-4 border border-gray-700/50 hover:border-amber-600/30 transition-all group">
                            <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-3">
                                <!-- Clan Info -->
                                <div class="flex items-center gap-3 flex-1 min-w-0">
                                    <div class="w-12 h-12 rounded-lg bg-amber-600/20 border border-amber-600/30 flex items-center justify-center shrink-0">
                                        <svg class="w-6 h-6 text-amber-400" fill="currentColor" viewBox="0 0 24 24"><path d="M5 16L3 5L8.5 10L12 4L15.5 10L21 5L19 16H5M19 19C19 19.6 18.6 20 18 20H6C5.4 20 5 19.6 5 19V18H19V19Z" /></svg>
                                    </div>
                                    <div class="min-w-0">
                                        <div class="flex items-center gap-2 flex-wrap">
                                            <span class="font-bold text-amber-400 truncate">${clanName}</span>
                                            <span class="text-xs px-1.5 py-0.5 bg-amber-500/20 text-amber-300 rounded border border-amber-500/30">Lv.${clanLevel}</span>
                                            <span class="text-xs px-2 py-1 rounded-full ${statusClass}">${statusIcon} ${entry.status}</span>
                                        </div>
                                        <div class="flex items-center gap-3 text-xs text-gray-500 mt-1">
                                            <span class="font-mono">ID: ${entry.clan_id}</span>
                                            <span></span>
                                            <span>${entry.region}</span>
                                            <span></span>
                                            <span>${entry.bot_count} bots</span>
                                            <span></span>
                                            <span> ${members}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Stats -->
                                <div class="flex items-center gap-4 flex-wrap">
                                    <!-- Glory Farmed -->
                                    <div class="bg-gray-900/50 rounded-lg px-3 py-2 border border-gray-700/50 text-center">
                                        <p class="text-[10px] text-gray-500 uppercase tracking-wide">Glory Farmed</p>
                                        <p class="text-lg font-bold ${gloryFarmed > 0 ? 'text-green-400' : 'text-gray-400'} font-mono">
                                            ${gloryFarmed > 0 ? '+' : ''}${gloryFarmed.toLocaleString()}
                                        </p>
                                    </div>
                                    
                                    <!-- Uptime -->
                                    <div class="bg-gray-900/50 rounded-lg px-3 py-2 border border-gray-700/50 text-center">
                                        <p class="text-[10px] text-gray-500 uppercase tracking-wide">Uptime</p>
                                        <p class="text-lg font-bold text-blue-400 font-mono">${uptime || '-'}</p>
                                    </div>
                                    
                                    <!-- Snapshots -->
                                    <div class="bg-gray-900/50 rounded-lg px-3 py-2 border border-gray-700/50 text-center">
                                        <p class="text-[10px] text-gray-500 uppercase tracking-wide">Snapshots</p>
                                        <p class="text-lg font-bold text-purple-400 font-mono">${entry.glory_snapshots?.length || 0}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Timeline -->
                            <div class="mt-3 pt-3 border-t border-gray-700/50 flex items-center justify-between text-xs text-gray-500">
                                <span> Launched: ${launchDate}</span>
                                ${entry.stopped_at ? `<span> Ended: ${new Date(entry.stopped_at).toLocaleString()}</span>` : ''}
                                <div class="flex items-center gap-3">
                                    ${entry.status === 'running' && (!entry.clan_data || !entry.clan_data.clan_name) ? `
                                        
                                    ` : ''}
                                    <button onclick="showGloryProgression('${entry.group_id}')" class="text-amber-400 hover:text-amber-300 flex items-center gap-1 transition-colors">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                        View Progression
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('Failed to load group history:', e);
            }
        }

        // Refetch clan data for a running group
        async function refetchClanData(groupID) {
            try {
                showToast('Refetching clan data...', 'info');
                const res = await fetch(`/api/client/refetch-clan-data?group_id=${groupID}`);
                const data = await res.json();

                if (data.success) {
                    showToast('Refetching... Refresh in a few seconds', 'success');
                    // Refresh history after a delay
                    setTimeout(() => loadGroupHistory(), 3000);
                } else {
                    showToast(data.message || 'Failed to refetch', 'error');
                }
            } catch (e) {
                console.error('Refetch error:', e);
                showToast('Failed to refetch clan data', 'error');
            }
        }

        // Show glory progression modal
        async function showGloryProgression(groupID) {
            try {
                const res = await fetch(`/api/client/glory-progression?group_id=${groupID}`);
                if (!res.ok) {
                    showToast('Failed to load progression', 'error');
                    return;
                }

                const data = await res.json();

                // Build modal content
                let snapshots = data.snapshots || [];
                let chartData = snapshots.map(s => ({
                    time: new Date(s.captured_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    glory: s.total_glory,
                    uptime: s.uptime_hours.toFixed(1)
                }));

                const modalContent = `
                    <div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" onclick="if(event.target === this) this.remove()">
                        <div class="bg-gray-900 rounded-2xl border border-gray-700 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                            <div class="p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-xl font-bold text-amber-400">Glory Progression</h3>
                                    <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                    </button>
                                </div>
                                
                                <!-- Clan Info -->
                                ${data.clan_data ? `
                                    <div class="bg-gray-800/50 rounded-xl p-4 mb-4 border border-gray-700/50">
                                        <div class="flex items-center gap-3">
                                            <div class="w-12 h-12 rounded-lg bg-amber-600/20 flex items-center justify-center">
                                                <svg class="w-6 h-6 text-amber-400" fill="currentColor" viewBox="0 0 24 24"><path d="M5 16L3 5L8.5 10L12 4L15.5 10L21 5L19 16H5M19 19C19 19.6 18.6 20 18 20H6C5.4 20 5 19.6 5 19V18H19V19Z" /></svg>
                                            </div>
                                            <div>
                                                <p class="font-bold text-amber-400">${data.clan_data.clan_name}</p>
                                                <p class="text-xs text-gray-500">Lv.${data.clan_data.clan_level}  ${data.clan_data.member_num}/${data.clan_data.capacity} members  ${data.clan_data.region}</p>
                                            </div>
                                        </div>
                                        ${data.clan_data.slogan ? `<p class="text-xs text-gray-400 italic mt-2">"${data.clan_data.slogan}"</p>` : ''}
                                    </div>
                                ` : ''}
                                
                                <!-- Summary -->
                                <div class="grid grid-cols-3 gap-3 mb-4">
                                    <div class="bg-gray-800/50 rounded-lg p-3 text-center border border-gray-700/50">
                                        <p class="text-xs text-gray-500 uppercase">Final Glory</p>
                                        <p class="text-2xl font-bold text-white">${data.final_glory?.total_glory?.toLocaleString() || '-'}</p>
                                    </div>
                                    <div class="bg-gray-800/50 rounded-lg p-3 text-center border border-gray-700/50">
                                        <p class="text-xs text-gray-500 uppercase">Glory Farmed</p>
                                        <p class="text-2xl font-bold text-green-400">+${data.glory_farmed?.toLocaleString() || '0'}</p>
                                    </div>
                                    <div class="bg-gray-800/50 rounded-lg p-3 text-center border border-gray-700/50">
                                        <p class="text-xs text-gray-500 uppercase">Snapshots</p>
                                        <p class="text-2xl font-bold text-purple-400">${snapshots.length}</p>
                                    </div>
                                </div>
                                
                                <!-- Snapshots Table -->
                                <div class="bg-gray-800/50 rounded-xl border border-gray-700/50 overflow-hidden">
                                    <div class="p-3 border-b border-gray-700/50">
                                        <p class="text-sm font-semibold text-gray-300">Glory Snapshots</p>
                                    </div>
                                    <div class="max-h-64 overflow-y-auto">
                                        ${snapshots.length > 0 ? `
                                            <table class="w-full text-sm">
                                                <thead class="bg-gray-900/50 text-gray-500 text-xs uppercase sticky top-0">
                                                    <tr>
                                                        <th class="px-3 py-2 text-left">Time</th>
                                                        <th class="px-3 py-2 text-right">Uptime</th>
                                                        <th class="px-3 py-2 text-right">Glory</th>
                                                        <th class="px-3 py-2 text-right">Change</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${snapshots.map((s, i) => {
                    const prev = i > 0 ? snapshots[i - 1].total_glory : s.total_glory;
                    const diff = s.total_glory - prev;
                    return `
                                                            <tr class="border-t border-gray-700/30 hover:bg-gray-700/20">
                                                                <td class="px-3 py-2 text-gray-300">${new Date(s.captured_at).toLocaleString()}</td>
                                                                <td class="px-3 py-2 text-right text-blue-400">${s.uptime_hours.toFixed(1)}h</td>
                                                                <td class="px-3 py-2 text-right text-white font-mono">${s.total_glory.toLocaleString()}</td>
                                                                <td class="px-3 py-2 text-right ${diff > 0 ? 'text-green-400' : 'text-gray-500'} font-mono">${diff > 0 ? '+' + diff.toLocaleString() : '-'}</td>
                                                            </tr>
                                                        `;
                }).join('')}
                                                </tbody>
                                            </table>
                                        ` : '<p class="p-4 text-center text-gray-500">No snapshots recorded</p>'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalContent);
            } catch (e) {
                console.error('Failed to show glory progression:', e);
                showToast('Error loading progression', 'error');
            }
        }

        // =============================================================================
        // COUPON SYSTEM
        // =============================================================================

        // Admin: Load all coupons for monitoring
        async function loadAdminCoupons() {
            const tbody = document.getElementById('admin-coupons-list');
            const emptyState = document.getElementById('admin-coupons-empty');
            if (!tbody) return;

            const filter = document.getElementById('admin-coupon-filter')?.value || 'all';

            try {
                const res = await fetch(`/api/admin/coupons?status=${filter}&limit=200`);
                if (!res.ok) return;

                const data = await res.json();
                const coupons = data.coupons || [];
                const stats = data.stats || {};

                // Update stats
                document.getElementById('coupon-stat-total').textContent = stats.total || 0;
                document.getElementById('coupon-stat-active').textContent = stats.active || 0;
                document.getElementById('coupon-stat-redeemed').textContent = stats.redeemed || 0;

                // Update tab badge
                const tabBadge = document.getElementById('admin-tab-coupons-badge');
                if (tabBadge) {
                    if (stats.active > 0) {
                        tabBadge.textContent = stats.active;
                        tabBadge.classList.remove('hidden');
                    } else {
                        tabBadge.classList.add('hidden');
                    }
                }

                if (coupons.length === 0) {
                    tbody.innerHTML = '';
                    emptyState?.classList.remove('hidden');
                    return;
                }

                emptyState?.classList.add('hidden');

                tbody.innerHTML = coupons.map(c => {
                    const isActive = c.status === 'active';
                    const statusClass = isActive
                        ? 'bg-teal-500/20 text-teal-400 border border-teal-500/30'
                        : 'bg-gray-500/20 text-gray-400 border border-gray-500/30';
                    const statusIcon = isActive ? '' : '';

                    let creditsHtml = [];
                    if (c.basic_credits > 0) creditsHtml.push(`<span class="text-blue-400"> ${c.basic_credits}</span>`);
                    if (c.premium_credits > 0) creditsHtml.push(`<span class="text-amber-400"> ${c.premium_credits}</span>`);

                    const createdDate = new Date(c.created_at).toLocaleString();
                    const usedDate = c.used_at ? new Date(c.used_at).toLocaleString() : '-';

                    return `
                        <tr class="hover:bg-white/5">
                            <td class="py-3">
                                <code class="text-xs bg-black/30 px-2 py-1 rounded font-mono ${isActive ? 'text-teal-400' : 'text-gray-500'}">${c.code}</code>
                            </td>
                            <td class="py-3">${creditsHtml.join(' + ')}</td>
                            <td class="py-3 text-gray-300">${c.created_by}</td>
                            <td class="py-3">
                                <span class="px-2 py-0.5 rounded text-xs ${statusClass}">${statusIcon} ${c.status}</span>
                            </td>
                            <td class="py-3 ${c.used_by ? 'text-purple-400' : 'text-gray-600'}">${c.used_by || '-'}</td>
                            <td class="py-3 text-gray-500 text-xs">
                                <div>Created: ${createdDate}</div>
                                ${c.used_at ? `<div class="text-purple-400">Used: ${usedDate}</div>` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (e) {
                console.error('Failed to load admin coupons:', e);
            }
        }

        // Adjust coupon credit input
        function adjustCouponCredits(type, delta) {
            const inputId = type === 'basic' ? 'coupon-basic-credits' : 'coupon-premium-credits';
            const input = document.getElementById(inputId);
            if (input) {
                let val = parseInt(input.value) || 0;
                const max = type === 'basic' ? 100 : 20;
                val = Math.max(0, Math.min(max, val + delta));
                input.value = val;
            }
        }

        // Create a coupon from user's credits
        async function createCoupon() {
            const basicCredits = parseInt(document.getElementById('coupon-basic-credits')?.value) || 0;
            const premiumCredits = parseInt(document.getElementById('coupon-premium-credits')?.value) || 0;

            if (basicCredits === 0 && premiumCredits === 0) {
                showToast('Please select at least 1 credit', 'error');
                return;
            }

            // Check against user's balance
            if (currentUser) {
                if (basicCredits > currentUser.basic_credits) {
                    showToast(`You only have ${currentUser.basic_credits} basic credits`, 'error');
                    return;
                }
                if (premiumCredits > currentUser.premium_credits) {
                    showToast(`You only have ${currentUser.premium_credits} premium credits`, 'error');
                    return;
                }
            }

            const btn = document.getElementById('create-coupon-btn');
            btn.disabled = true;
            btn.innerHTML = `<span class="loader"></span> Creating...`;

            try {
                const res = await fetch(API.createCoupon, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        basic_credits: basicCredits,
                        premium_credits: premiumCredits
                    })
                });

                const data = await res.json();

                if (res.ok && data.success) {
                    showCouponCreatedModal(data.coupon);
                    showToast(' Coupon created successfully!', 'success');
                    // Reset inputs
                    document.getElementById('coupon-basic-credits').value = 0;
                    document.getElementById('coupon-premium-credits').value = 0;
                    // Refresh data
                    loadMyCoupons();
                    refreshUserCredits();
                } else {
                    showToast(data.error || data.message || 'Failed to create coupon', 'error');
                }
            } catch (e) {
                console.error('Create coupon error:', e);
                showToast('Network error', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path></svg> Generate Coupon`;
            }
        }

        // Show coupon created modal with copy button
        function showCouponCreatedModal(coupon) {
            const creditsStr = [];
            if (coupon.basic_credits > 0) creditsStr.push(` ${coupon.basic_credits} Basic`);
            if (coupon.premium_credits > 0) creditsStr.push(` ${coupon.premium_credits} Premium`);

            const modal = document.createElement('div');
            modal.id = 'coupon-created-modal';
            modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="ng-card p-6 max-w-md w-full animate-modal-in border-teal-500/30">
                    <div class="text-center mb-6">
                        <div class="w-20 h-20 bg-teal-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-10 h-10 text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-teal-400 mb-2"> Coupon Created!</h3>
                        <p class="text-gray-400 text-sm">Share this code with anyone to gift credits</p>
                    </div>
                    
                    <div class="bg-black/40 rounded-xl p-4 mb-4 border border-teal-500/30">
                        <p class="text-xs text-gray-500 mb-2 text-center">Coupon Code</p>
                        <div class="flex items-center justify-center gap-2">
                            <code class="text-2xl font-mono font-bold text-white tracking-widest">${coupon.code}</code>
                            <button onclick="copyCouponCode('${coupon.code}')" class="p-2 rounded-lg bg-teal-600/20 hover:bg-teal-600/40 text-teal-400 transition-colors" title="Copy">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="flex justify-center gap-3 mb-4">
                        <span class="px-3 py-1 rounded-full text-sm ${coupon.basic_credits > 0 ? 'bg-blue-500/20 text-blue-400 border border-blue-500/30' : 'hidden'}">${coupon.basic_credits > 0 ? ' ' + coupon.basic_credits + ' Basic' : ''}</span>
                        <span class="px-3 py-1 rounded-full text-sm ${coupon.premium_credits > 0 ? 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30' : 'hidden'}">${coupon.premium_credits > 0 ? ' ' + coupon.premium_credits + ' Premium' : ''}</span>
                    </div>
                    
                    <button onclick="closeCouponCreatedModal()" class="w-full py-3 bg-teal-600 hover:bg-teal-500 text-white font-semibold rounded-lg transition-colors">
                        Done
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeCouponCreatedModal() {
            const modal = document.getElementById('coupon-created-modal');
            if (modal) modal.remove();
        }

        function copyCouponCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                showToast('Coupon code copied!', 'success');
            }).catch(() => {
                showToast('Failed to copy', 'error');
            });
        }

        // Redeem a coupon
        async function redeemCoupon() {
            const input = document.getElementById('redeem-coupon-input');
            const code = input?.value?.trim();

            if (!code) {
                showToast('Please enter a coupon code', 'error');
                input?.focus();
                return;
            }

            const btn = document.getElementById('redeem-coupon-btn');
            btn.disabled = true;
            btn.innerHTML = `<span class="loader"></span>`;

            try {
                const res = await fetch(API.redeemCoupon, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code })
                });

                const data = await res.json();

                if (res.ok && data.success) {
                    const creditsStr = [];
                    if (data.basic_credits > 0) creditsStr.push(`${data.basic_credits} basic`);
                    if (data.premium_credits > 0) creditsStr.push(`${data.premium_credits} premium`);
                    showToast(` Redeemed ${creditsStr.join(' + ')} credits!`, 'success');
                    input.value = '';
                    // Refresh user credits
                    refreshUserCredits();
                    loadMyCoupons();
                } else {
                    showToast(data.error || data.message || 'Invalid coupon code', 'error');
                }
            } catch (e) {
                console.error('Redeem coupon error:', e);
                showToast('Network error', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Redeem`;
            }
        }

        // Load user's coupons
        async function loadMyCoupons() {
            const container = document.getElementById('my-coupons-list');
            if (!container) return;

            try {
                const res = await fetch(API.myCoupons);
                if (!res.ok) return;

                const coupons = await res.json();

                // Update badge
                const badge = document.getElementById('coupons-count-badge');
                const activeCoupons = coupons.filter(c => c.status === 'active');
                if (badge) {
                    if (activeCoupons.length > 0) {
                        badge.textContent = activeCoupons.length;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }

                if (!coupons || coupons.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-6 text-gray-500">
                            <svg class="w-10 h-10 mx-auto mb-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path>
                            </svg>
                            <p class="text-sm">No coupons created yet</p>
                            <p class="text-xs text-gray-600 mt-1">Create a coupon to share credits with others</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = coupons.map(coupon => {
                    const isActive = coupon.status === 'active';
                    const statusClass = isActive
                        ? 'bg-teal-500/20 text-teal-400 border border-teal-500/30'
                        : 'bg-gray-500/20 text-gray-400 border border-gray-500/30';
                    const statusIcon = isActive ? '' : '';
                    const date = new Date(coupon.created_at).toLocaleString();

                    let creditsDisplay = [];
                    if (coupon.basic_credits > 0) creditsDisplay.push(` ${coupon.basic_credits}`);
                    if (coupon.premium_credits > 0) creditsDisplay.push(` ${coupon.premium_credits}`);
                    const creditsStr = creditsDisplay.join(' + ');

                    let usedByHtml = '';
                    if (!isActive && coupon.used_by) {
                        const usedDate = coupon.used_at ? new Date(coupon.used_at).toLocaleString() : '';
                        usedByHtml = `
                            <div class="mt-2 pt-2 border-t border-gray-700/50 text-xs text-gray-500">
                                Redeemed by <span class="text-cyan-400">${coupon.used_by}</span>
                                ${usedDate ? ` on ${usedDate}` : ''}
                            </div>
                        `;
                    }

                    return `
                        <div class="bg-gray-800/50 rounded-xl p-3 border ${isActive ? 'border-teal-500/30 hover:border-teal-500/50' : 'border-gray-700/30'} transition-all">
                            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-lg ${isActive ? 'bg-teal-500/20' : 'bg-gray-700/50'} flex items-center justify-center">
                                        <svg class="w-5 h-5 ${isActive ? 'text-teal-400' : 'text-gray-500'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <code class="font-mono text-sm ${isActive ? 'text-white' : 'text-gray-400'}">${coupon.code}</code>
                                            ${isActive ? `<button onclick="copyCouponCode('${coupon.code}')" class="text-teal-400 hover:text-teal-300 transition-colors" title="Copy">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                                            </button>` : ''}
                                        </div>
                                        <p class="text-xs text-gray-500">${creditsStr}  ${date}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs px-2 py-1 rounded-full ${statusClass}">${statusIcon} ${coupon.status}</span>
                                    ${isActive ? `<button onclick="cancelCoupon('${coupon.code}')" class="text-xs text-red-400 hover:text-red-300 px-2 py-1 rounded bg-red-900/20 hover:bg-red-900/30 transition-colors" title="Cancel & Refund">Cancel</button>` : ''}
                                </div>
                            </div>
                            ${usedByHtml}
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('Failed to load coupons:', e);
            }
        }

        // Cancel a coupon (refund credits)
        async function cancelCoupon(code) {
            if (!confirm('Cancel this coupon? Credits will be refunded to your account.')) return;

            try {
                const res = await fetch(API.cancelCoupon, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code })
                });

                const data = await res.json();

                if (res.ok && data.success) {
                    showToast('Coupon cancelled! Credits refunded.', 'success');
                    loadMyCoupons();
                    refreshUserCredits();
                } else {
                    showToast(data.error || data.message || 'Failed to cancel', 'error');
                }
            } catch (e) {
                console.error('Cancel coupon error:', e);
                showToast('Network error', 'error');
            }
        }

        // Init particles on load
        document.addEventListener('DOMContentLoaded', initParticles);

        // Init
        checkAuth();

    </script>
    <!-- Rename Modal -->
    <div id="rename-modal"
        class="fixed inset-0 bg-black/70 hidden flex items-center justify-center z-50 backdrop-blur-md p-4">
        <div
            class="ng-card p-5 md:p-6 max-w-sm w-full transform transition-all scale-100 modal-slide-up border-pink-500/20">
            <h3 class="ng-section-title mb-4">
                <div class="ng-section-icon ng-section-icon-pink">
                    <svg class="w-5 h-5 text-pink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z">
                        </path>
                    </svg>
                </div>
                <span class="text-pink-400">Rename Bot</span>
            </h3>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-1">New
                        Nickname</label>
                    <input type="text" id="rename-input"
                        class="w-full bg-black/30 border border-gray-700/50 rounded-lg px-4 py-2 text-white focus:border-pink-500/50 focus:ring-1 focus:ring-pink-500/50 outline-none transition-all placeholder-gray-600"
                        placeholder="Enter new nickname">
                </div>

                <!-- Spinner -->
                <div id="rename-spinner" class="hidden flex justify-center py-2">
                    <svg class="animate-spin h-6 w-6 text-pink-500" xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                </div>

                <div class="flex gap-3 pt-2">
                    <button onclick="closeRenameModal()"
                        class="flex-1 py-2.5 px-4 ng-btn-outline font-medium text-sm">Cancel</button>
                    <button onclick="submitRename()" id="rename-submit-btn"
                        class="flex-1 py-2.5 px-4 ng-btn-primary font-semibold text-sm">Save</button>
                </div>
            </div>
        </div>
    </div>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c30cd397e0cc8d1',t:'MTc2OTI3MTAzNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"9c30cd397e0cc8d1","version":"2025.9.1","r":1,"token":"85d2b33897584d589ca4aa3ab72ee837","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}}}' crossorigin="anonymous"></script>
</body>

</html>